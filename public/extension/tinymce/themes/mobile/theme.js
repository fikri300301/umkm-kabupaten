!function(){"use strict";var __assign=function(){return(__assign=Object.assign||function __assign(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t}).apply(this,arguments)};function __rest(s,e){var t={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(t[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(t[p[i]]=s[p[i]]);return t}function __spreadArray(to,from,pack){if(pack||2===arguments.length)for(var i=0,l=from.length,ar;i<l;i++)!ar&&i in from||(ar||(ar=Array.prototype.slice.call(from,0,i)),ar[i]=from[i]);return to.concat(ar||Array.prototype.slice.call(from))}var typeOf=function(x){var t=typeof x;return null===x?"null":"object"===t&&(Array.prototype.isPrototypeOf(x)||x.constructor&&"Array"===x.constructor.name)?"array":"object"===t&&(String.prototype.isPrototypeOf(x)||x.constructor&&"String"===x.constructor.name)?"string":t},isType$1=function(type){return function(value){return typeOf(value)===type}},isSimpleType=function(type){return function(value){return typeof value===type}},eq$1=function(t){return function(a){return t===a}},isString=isType$1("string"),isObject=isType$1("object"),isArray=isType$1("array"),isNull=eq$1(null),isBoolean=isSimpleType("boolean"),isUndefined=eq$1(void 0),isNullable=function(a){return null==a},isNonNullable=function(a){return!isNullable(a)},isFunction=isSimpleType("function"),isNumber=isSimpleType("number"),noop=function(){},compose=function(fa,fb){return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return fa(fb.apply(null,args))}},compose1=function(fbc,fab){return function(a){return fbc(fab(a))}},constant$1=function(value){return function(){return value}},identity=function(x){return x},tripleEquals=function(a,b){return a===b};function curry(fn){for(var initialArgs=[],_i=1;_i<arguments.length;_i++)initialArgs[_i-1]=arguments[_i];return function(){for(var restArgs=[],_i=0;_i<arguments.length;_i++)restArgs[_i]=arguments[_i];var all=initialArgs.concat(restArgs);return fn.apply(null,all)}}var not=function(f){return function(t){return!f(t)}},die=function(msg){return function(){throw new Error(msg)}},apply$1=function(f){return f()},never=constant$1(!1),always=constant$1(!0),none=function(){return NONE},NONE={fold:function(n,_s){return n()},isSome:never,isNone:always,getOr:id=identity,getOrThunk:call=function(thunk){return thunk()},getOrDie:function(msg){throw new Error(msg||"error: getOrDie called on none.")},getOrNull:constant$1(null),getOrUndefined:constant$1(void 0),or:id,orThunk:call,map:none,each:noop,bind:none,exists:never,forall:always,filter:function(){return none()},toArray:function(){return[]},toString:constant$1("none()")},call,id,me,some=function(a){var constant_a=constant$1(a),self=function(){return me},bind=function(f){return f(a)},me={fold:function(n,s){return s(a)},isSome:always,isNone:never,getOr:constant_a,getOrThunk:constant_a,getOrDie:constant_a,getOrNull:constant_a,getOrUndefined:constant_a,or:self,orThunk:self,map:function(f){return some(f(a))},each:function(f){f(a)},bind:bind,exists:bind,forall:bind,filter:function(f){return f(a)?me:NONE},toArray:function(){return[a]},toString:function(){return"some("+a+")"}};return me},from=function(value){return null==value?NONE:some(value)},Optional={some:some,none:none,from:from},cached=function(f){var called=!1,r;return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return called||(called=!0,r=f.apply(null,args)),r}},DeviceType=function(os,browser,userAgent,mediaMatch){var isiPad=os.isiOS()&&!0===/ipad/i.test(userAgent),isiPhone=os.isiOS()&&!isiPad,isMobile=os.isiOS()||os.isAndroid(),isTouch=isMobile||mediaMatch("(pointer:coarse)"),isTablet=isiPad||!isiPhone&&isMobile&&mediaMatch("(min-device-width:768px)"),isPhone=isiPhone||isMobile&&!isTablet,iOSwebview=browser.isSafari()&&os.isiOS()&&!1===/safari/i.test(userAgent),isDesktop=!isPhone&&!isTablet&&!iOSwebview;return{isiPad:constant$1(isiPad),isiPhone:constant$1(isiPhone),isTablet:constant$1(isTablet),isPhone:constant$1(isPhone),isTouch:constant$1(isTouch),isAndroid:os.isAndroid,isiOS:os.isiOS,isWebView:constant$1(iOSwebview),isDesktop:constant$1(isDesktop)}},nativeSlice=Array.prototype.slice,nativeIndexOf=Array.prototype.indexOf,nativePush=Array.prototype.push,rawIndexOf=function(ts,t){return nativeIndexOf.call(ts,t)},contains$1=function(xs,x){return rawIndexOf(xs,x)>-1},exists=function(xs,pred){for(var i=0,len=xs.length;i<len;i++){var x;if(pred(xs[i],i))return!0}return!1},map$2=function(xs,f){for(var len=xs.length,r=new Array(len),i=0;i<len;i++){var x=xs[i];r[i]=f(x,i)}return r},each$1=function(xs,f){for(var i=0,len=xs.length;i<len;i++){var x;f(xs[i],i)}},eachr=function(xs,f){for(var i=xs.length-1;i>=0;i--){var x;f(xs[i],i)}},filter$2=function(xs,pred){for(var r=[],i=0,len=xs.length;i<len;i++){var x=xs[i];pred(x,i)&&r.push(x)}return r},foldr=function(xs,f,acc){return eachr(xs,(function(x,i){acc=f(acc,x,i)})),acc},foldl=function(xs,f,acc){return each$1(xs,(function(x,i){acc=f(acc,x,i)})),acc},findUntil=function(xs,pred,until){for(var i=0,len=xs.length;i<len;i++){var x=xs[i];if(pred(x,i))return Optional.some(x);if(until(x,i))break}return Optional.none()},find$2=function(xs,pred){return findUntil(xs,pred,never)},findIndex$1=function(xs,pred){for(var i=0,len=xs.length;i<len;i++){var x;if(pred(xs[i],i))return Optional.some(i)}return Optional.none()},flatten=function(xs){for(var r=[],i=0,len=xs.length;i<len;++i){if(!isArray(xs[i]))throw new Error("Arr.flatten item "+i+" was not an array, input: "+xs);nativePush.apply(r,xs[i])}return r},bind$3=function(xs,f){return flatten(map$2(xs,f))},forall=function(xs,pred){for(var i=0,len=xs.length;i<len;++i){var x;if(!0!==pred(xs[i],i))return!1}return!0},reverse=function(xs){var r=nativeSlice.call(xs,0);return r.reverse(),r},difference=function(a1,a2){return filter$2(a1,(function(x){return!contains$1(a2,x)}))},pure$2=function(x){return[x]},sort=function(xs,comparator){var copy=nativeSlice.call(xs,0);return copy.sort(comparator),copy},get$d=function(xs,i){return i>=0&&i<xs.length?Optional.some(xs[i]):Optional.none()},head=function(xs){return get$d(xs,0)},findMap=function(arr,f){for(var i=0;i<arr.length;i++){var r=f(arr[i],i);if(r.isSome())return r}return Optional.none()},firstMatch=function(regexes,s){for(var i=0;i<regexes.length;i++){var x=regexes[i];if(x.test(s))return x}},find$1=function(regexes,agent){var r=firstMatch(regexes,agent);if(!r)return{major:0,minor:0};var group=function(i){return Number(agent.replace(r,"$"+i))};return nu$8(group(1),group(2))},detect$4=function(versionRegexes,agent){var cleanedAgent=String(agent).toLowerCase();return 0===versionRegexes.length?unknown$3():find$1(versionRegexes,cleanedAgent)},unknown$3=function(){return nu$8(0,0)},nu$8=function(major,minor){return{major:major,minor:minor}},Version={nu:nu$8,detect:detect$4,unknown:unknown$3},detectBrowser$1=function(browsers,userAgentData){return findMap(userAgentData.brands,(function(uaBrand){var lcBrand=uaBrand.brand.toLowerCase();return find$2(browsers,(function(browser){var _a;return lcBrand===(null===(_a=browser.brand)||void 0===_a?void 0:_a.toLowerCase())})).map((function(info){return{current:info.name,version:Version.nu(parseInt(uaBrand.version,10),0)}}))}))},detect$3=function(candidates,userAgent){var agent=String(userAgent).toLowerCase();return find$2(candidates,(function(candidate){return candidate.search(agent)}))},detectBrowser=function(browsers,userAgent){return detect$3(browsers,userAgent).map((function(browser){var version=Version.detect(browser.versionRegexes,userAgent);return{current:browser.name,version:version}}))},detectOs=function(oses,userAgent){return detect$3(oses,userAgent).map((function(os){var version=Version.detect(os.versionRegexes,userAgent);return{current:os.name,version:version}}))},checkRange=function(str,substr,start){return""===substr||str.length>=substr.length&&str.substr(start,start+substr.length)===substr},supplant=function(str,obj){var isStringOrNumber=function(a){var t=typeof a;return"string"===t||"number"===t};return str.replace(/\$\{([^{}]*)\}/g,(function(fullMatch,key){var value=obj[key];return isStringOrNumber(value)?value.toString():fullMatch}))},contains=function(str,substr){return-1!==str.indexOf(substr)},endsWith=function(str,suffix){return checkRange(str,suffix,str.length-suffix.length)},blank,trim=function(r){return function(s){return s.replace(r,"")}}(/^\s+|\s+$/g),normalVersionRegex=/.*?version\/\ ?([0-9]+)\.([0-9]+).*/,checkContains=function(target){return function(uastring){return contains(uastring,target)}},browsers=[{name:"Edge",versionRegexes:[/.*?edge\/ ?([0-9]+)\.([0-9]+)$/],search:function(uastring){return contains(uastring,"edge/")&&contains(uastring,"chrome")&&contains(uastring,"safari")&&contains(uastring,"applewebkit")}},{name:"Chrome",brand:"Chromium",versionRegexes:[/.*?chrome\/([0-9]+)\.([0-9]+).*/,normalVersionRegex],search:function(uastring){return contains(uastring,"chrome")&&!contains(uastring,"chromeframe")}},{name:"IE",versionRegexes:[/.*?msie\ ?([0-9]+)\.([0-9]+).*/,/.*?rv:([0-9]+)\.([0-9]+).*/],search:function(uastring){return contains(uastring,"msie")||contains(uastring,"trident")}},{name:"Opera",versionRegexes:[normalVersionRegex,/.*?opera\/([0-9]+)\.([0-9]+).*/],search:checkContains("opera")},{name:"Firefox",versionRegexes:[/.*?firefox\/\ ?([0-9]+)\.([0-9]+).*/],search:checkContains("firefox")},{name:"Safari",versionRegexes:[normalVersionRegex,/.*?cpu os ([0-9]+)_([0-9]+).*/],search:function(uastring){return(contains(uastring,"safari")||contains(uastring,"mobile/"))&&contains(uastring,"applewebkit")}}],oses=[{name:"Windows",search:checkContains("win"),versionRegexes:[/.*?windows\ nt\ ?([0-9]+)\.([0-9]+).*/]},{name:"iOS",search:function(uastring){return contains(uastring,"iphone")||contains(uastring,"ipad")},versionRegexes:[/.*?version\/\ ?([0-9]+)\.([0-9]+).*/,/.*cpu os ([0-9]+)_([0-9]+).*/,/.*cpu iphone os ([0-9]+)_([0-9]+).*/]},{name:"Android",search:checkContains("android"),versionRegexes:[/.*?android\ ?([0-9]+)\.([0-9]+).*/]},{name:"OSX",search:checkContains("mac os x"),versionRegexes:[/.*?mac\ os\ x\ ?([0-9]+)_([0-9]+).*/]},{name:"Linux",search:checkContains("linux"),versionRegexes:[]},{name:"Solaris",search:checkContains("sunos"),versionRegexes:[]},{name:"FreeBSD",search:checkContains("freebsd"),versionRegexes:[]},{name:"ChromeOS",search:checkContains("cros"),versionRegexes:[/.*?chrome\/([0-9]+)\.([0-9]+).*/]}],PlatformInfo={browsers:constant$1(browsers),oses:constant$1(oses)},edge="Edge",chrome="Chrome",ie="IE",opera="Opera",firefox="Firefox",safari="Safari",unknown$2=function(){return nu$7({current:void 0,version:Version.unknown()})},nu$7=function(info){var current=info.current,version=info.version,isBrowser=function(name){return function(){return current===name}};return{current:current,version:version,isEdge:isBrowser(edge),isChrome:isBrowser(chrome),isIE:isBrowser(ie),isOpera:isBrowser(opera),isFirefox:isBrowser(firefox),isSafari:isBrowser(safari)}},Browser={unknown:unknown$2,nu:nu$7,edge:constant$1(edge),chrome:constant$1(chrome),ie:constant$1(ie),opera:constant$1(opera),firefox:constant$1(firefox),safari:constant$1(safari)},windows="Windows",ios="iOS",android="Android",linux="Linux",osx="OSX",solaris="Solaris",freebsd="FreeBSD",chromeos="ChromeOS",unknown$1=function(){return nu$6({current:void 0,version:Version.unknown()})},nu$6=function(info){var current=info.current,version=info.version,isOS=function(name){return function(){return current===name}};return{current:current,version:version,isWindows:isOS(windows),isiOS:isOS(ios),isAndroid:isOS(android),isOSX:isOS(osx),isLinux:isOS(linux),isSolaris:isOS(solaris),isFreeBSD:isOS(freebsd),isChromeOS:isOS(chromeos)}},OperatingSystem={unknown:unknown$1,nu:nu$6,windows:constant$1(windows),ios:constant$1(ios),android:constant$1(android),linux:constant$1(linux),osx:constant$1(osx),solaris:constant$1(solaris),freebsd:constant$1(freebsd),chromeos:constant$1(chromeos)},detect$2,PlatformDetection_detect=function(userAgent,userAgentDataOpt,mediaMatch){var browsers=PlatformInfo.browsers(),oses=PlatformInfo.oses(),browser=userAgentDataOpt.bind((function(userAgentData){return detectBrowser$1(browsers,userAgentData)})).orThunk((function(){return detectBrowser(browsers,userAgent)})).fold(Browser.unknown,Browser.nu),os=detectOs(oses,userAgent).fold(OperatingSystem.unknown,OperatingSystem.nu),deviceType;return{browser:browser,os:os,deviceType:DeviceType(os,browser,userAgent,mediaMatch)}},mediaMatch=function(query){return window.matchMedia(query).matches},platform$1=cached((function(){return PlatformDetection_detect(navigator.userAgent,Optional.from(navigator.userAgentData),mediaMatch)})),detect$1=function(){return platform$1()},constant=constant$1,touchstart=constant("touchstart"),touchmove=constant("touchmove"),touchend=constant("touchend"),mousedown=constant("mousedown"),mousemove=constant("mousemove"),mouseup=constant("mouseup"),mouseover=constant("mouseover"),keydown=constant("keydown"),keyup=constant("keyup"),input$1=constant("input"),change=constant("change"),click=constant("click"),transitionend=constant("transitionend"),selectstart=constant("selectstart"),prefixName=function(name){return constant$1("alloy."+name)},alloy={tap:prefixName("tap")},focus$4=prefixName("focus"),postBlur=prefixName("blur.post"),postPaste=prefixName("paste.post"),receive$1=prefixName("receive"),execute$5=prefixName("execute"),focusItem=prefixName("focus.item"),tap=alloy.tap,longpress=prefixName("longpress"),systemInit=prefixName("system.init"),attachedToDom=prefixName("system.attached"),detachedFromDom=prefixName("system.detached"),focusShifted=prefixName("focusmanager.shifted"),highlight$1=prefixName("highlight"),dehighlight$1=prefixName("dehighlight"),emit=function(component,event){dispatchWith(component,component.element,event,{})},emitWith=function(component,event,properties){dispatchWith(component,component.element,event,properties)},emitExecute=function(component){emit(component,execute$5())},dispatch=function(component,target,event){dispatchWith(component,target,event,{})},dispatchWith=function(component,target,event,properties){var data=__assign({target:target},properties);component.getSystem().triggerEvent(event,target,data)},dispatchEvent=function(component,target,event,simulatedEvent){component.getSystem().triggerEvent(event,target,simulatedEvent.event)},dispatchFocus=function(component,target){component.getSystem().triggerFocus(target,component.element)},DOCUMENT=9,DOCUMENT_FRAGMENT=11,ELEMENT=1,TEXT=3,fromHtml$2=function(html,scope){var doc,div=(scope||document).createElement("div");if(div.innerHTML=html,!div.hasChildNodes()||div.childNodes.length>1)throw console.error("HTML does not have a single root node",html),new Error("HTML must have a single root node");return fromDom(div.childNodes[0])},fromTag=function(tag,scope){var doc,node=(scope||document).createElement(tag);return fromDom(node)},fromText=function(text,scope){var doc,node=(scope||document).createTextNode(text);return fromDom(node)},fromDom=function(node){if(null==node)throw new Error("Node cannot be null or undefined");return{dom:node}},fromPoint,SugarElement={fromHtml:fromHtml$2,fromTag:fromTag,fromText:fromText,fromDom:fromDom,fromPoint:function(docElm,x,y){return Optional.from(docElm.dom.elementFromPoint(x,y)).map(fromDom)}},is$1=function(element,selector){var dom=element.dom;if(1!==dom.nodeType)return!1;var elem=dom;if(void 0!==elem.matches)return elem.matches(selector);if(void 0!==elem.msMatchesSelector)return elem.msMatchesSelector(selector);if(void 0!==elem.webkitMatchesSelector)return elem.webkitMatchesSelector(selector);if(void 0!==elem.mozMatchesSelector)return elem.mozMatchesSelector(selector);throw new Error("Browser lacks native selectors")},bypassSelector=function(dom){return 1!==dom.nodeType&&9!==dom.nodeType&&11!==dom.nodeType||0===dom.childElementCount},all$2=function(selector,scope){var base=void 0===scope?document:scope.dom;return bypassSelector(base)?[]:map$2(base.querySelectorAll(selector),SugarElement.fromDom)},one=function(selector,scope){var base=void 0===scope?document:scope.dom;return bypassSelector(base)?Optional.none():Optional.from(base.querySelector(selector)).map(SugarElement.fromDom)},eq=function(e1,e2){return e1.dom===e2.dom};"undefined"!=typeof window?window:Function("return this;")();var name$1=function(element){var r;return element.dom.nodeName.toLowerCase()},type=function(element){return element.dom.nodeType},isType=function(t){return function(element){return type(element)===t}},isElement=isType(1),isText=isType(3),isDocument=isType(9),isDocumentFragment=isType(11),owner$2=function(element){return SugarElement.fromDom(element.dom.ownerDocument)},documentOrOwner=function(dos){return isDocument(dos)?dos:owner$2(dos)},defaultView=function(element){return SugarElement.fromDom(documentOrOwner(element).dom.defaultView)},parent=function(element){return Optional.from(element.dom.parentNode).map(SugarElement.fromDom)},parents=function(element,isRoot){for(var stop=isFunction(isRoot)?isRoot:never,dom=element.dom,ret=[];null!==dom.parentNode&&void 0!==dom.parentNode;){var rawParent=dom.parentNode,p=SugarElement.fromDom(rawParent);if(ret.push(p),!0===stop(p))break;dom=rawParent}return ret},siblings$2=function(element){var filterSelf=function(elements){return filter$2(elements,(function(x){return!eq(element,x)}))};return parent(element).map(children).map(filterSelf).getOr([])},nextSibling=function(element){return Optional.from(element.dom.nextSibling).map(SugarElement.fromDom)},children=function(element){return map$2(element.dom.childNodes,SugarElement.fromDom)},child=function(element,index){var cs=element.dom.childNodes;return Optional.from(cs[index]).map(SugarElement.fromDom)},firstChild=function(element){return child(element,0)},before$1=function(marker,element){var parent$1;parent(marker).each((function(v){v.dom.insertBefore(element.dom,marker.dom)}))},after$2=function(marker,element){var sibling;nextSibling(marker).fold((function(){var parent$1;parent(marker).each((function(v){append$2(v,element)}))}),(function(v){before$1(v,element)}))},prepend$1=function(parent,element){var firstChild$1;firstChild(parent).fold((function(){append$2(parent,element)}),(function(v){parent.dom.insertBefore(element.dom,v.dom)}))},append$2=function(parent,element){parent.dom.appendChild(element.dom)},appendAt=function(parent,element,index){child(parent,index).fold((function(){append$2(parent,element)}),(function(v){before$1(v,element)}))},append$1=function(parent,elements){each$1(elements,(function(x){append$2(parent,x)}))},empty=function(element){element.dom.textContent="",each$1(children(element),(function(rogue){remove$7(rogue)}))},remove$7=function(element){var dom=element.dom;null!==dom.parentNode&&dom.parentNode.removeChild(dom)},isShadowRoot=function(dos){return isDocumentFragment(dos)&&isNonNullable(dos.dom.host)},supported=isFunction(Element.prototype.attachShadow)&&isFunction(Node.prototype.getRootNode),isSupported$1=constant$1(supported),getRootNode=supported?function(e){return SugarElement.fromDom(e.dom.getRootNode())}:documentOrOwner,getShadowRoot=function(e){var r=getRootNode(e);return isShadowRoot(r)?Optional.some(r):Optional.none()},getShadowHost=function(e){return SugarElement.fromDom(e.dom.host)},getOriginalEventTarget=function(event){if(isSupported$1()&&isNonNullable(event.target)){var el=SugarElement.fromDom(event.target);if(isElement(el)&&isOpenShadowHost(el)&&event.composed&&event.composedPath){var composedPath=event.composedPath();if(composedPath)return head(composedPath)}}return Optional.from(event.target)},isOpenShadowHost=function(element){return isNonNullable(element.dom.shadowRoot)},inBody=function(element){var dom=isText(element)?element.dom.parentNode:element.dom;if(null==dom||null===dom.ownerDocument)return!1;var doc=dom.ownerDocument;return getShadowRoot(SugarElement.fromDom(dom)).fold((function(){return doc.body.contains(dom)}),compose1(inBody,getShadowHost))},body=function(){return getBody(SugarElement.fromDom(document))},getBody=function(doc){var b=doc.dom.body;if(null==b)throw new Error("Body is not available yet");return SugarElement.fromDom(b)},fireDetaching=function(component){emit(component,detachedFromDom());var children=component.components();each$1(children,fireDetaching)},fireAttaching=function(component){var children=component.components();each$1(children,fireAttaching),emit(component,attachedToDom())},attach$1=function(parent,child){append$2(parent.element,child.element)},detachChildren=function(component){each$1(component.components(),(function(childComp){return remove$7(childComp.element)})),empty(component.element),component.syncComponents()},replaceChildren=function(component,newChildren){var subs=component.components();detachChildren(component);var deleted=difference(subs,newChildren);each$1(deleted,(function(comp){fireDetaching(comp),component.getSystem().removeFromWorld(comp)})),each$1(newChildren,(function(childComp){childComp.getSystem().isConnected()?attach$1(component,childComp):(component.getSystem().addToWorld(childComp),attach$1(component,childComp),inBody(component.element)&&fireAttaching(childComp)),component.syncComponents()}))},attach=function(parent,child){attachWith(parent,child,append$2)},attachWith=function(parent,child,insertion){parent.getSystem().addToWorld(child),insertion(parent.element,child.element),inBody(parent.element)&&fireAttaching(child),parent.syncComponents()},doDetach=function(component){fireDetaching(component),remove$7(component.element),component.getSystem().removeFromWorld(component)},detach=function(component){var parent$1=parent(component.element).bind((function(p){return component.getSystem().getByDom(p).toOptional()}));doDetach(component),parent$1.each((function(p){p.syncComponents()}))},attachSystemAfter=function(element,guiSystem){attachSystemWith(element,guiSystem,after$2)},attachSystemWith=function(element,guiSystem,inserter){inserter(element,guiSystem.element);var children$1=children(guiSystem.element);each$1(children$1,(function(child){guiSystem.getByDom(child).each(fireAttaching)}))},detachSystem=function(guiSystem){var children$1=children(guiSystem.element);each$1(children$1,(function(child){guiSystem.getByDom(child).each(fireDetaching)})),remove$7(guiSystem.element)},keys=Object.keys,hasOwnProperty=Object.hasOwnProperty,each=function(obj,f){for(var props=keys(obj),k=0,len=props.length;k<len;k++){var i=props[k],x;f(obj[i],i)}},map$1=function(obj,f){return tupleMap(obj,(function(x,i){return{k:i,v:f(x,i)}}))},tupleMap=function(obj,f){var r={};return each(obj,(function(x,i){var tuple=f(x,i);r[tuple.k]=tuple.v})),r},objAcc=function(r){return function(x,i){r[i]=x}},internalFilter=function(obj,pred,onTrue,onFalse){var r={};return each(obj,(function(x,i){(pred(x,i)?onTrue:onFalse)(x,i)})),r},filter$1=function(obj,pred){var t={};return internalFilter(obj,pred,objAcc(t),noop),t},mapToArray=function(obj,f){var r=[];return each(obj,(function(value,name){r.push(f(value,name))})),r},find=function(obj,pred){for(var props=keys(obj),k=0,len=props.length;k<len;k++){var i=props[k],x=obj[i];if(pred(x,i,obj))return Optional.some(x)}return Optional.none()},values=function(obj){return mapToArray(obj,identity)},get$c=function(obj,key){return has$2(obj,key)?Optional.from(obj[key]):Optional.none()},has$2=function(obj,key){return hasOwnProperty.call(obj,key)},hasNonNullableKey=function(obj,key){return has$2(obj,key)&&void 0!==obj[key]&&null!==obj[key]},rawSet=function(dom,key,value){if(!(isString(value)||isBoolean(value)||isNumber(value)))throw console.error("Invalid call to Attribute.set. Key ",key,":: Value ",value,":: Element ",dom),new Error("Attribute value was not simple");dom.setAttribute(key,value+"")},set$8=function(element,key,value){rawSet(element.dom,key,value)},setAll$1=function(element,attrs){var dom=element.dom;each(attrs,(function(v,k){rawSet(dom,k,v)}))},get$b=function(element,key){var v=element.dom.getAttribute(key);return null===v?void 0:v},getOpt=function(element,key){return Optional.from(get$b(element,key))},has$1=function(element,key){var dom=element.dom;return!(!dom||!dom.hasAttribute)&&dom.hasAttribute(key)},remove$6=function(element,key){element.dom.removeAttribute(key)},read$2=function(element,attr){var value=get$b(element,attr);return void 0===value||""===value?[]:value.split(" ")},add$3=function(element,attr,id){var old,nu=read$2(element,attr).concat([id]);return set$8(element,attr,nu.join(" ")),!0},remove$5=function(element,attr,id){var nu=filter$2(read$2(element,attr),(function(v){return v!==id}));return nu.length>0?set$8(element,attr,nu.join(" ")):remove$6(element,attr),!1},supports=function(element){return void 0!==element.dom.classList},get$a=function(element){return read$2(element,"class")},add$2=function(element,clazz){return add$3(element,"class",clazz)},remove$4=function(element,clazz){return remove$5(element,"class",clazz)},add$1=function(element,clazz){supports(element)?element.dom.classList.add(clazz):add$2(element,clazz)},cleanClass=function(element){var classList;0===(supports(element)?element.dom.classList:get$a(element)).length&&remove$6(element,"class")},remove$3=function(element,clazz){var classList;supports(element)?element.dom.classList.remove(clazz):remove$4(element,clazz);cleanClass(element)},has=function(element,clazz){return supports(element)&&element.dom.classList.contains(clazz)},swap=function(element,addCls,removeCls){remove$3(element,removeCls),add$1(element,addCls)},toAlpha=function(component,swapConfig,_swapState){swap(component.element,swapConfig.alpha,swapConfig.omega)},toOmega=function(component,swapConfig,_swapState){swap(component.element,swapConfig.omega,swapConfig.alpha)},clear$1=function(component,swapConfig,_swapState){remove$3(component.element,swapConfig.alpha),remove$3(component.element,swapConfig.omega)},isAlpha=function(component,swapConfig,_swapState){return has(component.element,swapConfig.alpha)},isOmega=function(component,swapConfig,_swapState){return has(component.element,swapConfig.omega)},SwapApis=Object.freeze({__proto__:null,toAlpha:toAlpha,toOmega:toOmega,isAlpha:isAlpha,isOmega:isOmega,clear:clear$1}),value$2=function(o){var or=function(_opt){return value$2(o)},orThunk=function(_f){return value$2(o)},map=function(f){return value$2(f(o))},mapError=function(_f){return value$2(o)},each=function(f){f(o)},bind=function(f){return f(o)},fold=function(_,onValue){return onValue(o)},exists=function(f){return f(o)},forall=function(f){return f(o)},toOptional=function(){return Optional.some(o)};return{isValue:always,isError:never,getOr:constant$1(o),getOrThunk:constant$1(o),getOrDie:constant$1(o),or:or,orThunk:orThunk,fold:fold,map:map,mapError:mapError,each:each,bind:bind,exists:exists,forall:forall,toOptional:toOptional}},error=function(message){var getOrThunk,getOrDie,or,orThunk,map,mapError,bind,fold;return{isValue:never,isError:always,getOr:identity,getOrThunk:function(f){return f()},getOrDie:function(){return die(String(message))()},or:identity,orThunk:function(f){return f()},fold:function(onError,_){return onError(message)},map:function(_f){return error(message)},mapError:function(f){return error(f(message))},each:noop,bind:function(_f){return error(message)},exists:never,forall:always,toOptional:Optional.none}},fromOption=function(opt,err){return opt.fold((function(){return error(err)}),value$2)},Result={value:value$2,error:error,fromOption:fromOption},SimpleResultType;!function(SimpleResultType){SimpleResultType[SimpleResultType.Error=0]="Error",SimpleResultType[SimpleResultType.Value=1]="Value"}(SimpleResultType||(SimpleResultType={}));var fold$1=function(res,onError,onValue){return res.stype===SimpleResultType.Error?onError(res.serror):onValue(res.svalue)},partition$1,mapError,map,bind$2,bindError,svalue=function(v){return{stype:SimpleResultType.Value,svalue:v}},serror=function(e){return{stype:SimpleResultType.Error,serror:e}},toResult$1,fromResult,SimpleResult_fromResult=function(res){return res.fold(serror,svalue)},SimpleResult_toResult=function(res){return fold$1(res,Result.error,Result.value)},SimpleResult_svalue=svalue,SimpleResult_partition=function(results){var values=[],errors=[];return each$1(results,(function(obj){fold$1(obj,(function(err){return errors.push(err)}),(function(val){return values.push(val)}))})),{values:values,errors:errors}},SimpleResult_serror=serror,SimpleResult_bind=function(res,f){return res.stype===SimpleResultType.Value?f(res.svalue):res},SimpleResult_bindError=function(res,f){return res.stype===SimpleResultType.Error?f(res.serror):res},SimpleResult_map=function(res,f){return res.stype===SimpleResultType.Value?{stype:SimpleResultType.Value,svalue:f(res.svalue)}:res},SimpleResult_mapError=function(res,f){return res.stype===SimpleResultType.Error?{stype:SimpleResultType.Error,serror:f(res.serror)}:res},SimpleResult_fold=fold$1,field$3=function(key,newKey,presence,prop){return{tag:"field",key:key,newKey:newKey,presence:presence,prop:prop}},customField$1=function(newKey,instantiator){return{tag:"custom",newKey:newKey,instantiator:instantiator}},fold=function(value,ifField,ifCustom){switch(value.tag){case"field":return ifField(value.key,value.newKey,value.presence,value.prop);case"custom":return ifCustom(value.newKey,value.instantiator)}},shallow$1=function(old,nu){return nu},deep,baseMerge=function(merger){return function(){for(var objects=[],_i=0;_i<arguments.length;_i++)objects[_i]=arguments[_i];if(0===objects.length)throw new Error("Can't merge zero objects");for(var ret={},j=0;j<objects.length;j++){var curObject=objects[j];for(var key in curObject)has$2(curObject,key)&&(ret[key]=merger(ret[key],curObject[key]))}return ret}},deepMerge=baseMerge((function(old,nu){var bothObjects;return isObject(old)&&isObject(nu)?deepMerge(old,nu):nu})),merge$1=baseMerge(shallow$1),required$2=function(){return{tag:"required",process:{}}},defaultedThunk=function(fallbackThunk){return{tag:"defaultedThunk",process:fallbackThunk}},defaulted$1=function(fallback){return defaultedThunk(constant$1(fallback))},asOption=function(){return{tag:"option",process:{}}},mergeWithThunk=function(baseThunk){return{tag:"mergeWithThunk",process:baseThunk}},mergeWith=function(base){return mergeWithThunk(constant$1(base))},mergeValues$1=function(values,base){return values.length>0?SimpleResult_svalue(deepMerge(base,merge$1.apply(void 0,values))):SimpleResult_svalue(base)},mergeErrors$1=function(errors){return compose(SimpleResult_serror,flatten)(errors)},consolidateObj,consolidateArr,ResultCombine_consolidateObj=function(objects,base){var partition=SimpleResult_partition(objects);return partition.errors.length>0?mergeErrors$1(partition.errors):mergeValues$1(partition.values,base)},ResultCombine_consolidateArr=function(objects){var partitions=SimpleResult_partition(objects);return partitions.errors.length>0?mergeErrors$1(partitions.errors):SimpleResult_svalue(partitions.values)},formatObj=function(input){return isObject(input)&&keys(input).length>100?" removed due to size":JSON.stringify(input,null,2)},formatErrors=function(errors){var es=errors.length>10?errors.slice(0,10).concat([{path:[],getErrorInfo:constant$1("... (only showing first ten failures)")}]):errors;return map$2(es,(function(e){return"Failed path: ("+e.path.join(" > ")+")\n"+e.getErrorInfo()}))},nu$5=function(path,getErrorInfo){return SimpleResult_serror([{path:path,getErrorInfo:getErrorInfo}])},missingRequired=function(path,key,obj){return nu$5(path,(function(){return'Could not find valid *required* value for "'+key+'" in '+formatObj(obj)}))},missingKey=function(path,key){return nu$5(path,(function(){return'Choice schema did not contain choice key: "'+key+'"'}))},missingBranch=function(path,branches,branch){return nu$5(path,(function(){return'The chosen schema: "'+branch+'" did not exist in branches: '+formatObj(branches)}))},unsupportedFields=function(path,unsupported){return nu$5(path,(function(){return"There are unsupported fields: ["+unsupported.join(", ")+"] specified"}))},custom=function(path,err){return nu$5(path,constant$1(err))},value$1=function(validator){var extract,toString;return{extract:function(path,val){return SimpleResult_bindError(validator(val),(function(err){return custom(path,err)}))},toString:constant$1("val")}},anyValue$1=value$1(SimpleResult_svalue),requiredAccess=function(path,obj,key,bundle){return get$c(obj,key).fold((function(){return missingRequired(path,key,obj)}),bundle)},fallbackAccess=function(obj,key,fallback,bundle){var v;return bundle(get$c(obj,key).getOrThunk((function(){return fallback(obj)})))},optionAccess=function(obj,key,bundle){return bundle(get$c(obj,key))},optionDefaultedAccess=function(obj,key,fallback,bundle){var opt;return bundle(get$c(obj,key).map((function(val){return!0===val?fallback(obj):val})))},extractField=function(field,path,obj,key,prop){var bundle=function(av){return prop.extract(path.concat([key]),av)},bundleAsOption=function(optValue){return optValue.fold((function(){return SimpleResult_svalue(Optional.none())}),(function(ov){var result=prop.extract(path.concat([key]),ov);return SimpleResult_map(result,Optional.some)}))};switch(field.tag){case"required":return requiredAccess(path,obj,key,bundle);case"defaultedThunk":return fallbackAccess(obj,key,field.process,bundle);case"option":return optionAccess(obj,key,bundleAsOption);case"defaultedOptionThunk":return optionDefaultedAccess(obj,key,field.process,bundleAsOption);case"mergeWithThunk":return fallbackAccess(obj,key,constant$1({}),(function(v){var result=deepMerge(field.process(obj),v);return bundle(result)}))}},extractFields=function(path,obj,fields){for(var success={},errors=[],_i=0,fields_1=fields;_i<fields_1.length;_i++){var field=fields_1[_i];fold(field,(function(key,newKey,presence,prop){var result=extractField(presence,path,obj,key,prop);SimpleResult_fold(result,(function(err){errors.push.apply(errors,err)}),(function(res){success[newKey]=res}))}),(function(newKey,instantiator){success[newKey]=instantiator(obj)}))}return errors.length>0?SimpleResult_serror(errors):SimpleResult_svalue(success)},getSetKeys=function(obj){return keys(filter$1(obj,isNonNullable))},objOfOnly=function(fields){var delegate=objOf(fields),fieldNames=foldr(fields,(function(acc,value){return fold(value,(function(key){var _a;return deepMerge(acc,((_a={})[key]=!0,_a))}),constant$1(acc))}),{}),extract;return{extract:function(path,o){var keys=isBoolean(o)?[]:getSetKeys(o),extra=filter$2(keys,(function(k){return!hasNonNullableKey(fieldNames,k)}));return 0===extra.length?delegate.extract(path,o):unsupportedFields(path,extra)},toString:delegate.toString}},objOf=function(values){var extract,toString;return{extract:function(path,o){return extractFields(path,o,values)},toString:function(){var fieldStrings;return"obj{\n"+map$2(values,(function(value){return fold(value,(function(key,_okey,_presence,prop){return key+" -> "+prop.toString()}),(function(newKey,_instantiator){return"state("+newKey+")"}))})).join("\n")+"}"}}},arrOf=function(prop){var extract,toString;return{extract:function(path,array){var results=map$2(array,(function(a,i){return prop.extract(path.concat(["["+i+"]"]),a)}));return ResultCombine_consolidateArr(results)},toString:function(){return"array("+prop.toString()+")"}}},setOf$1=function(validator,prop){var validateKeys=function(path,keys){return arrOf(value$1(validator)).extract(path,keys)},extract,toString;return{extract:function(path,o){var keys$1=keys(o),validatedKeys=validateKeys(path,keys$1);return SimpleResult_bind(validatedKeys,(function(validKeys){var schema=map$2(validKeys,(function(vk){return field$3(vk,vk,{tag:"required",process:{}},prop)}));return objOf(schema).extract(path,o)}))},toString:function(){return"setOf("+prop.toString()+")"}}},anyValue=constant$1(anyValue$1),typedValue,functionProcessor=function(validator,expectedType){return value$1((function(a){var actualType=typeof a;return validator(a)?SimpleResult_svalue(a):SimpleResult_serror("Expected type: "+expectedType+" but got: "+actualType)}))}(isFunction,"function"),chooseFrom=function(path,input,branches,ch){var fields;return get$c(branches,ch).fold((function(){return missingBranch(path,branches,ch)}),(function(vp){return vp.extract(path.concat(["branch: "+ch]),input)}))},choose$2=function(key,branches){var extract,toString;return{extract:function(path,input){var choice;return get$c(input,key).fold((function(){return missingKey(path,key)}),(function(chosen){return chooseFrom(path,input,branches,chosen)}))},toString:function(){return"chooseOn("+key+"). Possible values: "+keys(branches)}}},valueOf=function(validator){return value$1((function(v){return validator(v).fold(SimpleResult_serror,SimpleResult_svalue)}))},setOf=function(validator,prop){return setOf$1((function(v){return SimpleResult_fromResult(validator(v))}),prop)},extractValue=function(label,prop,obj){var res=prop.extract([label],obj);return SimpleResult_mapError(res,(function(errs){return{input:obj,errors:errs}}))},asRaw=function(label,prop,obj){return SimpleResult_toResult(extractValue(label,prop,obj))},getOrDie=function(extraction){return extraction.fold((function(errInfo){throw new Error(formatError(errInfo))}),identity)},asRawOrDie$1=function(label,prop,obj){return getOrDie(asRaw(label,prop,obj))},formatError=function(errInfo){return"Errors: \n"+formatErrors(errInfo.errors).join("\n")+"\n\nInput object: "+formatObj(errInfo.input)},choose$1=function(key,branches){return choose$2(key,map$1(branches,objOf))},field$2=field$3,customField=customField$1,required$1=function(key){return field$2(key,key,{tag:"required",process:{}},anyValue())},requiredOf=function(key,schema){return field$2(key,key,{tag:"required",process:{}},schema)},forbid=function(key,message){return field$2(key,key,{tag:"option",process:{}},value$1((function(_v){return SimpleResult_serror("The field: "+key+" is forbidden. "+message)})))},requiredObjOf=function(key,objSchema){return field$2(key,key,{tag:"required",process:{}},objOf(objSchema))},option=function(key){return field$2(key,key,{tag:"option",process:{}},anyValue())},optionOf=function(key,schema){return field$2(key,key,{tag:"option",process:{}},schema)},optionObjOf=function(key,objSchema){return optionOf(key,objOf(objSchema))},optionObjOfOnly=function(key,objSchema){return optionOf(key,objOfOnly(objSchema))},defaulted=function(key,fallback){return field$2(key,key,defaulted$1(fallback),anyValue())},defaultedOf=function(key,fallback,schema){return field$2(key,key,defaulted$1(fallback),schema)},defaultedFunction=function(key,fallback){return defaultedOf(key,fallback,functionProcessor)},defaultedObjOf=function(key,fallback,objSchema){return defaultedOf(key,fallback,objOf(objSchema))},SwapSchema=[required$1("alpha"),required$1("omega")],generate$5,Adt_generate=function(cases){if(!isArray(cases))throw new Error("cases must be an array");if(0===cases.length)throw new Error("there must be at least one case");var constructors=[],adt={};return each$1(cases,(function(acase,count){var keys$1=keys(acase);if(1!==keys$1.length)throw new Error("one and only one name per case");var key=keys$1[0],value=acase[key];if(void 0!==adt[key])throw new Error("duplicate key detected:"+key);if("cata"===key)throw new Error("cannot have a case named cata (sorry)");if(!isArray(value))throw new Error("case arguments must be an array");constructors.push(key),adt[key]=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var argLength=args.length;if(argLength!==value.length)throw new Error("Wrong number of arguments to case "+key+". Expected "+value.length+" ("+value+"), got "+argLength);var match=function(branches){var branchKeys=keys(branches),allReqd;if(constructors.length!==branchKeys.length)throw new Error("Wrong number of arguments to match. Expected: "+constructors.join(",")+"\nActual: "+branchKeys.join(","));if(!forall(constructors,(function(reqKey){return contains$1(branchKeys,reqKey)})))throw new Error("Not all branches were specified when using match. Specified: "+branchKeys.join(", ")+"\nRequired: "+constructors.join(", "));return branches[key].apply(null,args)};return{fold:function(){for(var foldArgs=[],_i=0;_i<arguments.length;_i++)foldArgs[_i]=arguments[_i];if(foldArgs.length!==cases.length)throw new Error("Wrong number of arguments to fold. Expected "+cases.length+", got "+foldArgs.length);var target=foldArgs[count];return target.apply(null,args)},match:match,log:function(label){console.log(label,{constructors:constructors,constructor:key,params:args})}}}})),adt};Adt_generate([{bothErrors:["error1","error2"]},{firstError:["error1","value2"]},{secondError:["value1","error2"]},{bothValues:["value1","value2"]}]);var partition=function(results){var errors=[],values=[];return each$1(results,(function(result){result.fold((function(err){errors.push(err)}),(function(value){values.push(value)}))})),{errors:errors,values:values}},exclude$1=function(obj,fields){var r={};return each(obj,(function(v,k){contains$1(fields,k)||(r[k]=v)})),r},wrap$1=function(key,value){var _a;return(_a={})[key]=value,_a},wrapAll$1=function(keyvalues){var r={};return each$1(keyvalues,(function(kv){r[kv.key]=kv.value})),r},exclude=function(obj,fields){return exclude$1(obj,fields)},wrap=function(key,value){return wrap$1(key,value)},wrapAll=function(keyvalues){return wrapAll$1(keyvalues)},mergeValues=function(values,base){return 0===values.length?Result.value(base):Result.value(deepMerge(base,merge$1.apply(void 0,values)))},mergeErrors=function(errors){return Result.error(flatten(errors))},consolidate=function(objs,base){var partitions=partition(objs);return partitions.errors.length>0?mergeErrors(partitions.errors):mergeValues(partitions.values,base)},is=function(lhs,rhs,comparator){return void 0===comparator&&(comparator=tripleEquals),lhs.exists((function(left){return comparator(left,rhs)}))},cat=function(arr){for(var r=[],push=function(x){r.push(x)},i=0;i<arr.length;i++)arr[i].each(push);return r},sequence=function(arr){for(var r=[],i=0;i<arr.length;i++){var x=arr[i];if(!x.isSome())return Optional.none();r.push(x.getOrDie())}return Optional.some(r)},lift2=function(oa,ob,f){return oa.isSome()&&ob.isSome()?Optional.some(f(oa.getOrDie(),ob.getOrDie())):Optional.none()},someIf=function(b,a){return b?Optional.some(a):Optional.none()},ensureIsRoot=function(isRoot){return isFunction(isRoot)?isRoot:never},ancestor$2=function(scope,transform,isRoot){for(var element=scope.dom,stop=ensureIsRoot(isRoot);element.parentNode;){element=element.parentNode;var el=SugarElement.fromDom(element),transformed=transform(el);if(transformed.isSome())return transformed;if(stop(el))break}return Optional.none()},closest$3=function(scope,transform,isRoot){var current=transform(scope),stop=ensureIsRoot(isRoot);return current.orThunk((function(){return stop(scope)?Optional.none():ancestor$2(scope,transform,stop)}))},isSource=function(component,simulatedEvent){return eq(component.element,simulatedEvent.event.target)},defaultEventHandler={can:always,abort:never,run:noop},nu$4=function(parts){if(!hasNonNullableKey(parts,"can")&&!hasNonNullableKey(parts,"abort")&&!hasNonNullableKey(parts,"run"))throw new Error("EventHandler defined by: "+JSON.stringify(parts,null,2)+" does not have can, abort, or run!");return __assign(__assign({},defaultEventHandler),parts)},all$1=function(handlers,f){return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return foldl(handlers,(function(acc,handler){return acc&&f(handler).apply(void 0,args)}),!0)}},any=function(handlers,f){return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return foldl(handlers,(function(acc,handler){return acc||f(handler).apply(void 0,args)}),!1)}},read$1=function(handler){return isFunction(handler)?{can:always,abort:never,run:handler}:handler},fuse$1=function(handlers){var can,abort,run;return{can:all$1(handlers,(function(handler){return handler.can})),abort:any(handlers,(function(handler){return handler.abort})),run:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];each$1(handlers,(function(handler){handler.run.apply(void 0,args)}))}}},derive$3=function(configs){return wrapAll(configs)},abort=function(name,predicate){return{key:name,value:nu$4({abort:predicate})}},can=function(name,predicate){return{key:name,value:nu$4({can:predicate})}},run=function(name,handler){return{key:name,value:nu$4({run:handler})}},runActionExtra=function(name,action,extra){return{key:name,value:nu$4({run:function(component,simulatedEvent){action.apply(void 0,[component,simulatedEvent].concat(extra))}})}},runOnName=function(name){return function(handler){return run(name,handler)}},runOnSourceName=function(name){return function(handler){return{key:name,value:nu$4({run:function(component,simulatedEvent){isSource(component,simulatedEvent)&&handler(component,simulatedEvent)}})}}},redirectToUid=function(name,uid){return run(name,(function(component,simulatedEvent){component.getSystem().getByUid(uid).each((function(redirectee){dispatchEvent(redirectee,redirectee.element,name,simulatedEvent)}))}))},redirectToPart=function(name,detail,partName){var uid=detail.partUids[partName];return redirectToUid(name,uid)},cutter=function(name){return run(name,(function(component,simulatedEvent){simulatedEvent.cut()}))},stopper=function(name){return run(name,(function(component,simulatedEvent){simulatedEvent.stop()}))},runOnSource=function(name,f){return runOnSourceName(name)(f)},runOnAttached=runOnSourceName(attachedToDom()),runOnDetached=runOnSourceName(detachedFromDom()),runOnInit=runOnSourceName(systemInit()),runOnExecute=runOnName(execute$5()),markAsBehaviourApi=function(f,apiName,apiFunction){var delegate=apiFunction.toString(),endIndex=delegate.indexOf(")")+1,openBracketIndex=delegate.indexOf("("),parameters=delegate.substring(openBracketIndex+1,endIndex-1).split(/,\s*/);return f.toFunctionAnnotation=function(){return{name:apiName,parameters:cleanParameters(parameters.slice(0,1).concat(parameters.slice(3)))}},f},cleanParameters=function(parameters){return map$2(parameters,(function(p){return endsWith(p,"/*")?p.substring(0,p.length-"/*".length):p}))},markAsExtraApi=function(f,extraName){var delegate=f.toString(),endIndex=delegate.indexOf(")")+1,openBracketIndex=delegate.indexOf("("),parameters=delegate.substring(openBracketIndex+1,endIndex-1).split(/,\s*/);return f.toFunctionAnnotation=function(){return{name:extraName,parameters:cleanParameters(parameters)}},f},markAsSketchApi=function(f,apiFunction){var delegate=apiFunction.toString(),endIndex=delegate.indexOf(")")+1,openBracketIndex=delegate.indexOf("("),parameters=delegate.substring(openBracketIndex+1,endIndex-1).split(/,\s*/);return f.toFunctionAnnotation=function(){return{name:"OVERRIDE",parameters:cleanParameters(parameters.slice(1))}},f},nu$3=function(s){return{classes:isUndefined(s.classes)?[]:s.classes,attributes:isUndefined(s.attributes)?{}:s.attributes,styles:isUndefined(s.styles)?{}:s.styles}},merge=function(defnA,mod){return __assign(__assign({},defnA),{attributes:__assign(__assign({},defnA.attributes),mod.attributes),styles:__assign(__assign({},defnA.styles),mod.styles),classes:defnA.classes.concat(mod.classes)})},executeEvent=function(bConfig,bState,executor){return runOnExecute((function(component){executor(component,bConfig,bState)}))},loadEvent=function(bConfig,bState,f){return runOnInit((function(component,_simulatedEvent){f(component,bConfig,bState)}))},create$6=function(schema,name,active,apis,extra,state){var configSchema=objOfOnly(schema),schemaSchema=optionObjOf(name,[optionObjOfOnly("config",schema)]);return doCreate(configSchema,schemaSchema,name,active,apis,extra,state)},createModes$1=function(modes,name,active,apis,extra,state){var configSchema=modes,schemaSchema=optionObjOf(name,[optionOf("config",modes)]);return doCreate(configSchema,schemaSchema,name,active,apis,extra,state)},wrapApi=function(bName,apiFunction,apiName){var f;return markAsBehaviourApi((function(component){for(var rest=[],_i=1;_i<arguments.length;_i++)rest[_i-1]=arguments[_i];var args=[component].concat(rest);return component.config({name:constant$1(bName)}).fold((function(){throw new Error("We could not find any behaviour configuration for: "+bName+". Using API: "+apiName)}),(function(info){var rest=Array.prototype.slice.call(args,1);return apiFunction.apply(void 0,[component,info.config,info.state].concat(rest))}))}),apiName,apiFunction)},revokeBehaviour=function(name){return{key:name,value:void 0}},doCreate=function(configSchema,schemaSchema,name,active,apis,extra,state){var getConfig=function(info){return hasNonNullableKey(info,name)?info[name]():Optional.none()},wrappedApis=map$1(apis,(function(apiF,apiName){return wrapApi(name,apiF,apiName)})),wrappedExtra=map$1(extra,(function(extraF,extraName){return markAsExtraApi(extraF,extraName)})),me=__assign(__assign(__assign({},wrappedExtra),wrappedApis),{revoke:curry(revokeBehaviour,name),config:function(spec){var prepared=asRawOrDie$1(name+"-config",configSchema,spec);return{key:name,value:{config:prepared,me:me,configAsRaw:cached((function(){return asRawOrDie$1(name+"-config",configSchema,spec)})),initialConfig:spec,state:state}}},schema:constant$1(schemaSchema),exhibit:function(info,base){return lift2(getConfig(info),get$c(active,"exhibit"),(function(behaviourInfo,exhibitor){return exhibitor(base,behaviourInfo.config,behaviourInfo.state)})).getOrThunk((function(){return nu$3({})}))},name:constant$1(name),handlers:function(info){return getConfig(info).map((function(behaviourInfo){var getEvents;return get$c(active,"events").getOr((function(){return{}}))(behaviourInfo.config,behaviourInfo.state)})).getOr({})}});return me},NoState={init:function(){return nu$2({readState:constant$1("No State required")})}},nu$2=function(spec){return spec},derive$2=function(capabilities){return wrapAll(capabilities)},simpleSchema=objOfOnly([required$1("fields"),required$1("name"),defaulted("active",{}),defaulted("apis",{}),defaulted("state",NoState),defaulted("extra",{})]),create$5=function(data){var value=asRawOrDie$1("Creating behaviour: "+data.name,simpleSchema,data);return create$6(value.fields,value.name,value.active,value.apis,value.extra,value.state)},modeSchema=objOfOnly([required$1("branchKey"),required$1("branches"),required$1("name"),defaulted("active",{}),defaulted("apis",{}),defaulted("state",NoState),defaulted("extra",{})]),createModes=function(data){var value=asRawOrDie$1("Creating behaviour: "+data.name,modeSchema,data);return createModes$1(choose$1(value.branchKey,value.branches),value.name,value.active,value.apis,value.extra,value.state)},revoke=constant$1(void 0),Swapping=create$5({fields:SwapSchema,name:"swapping",apis:SwapApis}),Cell=function(initial){var value=initial,get,set;return{get:function(){return value},set:function(v){value=v}}},getDocument=function(){return SugarElement.fromDom(document)},focus$3=function(element){return element.dom.focus()},blur$1=function(element){return element.dom.blur()},hasFocus=function(element){var root=getRootNode(element).dom;return element.dom===root.activeElement},active=function(root){return void 0===root&&(root=getDocument()),Optional.from(root.dom.activeElement).map(SugarElement.fromDom)},search=function(element){return active(getRootNode(element)).filter((function(e){return element.dom.contains(e.dom)}))},global$5=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),global$4=tinymce.util.Tools.resolve("tinymce.ThemeManager"),openLink=function(target){var link=document.createElement("a");link.target="_blank",link.href=target.href,link.rel="noreferrer noopener";var nuEvt=document.createEvent("MouseEvents");nuEvt.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),document.body.appendChild(link),link.dispatchEvent(nuEvt),document.body.removeChild(link)},DefaultStyleFormats=[{title:"Headings",items:[{title:"Heading 1",format:"h1"},{title:"Heading 2",format:"h2"},{title:"Heading 3",format:"h3"},{title:"Heading 4",format:"h4"},{title:"Heading 5",format:"h5"},{title:"Heading 6",format:"h6"}]},{title:"Inline",items:[{title:"Bold",icon:"bold",format:"bold"},{title:"Italic",icon:"italic",format:"italic"},{title:"Underline",icon:"underline",format:"underline"},{title:"Strikethrough",icon:"strikethrough",format:"strikethrough"},{title:"Superscript",icon:"superscript",format:"superscript"},{title:"Subscript",icon:"subscript",format:"subscript"},{title:"Code",icon:"code",format:"code"}]},{title:"Blocks",items:[{title:"Paragraph",format:"p"},{title:"Blockquote",format:"blockquote"},{title:"Div",format:"div"},{title:"Pre",format:"pre"}]},{title:"Alignment",items:[{title:"Left",icon:"alignleft",format:"alignleft"},{title:"Center",icon:"aligncenter",format:"aligncenter"},{title:"Right",icon:"alignright",format:"alignright"},{title:"Justify",icon:"alignjustify",format:"alignjustify"}]}],defaults=["undo","bold","italic","link","image","bullist","styleselect"],isSkinDisabled=function(editor){return!1===editor.getParam("skin")},readOnlyOnInit=function(_editor){return!1},getToolbar=function(editor){return editor.getParam("toolbar",defaults,"array")},getStyleFormats=function(editor){return editor.getParam("style_formats",DefaultStyleFormats,"array")},getSkinUrl=function(editor){return editor.getParam("skin_url")},formatChanged="formatChanged",orientationChanged="orientationChanged",dropupDismissed="dropupDismissed",fromHtml$1=function(html,scope){var doc,div=(scope||document).createElement("div");return div.innerHTML=html,children(SugarElement.fromDom(div))},get$9=function(element){return element.dom.innerHTML},set$7=function(element,content){var owner,docDom=owner$2(element).dom,fragment=SugarElement.fromDom(docDom.createDocumentFragment()),contentElements=fromHtml$1(content,docDom);append$1(fragment,contentElements),empty(element),append$2(element,fragment)},getOuter=function(element){var container=SugarElement.fromTag("div"),clone=SugarElement.fromDom(element.dom.cloneNode(!0));return append$2(container,clone),get$9(container)},clone=function(original,isDeep){return SugarElement.fromDom(original.dom.cloneNode(isDeep))},shallow=function(original){return clone(original,!1)},getHtml=function(element){if(isShadowRoot(element))return"#shadow-root";var clone=shallow(element);return getOuter(clone)},element=function(elem){return getHtml(elem)},chooseChannels=function(channels,message){return message.universal?channels:filter$2(channels,(function(ch){return contains$1(message.channels,ch)}))},events$a=function(receiveConfig){return derive$3([run(receive$1(),(function(component,message){var channelMap=receiveConfig.channels,channels=keys(channelMap),receivingData=message,targetChannels=chooseChannels(channels,receivingData);each$1(targetChannels,(function(ch){var channelInfo=channelMap[ch],channelSchema=channelInfo.schema,data=asRawOrDie$1("channel["+ch+"] data\nReceiver: "+element(component.element),channelSchema,receivingData.data);channelInfo.onReceive(component,data)}))}))])},ActiveReceiving=Object.freeze({__proto__:null,events:events$a}),unknown="unknown",EventConfiguration;!function(EventConfiguration){EventConfiguration[EventConfiguration.STOP=0]="STOP",EventConfiguration[EventConfiguration.NORMAL=1]="NORMAL",EventConfiguration[EventConfiguration.LOGGING=2]="LOGGING"}(EventConfiguration||(EventConfiguration={}));var eventConfig=Cell({}),makeEventLogger=function(eventName,initialTarget){var sequence=[],startTime=(new Date).getTime();return{logEventCut:function(_name,target,purpose){sequence.push({outcome:"cut",target:target,purpose:purpose})},logEventStopped:function(_name,target,purpose){sequence.push({outcome:"stopped",target:target,purpose:purpose})},logNoParent:function(_name,target,purpose){sequence.push({outcome:"no-parent",target:target,purpose:purpose})},logEventNoHandlers:function(_name,target){sequence.push({outcome:"no-handlers-left",target:target})},logEventResponse:function(_name,target,purpose){sequence.push({outcome:"response",purpose:purpose,target:target})},write:function(){var finishTime=(new Date).getTime();contains$1(["mousemove","mouseover","mouseout",systemInit()],eventName)||console.log(eventName,{event:eventName,time:finishTime-startTime,target:initialTarget.dom,sequence:map$2(sequence,(function(s){return contains$1(["cut","stopped","response"],s.outcome)?"{"+s.purpose+"} "+s.outcome+" at ("+element(s.target)+")":s.outcome}))})}}},processEvent=function(eventName,initialTarget,f){var status;switch(get$c(eventConfig.get(),eventName).orThunk((function(){var patterns=keys(eventConfig.get());return findMap(patterns,(function(p){return eventName.indexOf(p)>-1?Optional.some(eventConfig.get()[p]):Optional.none()}))})).getOr(EventConfiguration.NORMAL)){case EventConfiguration.NORMAL:return f(noLogger());case EventConfiguration.LOGGING:var logger=makeEventLogger(eventName,initialTarget),output=f(logger);return logger.write(),output;case EventConfiguration.STOP:return!0}},path=["alloy/data/Fields","alloy/debugging/Debugging"],getTrace=function(){var err=new Error;if(void 0!==err.stack){var lines=err.stack.split("\n");return find$2(lines,(function(line){return line.indexOf("alloy")>0&&!exists(path,(function(p){return line.indexOf(p)>-1}))})).getOr(unknown)}return unknown},ignoreEvent,monitorEvent=function(eventName,initialTarget,f){return processEvent(eventName,initialTarget,f)},noLogger=constant$1({logEventCut:noop,logEventStopped:noop,logNoParent:noop,logEventNoHandlers:noop,logEventResponse:noop,write:noop}),menuFields=constant$1([required$1("menu"),required$1("selectedMenu")]),itemFields=constant$1([required$1("item"),required$1("selectedItem")]);constant$1(objOf(itemFields().concat(menuFields())));var itemSchema$1=constant$1(objOf(itemFields())),_initSize=requiredObjOf("initSize",[required$1("numColumns"),required$1("numRows")]),itemMarkers=function(){return requiredOf("markers",itemSchema$1())},tieredMenuMarkers=function(){return requiredObjOf("markers",[required$1("backgroundMenu")].concat(menuFields()).concat(itemFields()))},markers=function(required){return requiredObjOf("markers",map$2(required,required$1))},onPresenceHandler=function(label,fieldName,presence){return getTrace(),field$2(fieldName,fieldName,presence,valueOf((function(f){return Result.value((function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return f.apply(void 0,args)}))})))},onHandler=function(fieldName){return onPresenceHandler("onHandler",fieldName,defaulted$1(noop))},onKeyboardHandler=function(fieldName){return onPresenceHandler("onKeyboardHandler",fieldName,defaulted$1(Optional.none))},onStrictHandler=function(fieldName){return onPresenceHandler("onHandler",fieldName,{tag:"required",process:{}})},onStrictKeyboardHandler=function(fieldName){return onPresenceHandler("onKeyboardHandler",fieldName,{tag:"required",process:{}})},output=function(name,value){return customField(name,constant$1(value))},snapshot=function(name){return customField(name,identity)},initSize=constant$1(_initSize),ReceivingSchema=[requiredOf("channels",setOf(Result.value,objOfOnly([onStrictHandler("onReceive"),defaulted("schema",anyValue())])))],Receiving=create$5({fields:ReceivingSchema,name:"receiving",active:ActiveReceiving}),SetupBehaviourCellState=function(initialState){var init;return{init:function(){var cell=Cell(initialState),get,set,clear,readState;return{get:function(){return cell.get()},set:function(newState){return cell.set(newState)},clear:function(){return cell.set(initialState)},readState:function(){return cell.get()}}}}},updateAriaState=function(component,toggleConfig,toggleState){var ariaInfo=toggleConfig.aria;ariaInfo.update(component,ariaInfo,toggleState.get())},updateClass=function(component,toggleConfig,toggleState){toggleConfig.toggleClass.each((function(toggleClass){toggleState.get()?add$1(component.element,toggleClass):remove$3(component.element,toggleClass)}))},toggle=function(component,toggleConfig,toggleState){set$6(component,toggleConfig,toggleState,!toggleState.get())},on$1=function(component,toggleConfig,toggleState){toggleState.set(!0),updateClass(component,toggleConfig,toggleState),updateAriaState(component,toggleConfig,toggleState)},off=function(component,toggleConfig,toggleState){toggleState.set(!1),updateClass(component,toggleConfig,toggleState),updateAriaState(component,toggleConfig,toggleState)},set$6=function(component,toggleConfig,toggleState,state){var action;(state?on$1:off)(component,toggleConfig,toggleState)},isOn=function(component,toggleConfig,toggleState){return toggleState.get()},onLoad$5=function(component,toggleConfig,toggleState){set$6(component,toggleConfig,toggleState,toggleConfig.selected)},ToggleApis=Object.freeze({__proto__:null,onLoad:onLoad$5,toggle:toggle,isOn:isOn,on:on$1,off:off,set:set$6}),exhibit$5=function(){return nu$3({})},events$9=function(toggleConfig,toggleState){var execute=executeEvent(toggleConfig,toggleState,toggle),load=loadEvent(toggleConfig,toggleState,onLoad$5);return derive$3(flatten([toggleConfig.toggleOnExecute?[execute]:[],[load]]))},ActiveToggle=Object.freeze({__proto__:null,exhibit:exhibit$5,events:events$9}),updatePressed=function(component,ariaInfo,status){set$8(component.element,"aria-pressed",status),ariaInfo.syncWithExpanded&&updateExpanded(component,ariaInfo,status)},updateSelected=function(component,ariaInfo,status){set$8(component.element,"aria-selected",status)},updateChecked=function(component,ariaInfo,status){set$8(component.element,"aria-checked",status)},updateExpanded=function(component,ariaInfo,status){set$8(component.element,"aria-expanded",status)},ToggleSchema=[defaulted("selected",!1),option("toggleClass"),defaulted("toggleOnExecute",!0),defaultedOf("aria",{mode:"none"},choose$1("mode",{pressed:[defaulted("syncWithExpanded",!1),output("update",updatePressed)],checked:[output("update",updateChecked)],expanded:[output("update",updateExpanded)],selected:[output("update",updateSelected)],none:[output("update",noop)]}))],Toggling=create$5({fields:ToggleSchema,name:"toggling",active:ActiveToggle,apis:ToggleApis,state:SetupBehaviourCellState(!1)}),format=function(command,update){return Receiving.config({channels:wrap(formatChanged,{onReceive:function(button,data){data.command===command&&update(button,data.state)}})})},orientation=function(onReceive){return Receiving.config({channels:wrap(orientationChanged,{onReceive:onReceive})})},receive=function(channel,onReceive){return{key:channel,value:{onReceive:onReceive}}},prefix$2="tinymce-mobile",resolve=function(p){return prefix$2+"-"+p},pointerEvents=function(){var onClick=function(component,simulatedEvent){simulatedEvent.stop(),emitExecute(component)};return[run(click(),onClick),run(tap(),onClick),cutter(touchstart()),cutter(mousedown())]},events$8=function(optAction){var executeHandler=function(action){return runOnExecute((function(component,simulatedEvent){action(component),simulatedEvent.stop()}))};return derive$3(flatten([optAction.map(executeHandler).toArray(),pointerEvents()]))},focus$2=function(component,focusConfig){focusConfig.ignore||(focus$3(component.element),focusConfig.onFocus(component))},blur=function(component,focusConfig){focusConfig.ignore||blur$1(component.element)},isFocused=function(component){return hasFocus(component.element)},FocusApis=Object.freeze({__proto__:null,focus:focus$2,blur:blur,isFocused:isFocused}),exhibit$4=function(base,focusConfig){var mod=focusConfig.ignore?{}:{attributes:{tabindex:"-1"}};return nu$3(mod)},events$7=function(focusConfig){return derive$3([run(focus$4(),(function(component,simulatedEvent){focus$2(component,focusConfig),simulatedEvent.stop()}))].concat(focusConfig.stopMousedown?[run(mousedown(),(function(_,simulatedEvent){simulatedEvent.event.prevent()}))]:[]))},ActiveFocus=Object.freeze({__proto__:null,exhibit:exhibit$4,events:events$7}),FocusSchema=[onHandler("onFocus"),defaulted("stopMousedown",!1),defaulted("ignore",!1)],Focusing=create$5({fields:FocusSchema,name:"focusing",active:ActiveFocus,apis:FocusApis}),isSupported=function(dom){return void 0!==dom.style&&isFunction(dom.style.getPropertyValue)},internalSet=function(dom,property,value){if(!isString(value))throw console.error("Invalid call to CSS.set. Property ",property,":: Value ",value,":: Element ",dom),new Error("CSS value must be a string: "+value);isSupported(dom)&&dom.style.setProperty(property,value)},internalRemove=function(dom,property){isSupported(dom)&&dom.style.removeProperty(property)},set$5=function(element,property,value){var dom=element.dom;internalSet(dom,property,value)},setAll=function(element,css){var dom=element.dom;each(css,(function(v,k){internalSet(dom,k,v)}))},get$8=function(element,property){var dom=element.dom,styles,r=window.getComputedStyle(dom).getPropertyValue(property);return""!==r||inBody(element)?r:getUnsafeProperty(dom,property)},getUnsafeProperty=function(dom,property){return isSupported(dom)?dom.style.getPropertyValue(property):""},getRaw=function(element,property){var dom=element.dom,raw=getUnsafeProperty(dom,property);return Optional.from(raw).filter((function(r){return r.length>0}))},remove$2=function(element,property){var dom=element.dom;internalRemove(dom,property),is(getOpt(element,"style").map(trim),"")&&remove$6(element,"style")},reflow=function(e){return e.dom.offsetWidth},Dimension=function(name,getOffset){var set,get=function(element){var r=getOffset(element);if(r<=0||null===r){var css=get$8(element,name);return parseFloat(css)||0}return r},getOuter,aggregate=function(element,properties){return foldl(properties,(function(acc,property){var val=get$8(element,property),value=void 0===val?0:parseInt(val,10);return isNaN(value)?acc:acc+value}),0)},max=function(element,value,properties){var cumulativeInclusions=aggregate(element,properties),absoluteMax;return value>cumulativeInclusions?value-cumulativeInclusions:0};return{set:function(element,h){if(!isNumber(h)&&!h.match(/^[0-9]+$/))throw new Error(name+".set accepts only positive integer values. Value was "+h);var dom=element.dom;isSupported(dom)&&(dom.style[name]=h+"px")},get:get,getOuter:get,aggregate:aggregate,max:max}},api$3=Dimension("height",(function(element){var dom=element.dom;return inBody(element)?dom.getBoundingClientRect().height:dom.offsetHeight})),get$7=function(element){return api$3.get(element)},ancestors$1=function(scope,predicate,isRoot){return filter$2(parents(scope,isRoot),predicate)},siblings$1=function(scope,predicate){return filter$2(siblings$2(scope),predicate)},all=function(selector){return all$2(selector)},ancestors=function(scope,selector,isRoot){return ancestors$1(scope,(function(e){return is$1(e,selector)}),isRoot)},siblings=function(scope,selector){return siblings$1(scope,(function(e){return is$1(e,selector)}))},descendants=function(scope,selector){return all$2(selector,scope)};function ClosestOrAncestor(is,ancestor,scope,a,isRoot){return is(scope,a)?Optional.some(scope):isFunction(isRoot)&&isRoot(scope)?Optional.none():ancestor(scope,a,isRoot)}var ancestor$1=function(scope,predicate,isRoot){for(var element=scope.dom,stop=isFunction(isRoot)?isRoot:never;element.parentNode;){element=element.parentNode;var el=SugarElement.fromDom(element);if(predicate(el))return Optional.some(el);if(stop(el))break}return Optional.none()},closest$2=function(scope,predicate,isRoot){var is;return ClosestOrAncestor((function(s,test){return test(s)}),ancestor$1,scope,predicate,isRoot)},descendant$1=function(scope,predicate){var descend=function(node){for(var i=0;i<node.childNodes.length;i++){var child_1=SugarElement.fromDom(node.childNodes[i]);if(predicate(child_1))return Optional.some(child_1);var res=descend(node.childNodes[i]);if(res.isSome())return res}return Optional.none()};return descend(scope.dom)},first$1=function(selector){return one(selector)},ancestor=function(scope,selector,isRoot){return ancestor$1(scope,(function(e){return is$1(e,selector)}),isRoot)},descendant=function(scope,selector){return one(selector,scope)},closest$1=function(scope,selector,isRoot){var is;return ClosestOrAncestor((function(element,selector){return is$1(element,selector)}),ancestor,scope,selector,isRoot)},BACKSPACE=[8],TAB=[9],ENTER=[13],ESCAPE=[27],SPACE=[32],LEFT=[37],UP=[38],RIGHT=[39],DOWN=[40],cyclePrev=function(values,index,predicate){var before=reverse(values.slice(0,index)),after=reverse(values.slice(index+1));return find$2(before.concat(after),predicate)},tryPrev=function(values,index,predicate){var before=reverse(values.slice(0,index));return find$2(before,predicate)},cycleNext=function(values,index,predicate){var before=values.slice(0,index),after=values.slice(index+1);return find$2(after.concat(before),predicate)},tryNext=function(values,index,predicate){var after=values.slice(index+1);return find$2(after,predicate)},inSet=function(keys){return function(event){var raw=event.raw;return contains$1(keys,raw.which)}},and=function(preds){return function(event){return forall(preds,(function(pred){return pred(event)}))}},isShift=function(event){var raw;return!0===event.raw.shiftKey},isControl=function(event){var raw;return!0===event.raw.ctrlKey},isNotShift=not(isShift),rule=function(matches,action){return{matches:matches,classification:action}},choose=function(transitions,event){var transition;return find$2(transitions,(function(t){return t.matches(event)})).map((function(t){return t.classification}))},cycleBy=function(value,delta,min,max){var r=value+delta;return r>max?min:r<min?max:r},clamp=function(value,min,max){return Math.min(Math.max(value,min),max)},dehighlightAllExcept=function(component,hConfig,hState,skip){var highlighted=descendants(component.element,"."+hConfig.highlightClass);each$1(highlighted,(function(h){exists(skip,(function(skipComp){return skipComp.element===h}))||(remove$3(h,hConfig.highlightClass),component.getSystem().getByDom(h).each((function(target){hConfig.onDehighlight(component,target),emit(target,dehighlight$1())})))}))},dehighlightAll=function(component,hConfig,hState){return dehighlightAllExcept(component,hConfig,hState,[])},dehighlight=function(component,hConfig,hState,target){isHighlighted(component,hConfig,hState,target)&&(remove$3(target.element,hConfig.highlightClass),hConfig.onDehighlight(component,target),emit(target,dehighlight$1()))},highlight=function(component,hConfig,hState,target){dehighlightAllExcept(component,hConfig,hState,[target]),isHighlighted(component,hConfig,hState,target)||(add$1(target.element,hConfig.highlightClass),hConfig.onHighlight(component,target),emit(target,highlight$1()))},highlightFirst=function(component,hConfig,hState){getFirst(component,hConfig).each((function(firstComp){highlight(component,hConfig,hState,firstComp)}))},highlightLast=function(component,hConfig,hState){getLast(component,hConfig).each((function(lastComp){highlight(component,hConfig,hState,lastComp)}))},highlightAt=function(component,hConfig,hState,index){getByIndex(component,hConfig,hState,index).fold((function(err){throw err}),(function(firstComp){highlight(component,hConfig,hState,firstComp)}))},highlightBy=function(component,hConfig,hState,predicate){var candidates=getCandidates(component,hConfig),targetComp;find$2(candidates,predicate).each((function(c){highlight(component,hConfig,hState,c)}))},isHighlighted=function(component,hConfig,hState,queryTarget){return has(queryTarget.element,hConfig.highlightClass)},getHighlighted=function(component,hConfig,_hState){return descendant(component.element,"."+hConfig.highlightClass).bind((function(e){return component.getSystem().getByDom(e).toOptional()}))},getByIndex=function(component,hConfig,hState,index){var items=descendants(component.element,"."+hConfig.itemClass);return Optional.from(items[index]).fold((function(){return Result.error(new Error("No element found with index "+index))}),component.getSystem().getByDom)},getFirst=function(component,hConfig,_hState){return descendant(component.element,"."+hConfig.itemClass).bind((function(e){return component.getSystem().getByDom(e).toOptional()}))},getLast=function(component,hConfig,_hState){var items=descendants(component.element,"."+hConfig.itemClass),last;return(items.length>0?Optional.some(items[items.length-1]):Optional.none()).bind((function(c){return component.getSystem().getByDom(c).toOptional()}))},getDelta=function(component,hConfig,hState,delta){var items=descendants(component.element,"."+hConfig.itemClass),current;return findIndex$1(items,(function(item){return has(item,hConfig.highlightClass)})).bind((function(selected){var dest=cycleBy(selected,delta,0,items.length-1);return component.getSystem().getByDom(items[dest]).toOptional()}))},getPrevious=function(component,hConfig,hState){return getDelta(component,hConfig,hState,-1)},getNext=function(component,hConfig,hState){return getDelta(component,hConfig,hState,1)},getCandidates=function(component,hConfig,_hState){var items=descendants(component.element,"."+hConfig.itemClass);return cat(map$2(items,(function(i){return component.getSystem().getByDom(i).toOptional()})))},HighlightApis=Object.freeze({__proto__:null,dehighlightAll:dehighlightAll,dehighlight:dehighlight,highlight:highlight,highlightFirst:highlightFirst,highlightLast:highlightLast,highlightAt:highlightAt,highlightBy:highlightBy,isHighlighted:isHighlighted,getHighlighted:getHighlighted,getFirst:getFirst,getLast:getLast,getPrevious:getPrevious,getNext:getNext,getCandidates:getCandidates}),HighlightSchema=[required$1("highlightClass"),required$1("itemClass"),onHandler("onHighlight"),onHandler("onDehighlight")],Highlighting=create$5({fields:HighlightSchema,name:"highlighting",apis:HighlightApis}),reportFocusShifting=function(component,prevFocus,newFocus){var noChange;prevFocus.exists((function(p){return newFocus.exists((function(n){return eq(n,p)}))}))||emitWith(component,focusShifted(),{prevFocus:prevFocus,newFocus:newFocus})},dom$2=function(){var get=function(component){return search(component.element)},set=function(component,focusee){var prevFocus=get(component);component.getSystem().triggerFocus(focusee,component.element);var newFocus=get(component);reportFocusShifting(component,prevFocus,newFocus)};return{get:get,set:set}},highlights=function(){var get=function(component){return Highlighting.getHighlighted(component).map((function(item){return item.element}))},set=function(component,element){var prevFocus=get(component);component.getSystem().getByDom(element).fold(noop,(function(item){Highlighting.highlight(component,item)}));var newFocus=get(component);reportFocusShifting(component,prevFocus,newFocus)};return{get:get,set:set}},FocusInsideModes;!function(FocusInsideModes){FocusInsideModes.OnFocusMode="onFocus",FocusInsideModes.OnEnterOrSpaceMode="onEnterOrSpace",FocusInsideModes.OnApiMode="onApi"}(FocusInsideModes||(FocusInsideModes={}));var typical=function(infoSchema,stateInit,getKeydownRules,getKeyupRules,optFocusIn){var schema,processKey=function(component,simulatedEvent,getRules,keyingConfig,keyingState){var rules=getRules(component,simulatedEvent,keyingConfig,keyingState);return choose(rules,simulatedEvent.event).bind((function(rule){return rule(component,simulatedEvent,keyingConfig,keyingState)}))},toEvents=function(keyingConfig,keyingState){var onFocusHandler=keyingConfig.focusInside!==FocusInsideModes.OnFocusMode?Optional.none():optFocusIn(keyingConfig).map((function(focusIn){return run(focus$4(),(function(component,simulatedEvent){focusIn(component,keyingConfig,keyingState),simulatedEvent.stop()}))})),tryGoInsideComponent=function(component,simulatedEvent){var isEnterOrSpace=inSet(SPACE.concat(ENTER))(simulatedEvent.event);keyingConfig.focusInside===FocusInsideModes.OnEnterOrSpaceMode&&isEnterOrSpace&&isSource(component,simulatedEvent)&&optFocusIn(keyingConfig).each((function(focusIn){focusIn(component,keyingConfig,keyingState),simulatedEvent.stop()}))},keyboardEvents=[run(keydown(),(function(component,simulatedEvent){processKey(component,simulatedEvent,getKeydownRules,keyingConfig,keyingState).fold((function(){tryGoInsideComponent(component,simulatedEvent)}),(function(_){simulatedEvent.stop()}))})),run(keyup(),(function(component,simulatedEvent){processKey(component,simulatedEvent,getKeyupRules,keyingConfig,keyingState).each((function(_){simulatedEvent.stop()}))}))];return derive$3(onFocusHandler.toArray().concat(keyboardEvents))},me={schema:function(){return infoSchema.concat([defaulted("focusManager",dom$2()),defaultedOf("focusInside","onFocus",valueOf((function(val){return contains$1(["onFocus","onEnterOrSpace","onApi"],val)?Result.value(val):Result.error("Invalid value for focusInside")}))),output("handler",me),output("state",stateInit),output("sendFocusIn",optFocusIn)])},processKey:processKey,toEvents:toEvents};return me},create$4=function(cyclicField){var schema=[option("onEscape"),option("onEnter"),defaulted("selector",'[data-alloy-tabstop="true"]:not(:disabled)'),defaulted("firstTabstop",0),defaulted("useTabstopAt",always),option("visibilitySelector")].concat([cyclicField]),isVisible=function(tabbingConfig,element){var target=tabbingConfig.visibilitySelector.bind((function(sel){return closest$1(element,sel)})).getOr(element);return get$7(target)>0},findInitial=function(component,tabbingConfig){var tabstops=descendants(component.element,tabbingConfig.selector),visibles=filter$2(tabstops,(function(elem){return isVisible(tabbingConfig,elem)}));return Optional.from(visibles[tabbingConfig.firstTabstop])},findCurrent=function(component,tabbingConfig){return tabbingConfig.focusManager.get(component).bind((function(elem){return closest$1(elem,tabbingConfig.selector)}))},isTabstop=function(tabbingConfig,element){return isVisible(tabbingConfig,element)&&tabbingConfig.useTabstopAt(element)},focusIn=function(component,tabbingConfig,_tabbingState){findInitial(component,tabbingConfig).each((function(target){tabbingConfig.focusManager.set(component,target)}))},goFromTabstop=function(component,tabstops,stopIndex,tabbingConfig,cycle){return cycle(tabstops,stopIndex,(function(elem){return isTabstop(tabbingConfig,elem)})).fold((function(){return tabbingConfig.cyclic?Optional.some(!0):Optional.none()}),(function(target){return tabbingConfig.focusManager.set(component,target),Optional.some(!0)}))},go=function(component,_simulatedEvent,tabbingConfig,cycle){var tabstops=descendants(component.element,tabbingConfig.selector);return findCurrent(component,tabbingConfig).bind((function(tabstop){var optStopIndex;return findIndex$1(tabstops,curry(eq,tabstop)).bind((function(stopIndex){return goFromTabstop(component,tabstops,stopIndex,tabbingConfig,cycle)}))}))},goBackwards=function(component,simulatedEvent,tabbingConfig){var navigate=tabbingConfig.cyclic?cyclePrev:tryPrev;return go(component,simulatedEvent,tabbingConfig,navigate)},goForwards=function(component,simulatedEvent,tabbingConfig){var navigate=tabbingConfig.cyclic?cycleNext:tryNext;return go(component,simulatedEvent,tabbingConfig,navigate)},execute=function(component,simulatedEvent,tabbingConfig){return tabbingConfig.onEnter.bind((function(f){return f(component,simulatedEvent)}))},exit=function(component,simulatedEvent,tabbingConfig){return tabbingConfig.onEscape.bind((function(f){return f(component,simulatedEvent)}))},getKeydownRules=constant$1([rule(and([isShift,inSet(TAB)]),goBackwards),rule(inSet(TAB),goForwards),rule(inSet(ESCAPE),exit),rule(and([isNotShift,inSet(ENTER)]),execute)]),getKeyupRules=constant$1([]);return typical(schema,NoState.init,getKeydownRules,getKeyupRules,(function(){return Optional.some(focusIn)}))},AcyclicType=create$4(customField("cyclic",never)),CyclicType=create$4(customField("cyclic",always)),inside=function(target){return"input"===name$1(target)&&"radio"!==get$b(target,"type")||"textarea"===name$1(target)},doDefaultExecute=function(component,_simulatedEvent,focused){return dispatch(component,focused,execute$5()),Optional.some(!0)},defaultExecute=function(component,simulatedEvent,focused){var isComplex;return inside(focused)&&inSet(SPACE)(simulatedEvent.event)?Optional.none():doDefaultExecute(component,simulatedEvent,focused)},stopEventForFirefox=function(_component,_simulatedEvent){return Optional.some(!0)},schema$f=[defaulted("execute",defaultExecute),defaulted("useSpace",!1),defaulted("useEnter",!0),defaulted("useControlEnter",!1),defaulted("useDown",!1)],execute$4=function(component,simulatedEvent,executeConfig){return executeConfig.execute(component,simulatedEvent,component.element)},getKeydownRules$5,getKeyupRules$5,ExecutionType=typical(schema$f,NoState.init,(function(component,_simulatedEvent,executeConfig,_executeState){var spaceExec=executeConfig.useSpace&&!inside(component.element)?SPACE:[],enterExec=executeConfig.useEnter?ENTER:[],downExec=executeConfig.useDown?DOWN:[],execKeys=spaceExec.concat(enterExec).concat(downExec);return[rule(inSet(execKeys),execute$4)].concat(executeConfig.useControlEnter?[rule(and([isControl,inSet(ENTER)]),execute$4)]:[])}),(function(component,_simulatedEvent,executeConfig,_executeState){return executeConfig.useSpace&&!inside(component.element)?[rule(inSet(SPACE),stopEventForFirefox)]:[]}),(function(){return Optional.none()})),singleton$1=function(doRevoke){var subject=Cell(Optional.none()),revoke=function(){return subject.get().each(doRevoke)},clear,isSet,get,set;return{clear:function(){revoke(),subject.set(Optional.none())},isSet:function(){return subject.get().isSome()},get:function(){return subject.get()},set:function(s){revoke(),subject.set(Optional.some(s))}}},destroyable=function(){return singleton$1((function(s){return s.destroy()}))},api$2=function(){var subject=destroyable(),run=function(f){return subject.get().each(f)};return __assign(__assign({},subject),{run:run})},value=function(){var subject=singleton$1(noop),on=function(f){return subject.get().each(f)};return __assign(__assign({},subject),{on:on})},flatgrid$1=function(){var dimensions=value(),setGridSize,getNumRows,getNumColumns;return nu$2({readState:function(){return dimensions.get().map((function(d){return{numRows:String(d.numRows),numColumns:String(d.numColumns)}})).getOr({numRows:"?",numColumns:"?"})},setGridSize:function(numRows,numColumns){dimensions.set({numRows:numRows,numColumns:numColumns})},getNumRows:function(){return dimensions.get().map((function(d){return d.numRows}))},getNumColumns:function(){return dimensions.get().map((function(d){return d.numColumns}))}})},init$5=function(spec){return spec.state(spec)},KeyingState=Object.freeze({__proto__:null,flatgrid:flatgrid$1,init:init$5}),onDirection=function(isLtr,isRtl){return function(element){return"rtl"===getDirection(element)?isRtl:isLtr}},getDirection=function(element){return"rtl"===get$8(element,"direction")?"rtl":"ltr"},useH=function(movement){return function(component,simulatedEvent,config,state){var move=movement(component.element);return use(move,component,simulatedEvent,config,state)}},west=function(moveLeft,moveRight){var movement=onDirection(moveLeft,moveRight);return useH(movement)},east=function(moveLeft,moveRight){var movement=onDirection(moveRight,moveLeft);return useH(movement)},useV=function(move){return function(component,simulatedEvent,config,state){return use(move,component,simulatedEvent,config,state)}},use=function(move,component,simulatedEvent,config,state){var outcome;return config.focusManager.get(component).bind((function(focused){return move(component.element,focused,config,state)})).map((function(newFocus){return config.focusManager.set(component,newFocus),!0}))},north=useV,south=useV,move$1=useV,isHidden=function(dom){return dom.offsetWidth<=0&&dom.offsetHeight<=0},isVisible=function(element){return!isHidden(element.dom)},locate=function(candidates,predicate){return findIndex$1(candidates,predicate).map((function(index){return{index:index,candidates:candidates}}))},locateVisible=function(container,current,selector){var predicate=function(x){return eq(x,current)},candidates=descendants(container,selector),visible=filter$2(candidates,isVisible);return locate(visible,predicate)},findIndex=function(elements,target){return findIndex$1(elements,(function(elem){return eq(target,elem)}))},withGrid=function(values,index,numCols,f){var oldRow,oldColumn;return f(Math.floor(index/numCols),index%numCols).bind((function(address){var newIndex=address.row*numCols+address.column;return newIndex>=0&&newIndex<values.length?Optional.some(values[newIndex]):Optional.none()}))},cycleHorizontal$1=function(values,index,numRows,numCols,delta){return withGrid(values,index,numCols,(function(oldRow,oldColumn){var onLastRow,colsInRow=oldRow===numRows-1?values.length-oldRow*numCols:numCols,newColumn=cycleBy(oldColumn,delta,0,colsInRow-1);return Optional.some({row:oldRow,column:newColumn})}))},cycleVertical$1=function(values,index,numRows,numCols,delta){return withGrid(values,index,numCols,(function(oldRow,oldColumn){var newRow=cycleBy(oldRow,delta,0,numRows-1),onLastRow,colsInRow=newRow===numRows-1?values.length-newRow*numCols:numCols,newCol=clamp(oldColumn,0,colsInRow-1);return Optional.some({row:newRow,column:newCol})}))},cycleRight$1=function(values,index,numRows,numCols){return cycleHorizontal$1(values,index,numRows,numCols,1)},cycleLeft$1=function(values,index,numRows,numCols){return cycleHorizontal$1(values,index,numRows,numCols,-1)},cycleUp$1=function(values,index,numRows,numCols){return cycleVertical$1(values,index,numRows,numCols,-1)},cycleDown$1=function(values,index,numRows,numCols){return cycleVertical$1(values,index,numRows,numCols,1)},schema$e=[required$1("selector"),defaulted("execute",defaultExecute),onKeyboardHandler("onEscape"),defaulted("captureTab",!1),initSize()],focusIn$3=function(component,gridConfig,_gridState){descendant(component.element,gridConfig.selector).each((function(first){gridConfig.focusManager.set(component,first)}))},findCurrent$1=function(component,gridConfig){return gridConfig.focusManager.get(component).bind((function(elem){return closest$1(elem,gridConfig.selector)}))},execute$3=function(component,simulatedEvent,gridConfig,_gridState){return findCurrent$1(component,gridConfig).bind((function(focused){return gridConfig.execute(component,simulatedEvent,focused)}))},doMove$2=function(cycle){return function(element,focused,gridConfig,gridState){return locateVisible(element,focused,gridConfig.selector).bind((function(identified){return cycle(identified.candidates,identified.index,gridState.getNumRows().getOr(gridConfig.initSize.numRows),gridState.getNumColumns().getOr(gridConfig.initSize.numColumns))}))}},handleTab=function(_component,_simulatedEvent,gridConfig){return gridConfig.captureTab?Optional.some(!0):Optional.none()},doEscape$1=function(component,simulatedEvent,gridConfig){return gridConfig.onEscape(component,simulatedEvent)},moveLeft$3=doMove$2(cycleLeft$1),moveRight$3=doMove$2(cycleRight$1),moveNorth$1=doMove$2(cycleUp$1),moveSouth$1=doMove$2(cycleDown$1),getKeydownRules$4=constant$1([rule(inSet(LEFT),west(moveLeft$3,moveRight$3)),rule(inSet(RIGHT),east(moveLeft$3,moveRight$3)),rule(inSet(UP),north(moveNorth$1)),rule(inSet(DOWN),south(moveSouth$1)),rule(and([isShift,inSet(TAB)]),handleTab),rule(and([isNotShift,inSet(TAB)]),handleTab),rule(inSet(ESCAPE),doEscape$1),rule(inSet(SPACE.concat(ENTER)),execute$3)]),getKeyupRules$4=constant$1([rule(inSet(SPACE),stopEventForFirefox)]),FlatgridType=typical(schema$e,flatgrid$1,getKeydownRules$4,getKeyupRules$4,(function(){return Optional.some(focusIn$3)})),horizontal=function(container,selector,current,delta){var isDisabledButton=function(candidate){return"button"===name$1(candidate)&&"disabled"===get$b(candidate,"disabled")},tryCycle=function(initial,index,candidates){var newIndex=cycleBy(index,delta,0,candidates.length-1);return newIndex===initial?Optional.none():isDisabledButton(candidates[newIndex])?tryCycle(initial,newIndex,candidates):Optional.from(candidates[newIndex])};return locateVisible(container,current,selector).bind((function(identified){var index=identified.index,candidates=identified.candidates;return tryCycle(index,index,candidates)}))},schema$d=[required$1("selector"),defaulted("getInitial",Optional.none),defaulted("execute",defaultExecute),onKeyboardHandler("onEscape"),defaulted("executeOnMove",!1),defaulted("allowVertical",!0)],findCurrent=function(component,flowConfig){return flowConfig.focusManager.get(component).bind((function(elem){return closest$1(elem,flowConfig.selector)}))},execute$2=function(component,simulatedEvent,flowConfig){return findCurrent(component,flowConfig).bind((function(focused){return flowConfig.execute(component,simulatedEvent,focused)}))},focusIn$2=function(component,flowConfig,_state){flowConfig.getInitial(component).orThunk((function(){return descendant(component.element,flowConfig.selector)})).each((function(first){flowConfig.focusManager.set(component,first)}))},moveLeft$2=function(element,focused,info){return horizontal(element,info.selector,focused,-1)},moveRight$2=function(element,focused,info){return horizontal(element,info.selector,focused,1)},doMove$1=function(movement){return function(component,simulatedEvent,flowConfig,flowState){return movement(component,simulatedEvent,flowConfig,flowState).bind((function(){return flowConfig.executeOnMove?execute$2(component,simulatedEvent,flowConfig):Optional.some(!0)}))}},doEscape=function(component,simulatedEvent,flowConfig){return flowConfig.onEscape(component,simulatedEvent)},getKeydownRules$3=function(_component,_se,flowConfig,_flowState){var westMovers=LEFT.concat(flowConfig.allowVertical?UP:[]),eastMovers=RIGHT.concat(flowConfig.allowVertical?DOWN:[]);return[rule(inSet(westMovers),doMove$1(west(moveLeft$2,moveRight$2))),rule(inSet(eastMovers),doMove$1(east(moveLeft$2,moveRight$2))),rule(inSet(ENTER),execute$2),rule(inSet(SPACE),execute$2),rule(inSet(ESCAPE),doEscape)]},getKeyupRules$3=constant$1([rule(inSet(SPACE),stopEventForFirefox)]),FlowType=typical(schema$d,NoState.init,getKeydownRules$3,getKeyupRules$3,(function(){return Optional.some(focusIn$2)})),toCell=function(matrix,rowIndex,columnIndex){return Optional.from(matrix[rowIndex]).bind((function(row){return Optional.from(row[columnIndex]).map((function(cell){return{rowIndex:rowIndex,columnIndex:columnIndex,cell:cell}}))}))},cycleHorizontal=function(matrix,rowIndex,startCol,deltaCol){var row,colsInRow=matrix[rowIndex].length,newColIndex=cycleBy(startCol,deltaCol,0,colsInRow-1);return toCell(matrix,rowIndex,newColIndex)},cycleVertical=function(matrix,colIndex,startRow,deltaRow){var nextRowIndex=cycleBy(startRow,deltaRow,0,matrix.length-1),colsInNextRow=matrix[nextRowIndex].length,nextColIndex=clamp(colIndex,0,colsInNextRow-1);return toCell(matrix,nextRowIndex,nextColIndex)},moveHorizontal=function(matrix,rowIndex,startCol,deltaCol){var row,colsInRow=matrix[rowIndex].length,newColIndex=clamp(startCol+deltaCol,0,colsInRow-1);return toCell(matrix,rowIndex,newColIndex)},moveVertical=function(matrix,colIndex,startRow,deltaRow){var nextRowIndex=clamp(startRow+deltaRow,0,matrix.length-1),colsInNextRow=matrix[nextRowIndex].length,nextColIndex=clamp(colIndex,0,colsInNextRow-1);return toCell(matrix,nextRowIndex,nextColIndex)},cycleRight=function(matrix,startRow,startCol){return cycleHorizontal(matrix,startRow,startCol,1)},cycleLeft=function(matrix,startRow,startCol){return cycleHorizontal(matrix,startRow,startCol,-1)},cycleUp=function(matrix,startRow,startCol){return cycleVertical(matrix,startCol,startRow,-1)},cycleDown=function(matrix,startRow,startCol){return cycleVertical(matrix,startCol,startRow,1)},moveLeft$1=function(matrix,startRow,startCol){return moveHorizontal(matrix,startRow,startCol,-1)},moveRight$1=function(matrix,startRow,startCol){return moveHorizontal(matrix,startRow,startCol,1)},moveUp$1=function(matrix,startRow,startCol){return moveVertical(matrix,startCol,startRow,-1)},moveDown$1=function(matrix,startRow,startCol){return moveVertical(matrix,startCol,startRow,1)},schema$c=[requiredObjOf("selectors",[required$1("row"),required$1("cell")]),defaulted("cycles",!0),defaulted("previousSelector",Optional.none),defaulted("execute",defaultExecute)],focusIn$1=function(component,matrixConfig,_state){var focused;matrixConfig.previousSelector(component).orThunk((function(){var selectors=matrixConfig.selectors;return descendant(component.element,selectors.cell)})).each((function(cell){matrixConfig.focusManager.set(component,cell)}))},execute$1=function(component,simulatedEvent,matrixConfig){return search(component.element).bind((function(focused){return matrixConfig.execute(component,simulatedEvent,focused)}))},toMatrix=function(rows,matrixConfig){return map$2(rows,(function(row){return descendants(row,matrixConfig.selectors.cell)}))},doMove=function(ifCycle,ifMove){return function(element,focused,matrixConfig){var move=matrixConfig.cycles?ifCycle:ifMove;return closest$1(focused,matrixConfig.selectors.row).bind((function(inRow){var cellsInRow=descendants(inRow,matrixConfig.selectors.cell);return findIndex(cellsInRow,focused).bind((function(colIndex){var allRows=descendants(element,matrixConfig.selectors.row);return findIndex(allRows,inRow).bind((function(rowIndex){var matrix=toMatrix(allRows,matrixConfig);return move(matrix,rowIndex,colIndex).map((function(next){return next.cell}))}))}))}))}},moveLeft=doMove(cycleLeft,moveLeft$1),moveRight=doMove(cycleRight,moveRight$1),moveNorth=doMove(cycleUp,moveUp$1),moveSouth=doMove(cycleDown,moveDown$1),getKeydownRules$2=constant$1([rule(inSet(LEFT),west(moveLeft,moveRight)),rule(inSet(RIGHT),east(moveLeft,moveRight)),rule(inSet(UP),north(moveNorth)),rule(inSet(DOWN),south(moveSouth)),rule(inSet(SPACE.concat(ENTER)),execute$1)]),getKeyupRules$2=constant$1([rule(inSet(SPACE),stopEventForFirefox)]),MatrixType=typical(schema$c,NoState.init,getKeydownRules$2,getKeyupRules$2,(function(){return Optional.some(focusIn$1)})),schema$b=[required$1("selector"),defaulted("execute",defaultExecute),defaulted("moveOnTab",!1)],execute=function(component,simulatedEvent,menuConfig){return menuConfig.focusManager.get(component).bind((function(focused){return menuConfig.execute(component,simulatedEvent,focused)}))},focusIn=function(component,menuConfig,_state){descendant(component.element,menuConfig.selector).each((function(first){menuConfig.focusManager.set(component,first)}))},moveUp=function(element,focused,info){return horizontal(element,info.selector,focused,-1)},moveDown=function(element,focused,info){return horizontal(element,info.selector,focused,1)},fireShiftTab=function(component,simulatedEvent,menuConfig,menuState){return menuConfig.moveOnTab?move$1(moveUp)(component,simulatedEvent,menuConfig,menuState):Optional.none()},fireTab=function(component,simulatedEvent,menuConfig,menuState){return menuConfig.moveOnTab?move$1(moveDown)(component,simulatedEvent,menuConfig,menuState):Optional.none()},getKeydownRules$1=constant$1([rule(inSet(UP),move$1(moveUp)),rule(inSet(DOWN),move$1(moveDown)),rule(and([isShift,inSet(TAB)]),fireShiftTab),rule(and([isNotShift,inSet(TAB)]),fireTab),rule(inSet(ENTER),execute),rule(inSet(SPACE),execute)]),getKeyupRules$1=constant$1([rule(inSet(SPACE),stopEventForFirefox)]),MenuType=typical(schema$b,NoState.init,getKeydownRules$1,getKeyupRules$1,(function(){return Optional.some(focusIn)})),schema$a=[onKeyboardHandler("onSpace"),onKeyboardHandler("onEnter"),onKeyboardHandler("onShiftEnter"),onKeyboardHandler("onLeft"),onKeyboardHandler("onRight"),onKeyboardHandler("onTab"),onKeyboardHandler("onShiftTab"),onKeyboardHandler("onUp"),onKeyboardHandler("onDown"),onKeyboardHandler("onEscape"),defaulted("stopSpaceKeyup",!1),option("focusIn")],getKeydownRules,getKeyupRules,SpecialType=typical(schema$a,NoState.init,(function(component,simulatedEvent,specialInfo){return[rule(inSet(SPACE),specialInfo.onSpace),rule(and([isNotShift,inSet(ENTER)]),specialInfo.onEnter),rule(and([isShift,inSet(ENTER)]),specialInfo.onShiftEnter),rule(and([isShift,inSet(TAB)]),specialInfo.onShiftTab),rule(and([isNotShift,inSet(TAB)]),specialInfo.onTab),rule(inSet(UP),specialInfo.onUp),rule(inSet(DOWN),specialInfo.onDown),rule(inSet(LEFT),specialInfo.onLeft),rule(inSet(RIGHT),specialInfo.onRight),rule(inSet(SPACE),specialInfo.onSpace),rule(inSet(ESCAPE),specialInfo.onEscape)]}),(function(component,simulatedEvent,specialInfo){return specialInfo.stopSpaceKeyup?[rule(inSet(SPACE),stopEventForFirefox)]:[]}),(function(specialInfo){return specialInfo.focusIn})),acyclic=AcyclicType.schema(),cyclic=CyclicType.schema(),flow=FlowType.schema(),flatgrid=FlatgridType.schema(),matrix=MatrixType.schema(),execution=ExecutionType.schema(),menu=MenuType.schema(),special=SpecialType.schema(),KeyboardBranches,isFlatgridState=function(keyState){return hasNonNullableKey(keyState,"setGridSize")},Keying=createModes({branchKey:"mode",branches:Object.freeze({__proto__:null,acyclic:acyclic,cyclic:cyclic,flow:flow,flatgrid:flatgrid,matrix:matrix,execution:execution,menu:menu,special:special}),name:"keying",active:{events:function(keyingConfig,keyingState){var handler;return keyingConfig.handler.toEvents(keyingConfig,keyingState)}},apis:{focusIn:function(component,keyConfig,keyState){keyConfig.sendFocusIn(keyConfig).fold((function(){component.getSystem().triggerFocus(component.element,component.element)}),(function(sendFocusIn){sendFocusIn(component,keyConfig,keyState)}))},setGridSize:function(component,keyConfig,keyState,numRows,numColumns){isFlatgridState(keyState)?keyState.setGridSize(numRows,numColumns):console.error("Layout does not support setGridSize")}},state:KeyingState}),field$1=function(name,forbidden){return defaultedObjOf(name,{},map$2(forbidden,(function(f){return forbid(f.name(),"Cannot configure "+f.name()+" for "+name)})).concat([customField("dump",identity)]))},get$6=function(data){return data.dump},augment=function(data,original){return __assign(__assign({},derive$2(original)),data.dump)},SketchBehaviours_field=field$1,SketchBehaviours_augment=augment,SketchBehaviours_get=get$6,_placeholder="placeholder",adt$5=Adt_generate([{single:["required","valueThunk"]},{multiple:["required","valueThunks"]}]),isSubstituted=function(spec){return has$2(spec,"uiType")},subPlaceholder=function(owner,detail,compSpec,placeholders){return owner.exists((function(o){return o!==compSpec.owner}))?adt$5.single(!0,constant$1(compSpec)):get$c(placeholders,compSpec.name).fold((function(){throw new Error("Unknown placeholder component: "+compSpec.name+"\nKnown: ["+keys(placeholders)+"]\nNamespace: "+owner.getOr("none")+"\nSpec: "+JSON.stringify(compSpec,null,2))}),(function(newSpec){return newSpec.replace()}))},scan=function(owner,detail,compSpec,placeholders){return isSubstituted(compSpec)&&compSpec.uiType===_placeholder?subPlaceholder(owner,detail,compSpec,placeholders):adt$5.single(!1,constant$1(compSpec))},substitute=function(owner,detail,compSpec,placeholders){var base;return scan(owner,detail,compSpec,placeholders).fold((function(req,valueThunk){var value=isSubstituted(compSpec)?valueThunk(detail,compSpec.config,compSpec.validated):valueThunk(detail),childSpecs=get$c(value,"components").getOr([]),substituted=bind$3(childSpecs,(function(c){return substitute(owner,detail,c,placeholders)}));return[__assign(__assign({},value),{components:substituted})]}),(function(req,valuesThunk){if(isSubstituted(compSpec)){var values=valuesThunk(detail,compSpec.config,compSpec.validated),preprocessor;return compSpec.validated.preprocess.getOr(identity)(values)}return valuesThunk(detail)}))},substituteAll=function(owner,detail,components,placeholders){return bind$3(components,(function(c){return substitute(owner,detail,c,placeholders)}))},oneReplace=function(label,replacements){var called=!1,used=function(){return called},replace=function(){if(called)throw new Error("Trying to use the same placeholder more than once: "+label);return called=!0,replacements},required=function(){return replacements.fold((function(req,_){return req}),(function(req,_){return req}))};return{name:constant$1(label),required:required,used:used,replace:replace}},substitutePlaces=function(owner,detail,components,placeholders){var ps=map$1(placeholders,(function(ph,name){return oneReplace(name,ph)})),outcome=substituteAll(owner,detail,components,ps);return each(ps,(function(p){if(!1===p.used()&&p.required())throw new Error("Placeholder: "+p.name()+" was not found in components list\nNamespace: "+owner.getOr("none")+"\nComponents: "+JSON.stringify(detail.components,null,2))})),outcome},single$2=adt$5.single,multiple=adt$5.multiple,placeholder=constant$1(_placeholder),unique=0,generate$4=function(prefix){var date,time=(new Date).getTime(),random;return prefix+"_"+Math.floor(1e9*Math.random())+ ++unique+String(time)},adt$4=Adt_generate([{required:["data"]},{external:["data"]},{optional:["data"]},{group:["data"]}]),fFactory=defaulted("factory",{sketch:identity}),fSchema=defaulted("schema",[]),fName=required$1("name"),fPname=field$2("pname","pname",defaultedThunk((function(typeSpec){return"<alloy."+generate$4(typeSpec.name)+">"})),anyValue()),fGroupSchema=customField("schema",(function(){return[option("preprocess")]})),fDefaults=defaulted("defaults",constant$1({})),fOverrides=defaulted("overrides",constant$1({})),requiredSpec=objOf([fFactory,fSchema,fName,fPname,fDefaults,fOverrides]),externalSpec=objOf([fFactory,fSchema,fName,fDefaults,fOverrides]),optionalSpec=objOf([fFactory,fSchema,fName,fPname,fDefaults,fOverrides]),groupSpec=objOf([fFactory,fGroupSchema,fName,required$1("unit"),fPname,fDefaults,fOverrides]),asNamedPart=function(part){return part.fold(Optional.some,Optional.none,Optional.some,Optional.some)},name=function(part){var get=function(data){return data.name};return part.fold(get,get,get,get)},convert$1=function(adtConstructor,partSchema){return function(spec){var data=asRawOrDie$1("Converting part type",partSchema,spec);return adtConstructor(data)}},required=convert$1(adt$4.required,requiredSpec);convert$1(adt$4.external,externalSpec);var optional=convert$1(adt$4.optional,optionalSpec),group=convert$1(adt$4.group,groupSpec),original=constant$1("entirety"),combine$2=function(detail,data,partSpec,partValidated){return deepMerge(data.defaults(detail,partSpec,partValidated),partSpec,{uid:detail.partUids[data.name]},data.overrides(detail,partSpec,partValidated))},subs=function(owner,detail,parts){var internals={},externals={};return each$1(parts,(function(part){part.fold((function(data){internals[data.pname]=single$2(!0,(function(detail,partSpec,partValidated){return data.factory.sketch(combine$2(detail,data,partSpec,partValidated))}))}),(function(data){var partSpec=detail.parts[data.name];externals[data.name]=constant$1(data.factory.sketch(combine$2(detail,data,partSpec[original()]),partSpec))}),(function(data){internals[data.pname]=single$2(!1,(function(detail,partSpec,partValidated){return data.factory.sketch(combine$2(detail,data,partSpec,partValidated))}))}),(function(data){internals[data.pname]=multiple(!0,(function(detail,_partSpec,_partValidated){var units=detail[data.name];return map$2(units,(function(u){return data.factory.sketch(deepMerge(data.defaults(detail,u,_partValidated),u,data.overrides(detail,u)))}))}))}))})),{internals:constant$1(internals),externals:constant$1(externals)}},generate$3=function(owner,parts){var r={};return each$1(parts,(function(part){asNamedPart(part).each((function(np){var g=doGenerateOne(owner,np.pname);r[np.name]=function(config){var validated=asRawOrDie$1("Part: "+np.name+" in "+owner,objOf(np.schema),config);return __assign(__assign({},g),{config:config,validated:validated})}}))})),r},doGenerateOne=function(owner,pname){return{uiType:placeholder(),owner:owner,name:pname}},generateOne=function(owner,pname,config){return{uiType:placeholder(),owner:owner,name:pname,config:config,validated:{}}},schemas=function(parts){return bind$3(parts,(function(part){return part.fold(Optional.none,Optional.some,Optional.none,Optional.none).map((function(data){return requiredObjOf(data.name,data.schema.concat([snapshot(original())]))})).toArray()}))},names=function(parts){return map$2(parts,name)},substitutes=function(owner,detail,parts){return subs(owner,detail,parts)},components=function(owner,detail,internals){return substitutePlaces(Optional.some(owner),detail,detail.components,internals)},getPart=function(component,detail,partKey){var uid=detail.partUids[partKey];return component.getSystem().getByUid(uid).toOptional()},getPartOrDie=function(component,detail,partKey){return getPart(component,detail,partKey).getOrDie("Could not find part: "+partKey)},getAllParts=function(component,detail){var system=component.getSystem();return map$1(detail.partUids,(function(pUid,_k){return constant$1(system.getByUid(pUid))}))},defaultUids=function(baseUid,partTypes){var partNames=names(partTypes);return wrapAll(map$2(partNames,(function(pn){return{key:pn,value:baseUid+"-"+pn}})))},defaultUidsSchema=function(partTypes){return field$2("partUids","partUids",mergeWithThunk((function(spec){return defaultUids(spec.uid,partTypes)})),anyValue())},premadeTag=generate$4("alloy-premade"),premade$1=function(comp){return wrap(premadeTag,comp)},getPremade=function(spec){return get$c(spec,premadeTag)},makeApi=function(f){return markAsSketchApi((function(component){for(var rest=[],_i=1;_i<arguments.length;_i++)rest[_i-1]=arguments[_i];return f.apply(void 0,__spreadArray([component.getApis(),component],rest,!1))}),f)},prefix$1=constant$1("alloy-id-"),idAttr$1=constant$1("data-alloy-id"),prefix=prefix$1(),idAttr=idAttr$1(),write=function(label,elem){var id=generate$4(prefix+label);return writeOnly(elem,id),id},writeOnly=function(elem,uid){Object.defineProperty(elem.dom,idAttr,{value:uid,writable:!0})},read=function(elem){var id=isElement(elem)?elem.dom[idAttr]:null;return Optional.from(id)},generate$2=function(prefix){return generate$4(prefix)},base=function(partSchemas,partUidsSchemas){var ps;return(partSchemas.length>0?[requiredObjOf("parts",partSchemas)]:[]).concat([required$1("uid"),defaulted("dom",{}),defaulted("components",[]),snapshot("originalSpec"),defaulted("debug.sketcher",{})]).concat(partUidsSchemas)},asRawOrDie=function(label,schema,spec,partSchemas,partUidsSchemas){var baseS=base(partSchemas,partUidsSchemas);return asRawOrDie$1(label+" [SpecSchema]",objOfOnly(baseS.concat(schema)),spec)},single$1=function(owner,schema,factory,spec){var specWithUid=supplyUid(spec),detail;return factory(asRawOrDie(owner,schema,specWithUid,[],[]),specWithUid)},composite$1=function(owner,schema,partTypes,factory,spec){var specWithUid=supplyUid(spec),partSchemas=schemas(partTypes),partUidsSchema=defaultUidsSchema(partTypes),detail=asRawOrDie(owner,schema,specWithUid,partSchemas,[partUidsSchema]),subs=substitutes(owner,detail,partTypes),components$1;return factory(detail,components(owner,detail,subs.internals()),specWithUid,subs.externals())},hasUid=function(spec){return has$2(spec,"uid")},supplyUid=function(spec){return hasUid(spec)?spec:__assign(__assign({},spec),{uid:generate$2("uid")})},isSketchSpec$1=function(spec){return void 0!==spec.uid},singleSchema=objOfOnly([required$1("name"),required$1("factory"),required$1("configFields"),defaulted("apis",{}),defaulted("extraApis",{})]),compositeSchema=objOfOnly([required$1("name"),required$1("factory"),required$1("configFields"),required$1("partFields"),defaulted("apis",{}),defaulted("extraApis",{})]),single=function(rawConfig){var config=asRawOrDie$1("Sketcher for "+rawConfig.name,singleSchema,rawConfig),sketch=function(spec){return single$1(config.name,config.configFields,config.factory,spec)},apis=map$1(config.apis,makeApi),extraApis=map$1(config.extraApis,(function(f,k){return markAsExtraApi(f,k)}));return __assign(__assign({name:config.name,configFields:config.configFields,sketch:sketch},apis),extraApis)},composite=function(rawConfig){var config=asRawOrDie$1("Sketcher for "+rawConfig.name,compositeSchema,rawConfig),sketch=function(spec){return composite$1(config.name,config.configFields,config.partFields,config.factory,spec)},parts=generate$3(config.name,config.partFields),apis=map$1(config.apis,makeApi),extraApis=map$1(config.extraApis,(function(f,k){return markAsExtraApi(f,k)}));return __assign(__assign({name:config.name,partFields:config.partFields,configFields:config.configFields,sketch:sketch,parts:parts},apis),extraApis)},factory$5=function(detail){var events=events$8(detail.action),tag=detail.dom.tag,lookupAttr=function(attr){return get$c(detail.dom,"attributes").bind((function(attrs){return get$c(attrs,attr)}))},getModAttributes=function(){if("button"===tag){var type=lookupAttr("type").getOr("button"),roleAttrs=lookupAttr("role").map((function(role){return{role:role}})).getOr({});return __assign({type:type},roleAttrs)}var role;return{role:lookupAttr("role").getOr("button")}};return{uid:detail.uid,dom:detail.dom,components:detail.components,events:events,behaviours:SketchBehaviours_augment(detail.buttonBehaviours,[Focusing.config({}),Keying.config({mode:"execution",useSpace:!0,useEnter:!0})]),domModification:{attributes:getModAttributes()},eventOrder:detail.eventOrder}},Button=single({name:"Button",factory:factory$5,configFields:[defaulted("uid",void 0),required$1("dom"),defaulted("components",[]),SketchBehaviours_field("buttonBehaviours",[Focusing,Keying]),option("action"),option("role"),defaulted("eventOrder",{})]}),exhibit$3=function(){return nu$3({styles:{"-webkit-user-select":"none","user-select":"none","-ms-user-select":"none","-moz-user-select":"-moz-none"},attributes:{unselectable:"on"}})},events$6=function(){return derive$3([abort(selectstart(),always)])},ActiveUnselecting=Object.freeze({__proto__:null,events:events$6,exhibit:exhibit$3}),Unselecting=create$5({fields:[],name:"unselecting",active:ActiveUnselecting}),getAttrs$1=function(elem){var attributes=void 0!==elem.dom.attributes?elem.dom.attributes:[];return foldl(attributes,(function(b,attr){var _a;return"class"===attr.name?b:__assign(__assign({},b),((_a={})[attr.name]=attr.value,_a))}),{})},getClasses=function(elem){return Array.prototype.slice.call(elem.dom.classList,0)},fromHtml=function(html){var elem=SugarElement.fromHtml(html),children$1=children(elem),attrs=getAttrs$1(elem),classes=getClasses(elem),contents=0===children$1.length?{}:{innerHtml:get$9(elem)};return __assign({tag:name$1(elem),classes:classes,attributes:attrs},contents)},dom$1=function(rawHtml){var html=supplant(rawHtml,{prefix:prefix$2});return fromHtml(html)},spec=function(rawHtml){return{dom:dom$1(rawHtml)}},forToolbarCommand=function(editor,command){return forToolbar(command,(function(){editor.execCommand(command)}),{},editor)},getToggleBehaviours=function(command){return derive$2([Toggling.config({toggleClass:resolve("toolbar-button-selected"),toggleOnExecute:!1,aria:{mode:"pressed"}}),format(command,(function(button,status){var toggle;(status?Toggling.on:Toggling.off)(button)}))])},forToolbarStateCommand=function(editor,command){var extraBehaviours=getToggleBehaviours(command);return forToolbar(command,(function(){editor.execCommand(command)}),extraBehaviours,editor)},forToolbarStateAction=function(editor,clazz,command,action){var extraBehaviours=getToggleBehaviours(command);return forToolbar(clazz,action,extraBehaviours,editor)},getToolbarIconButton=function(clazz,editor){var icons=editor.ui.registry.getAll().icons,optOxideIcon;return Optional.from(icons[clazz]).fold((function(){return dom$1('<span class="${prefix}-toolbar-button ${prefix}-toolbar-group-item ${prefix}-icon-'+clazz+' ${prefix}-icon"></span>')}),(function(icon){return dom$1('<span class="${prefix}-toolbar-button ${prefix}-toolbar-group-item">'+icon+"</span>")}))},forToolbar=function(clazz,action,extraBehaviours,editor){return Button.sketch({dom:getToolbarIconButton(clazz,editor),action:action,buttonBehaviours:deepMerge(derive$2([Unselecting.config({})]),extraBehaviours)})},labelPart=optional({schema:[required$1("dom")],name:"label"}),edgePart=function(name){return optional({name:name+"-edge",overrides:function(detail){var action;return detail.model.manager.edgeActions[name].fold((function(){return{}}),(function(a){return{events:derive$3([runActionExtra(touchstart(),(function(comp,se,d){return a(comp,d)}),[detail]),runActionExtra(mousedown(),(function(comp,se,d){return a(comp,d)}),[detail]),runActionExtra(mousemove(),(function(comp,se,det){det.mouseIsDown.get()&&a(comp,det)}),[detail])])}}))}})},tlEdgePart=edgePart("top-left"),tedgePart=edgePart("top"),trEdgePart=edgePart("top-right"),redgePart=edgePart("right"),brEdgePart=edgePart("bottom-right"),bedgePart=edgePart("bottom"),blEdgePart=edgePart("bottom-left"),ledgePart,thumbPart,spectrumPart,SliderParts=[labelPart,edgePart("left"),redgePart,tedgePart,bedgePart,tlEdgePart,trEdgePart,blEdgePart,brEdgePart,required({name:"thumb",defaults:constant$1({dom:{styles:{position:"absolute"}}}),overrides:function(detail){return{events:derive$3([redirectToPart(touchstart(),detail,"spectrum"),redirectToPart(touchmove(),detail,"spectrum"),redirectToPart(touchend(),detail,"spectrum"),redirectToPart(mousedown(),detail,"spectrum"),redirectToPart(mousemove(),detail,"spectrum"),redirectToPart(mouseup(),detail,"spectrum")])}}}),required({schema:[customField("mouseIsDown",(function(){return Cell(!1)}))],name:"spectrum",overrides:function(detail){var modelDetail,model=detail.model.manager,setValueFrom=function(component,simulatedEvent){return model.getValueFromEvent(simulatedEvent).map((function(value){return model.setValueFrom(component,detail,value)}))};return{behaviours:derive$2([Keying.config({mode:"special",onLeft:function(spectrum){return model.onLeft(spectrum,detail)},onRight:function(spectrum){return model.onRight(spectrum,detail)},onUp:function(spectrum){return model.onUp(spectrum,detail)},onDown:function(spectrum){return model.onDown(spectrum,detail)}}),Focusing.config({})]),events:derive$3([run(touchstart(),setValueFrom),run(touchmove(),setValueFrom),run(mousedown(),setValueFrom),run(mousemove(),(function(spectrum,se){detail.mouseIsDown.get()&&setValueFrom(spectrum,se)}))])}}})],onLoad$4=function(component,repConfig,repState){repConfig.store.manager.onLoad(component,repConfig,repState)},onUnload$2=function(component,repConfig,repState){repConfig.store.manager.onUnload(component,repConfig,repState)},setValue$3=function(component,repConfig,repState,data){repConfig.store.manager.setValue(component,repConfig,repState,data)},getValue$4=function(component,repConfig,repState){return repConfig.store.manager.getValue(component,repConfig,repState)},getState$1=function(component,repConfig,repState){return repState},RepresentApis=Object.freeze({__proto__:null,onLoad:onLoad$4,onUnload:onUnload$2,setValue:setValue$3,getValue:getValue$4,getState:getState$1}),events$5=function(repConfig,repState){var es=repConfig.resetOnDom?[runOnAttached((function(comp,_se){onLoad$4(comp,repConfig,repState)})),runOnDetached((function(comp,_se){onUnload$2(comp,repConfig,repState)}))]:[loadEvent(repConfig,repState,onLoad$4)];return derive$3(es)},ActiveRepresenting=Object.freeze({__proto__:null,events:events$5}),memory=function(){var data=Cell(null),readState=function(){return{mode:"memory",value:data.get()}},isNotSet=function(){return null===data.get()},clear=function(){data.set(null)};return nu$2({set:data.set,get:data.get,isNotSet:isNotSet,clear:clear,readState:readState})},manual=function(){var readState;return nu$2({readState:noop})},dataset=function(){var dataByValue=Cell({}),dataByText=Cell({}),readState,clear,lookup,update;return nu$2({readState:function(){return{mode:"dataset",dataByValue:dataByValue.get(),dataByText:dataByText.get()}},lookup:function(itemString){return get$c(dataByValue.get(),itemString).orThunk((function(){return get$c(dataByText.get(),itemString)}))},update:function(items){var currentDataByValue=dataByValue.get(),currentDataByText=dataByText.get(),newDataByValue={},newDataByText={};each$1(items,(function(item){newDataByValue[item.value]=item,get$c(item,"meta").each((function(meta){get$c(meta,"text").each((function(text){newDataByText[text]=item}))}))})),dataByValue.set(__assign(__assign({},currentDataByValue),newDataByValue)),dataByText.set(__assign(__assign({},currentDataByText),newDataByText))},clear:function(){dataByValue.set({}),dataByText.set({})}})},init$4=function(spec){return spec.store.manager.state(spec)},RepresentState=Object.freeze({__proto__:null,memory:memory,dataset:dataset,manual:manual,init:init$4}),setValue$2=function(component,repConfig,repState,data){var store=repConfig.store;repState.update([data]),store.setValue(component,data),repConfig.onSetValue(component,data)},getValue$3=function(component,repConfig,repState){var store=repConfig.store,key=store.getDataKey(component);return repState.lookup(key).getOrThunk((function(){return store.getFallbackEntry(key)}))},onLoad$3=function(component,repConfig,repState){var store;repConfig.store.initialValue.each((function(data){setValue$2(component,repConfig,repState,data)}))},onUnload$1=function(component,repConfig,repState){repState.clear()},DatasetStore=[option("initialValue"),required$1("getFallbackEntry"),required$1("getDataKey"),required$1("setValue"),output("manager",{setValue:setValue$2,getValue:getValue$3,onLoad:onLoad$3,onUnload:onUnload$1,state:dataset})],getValue$2=function(component,repConfig,_repState){return repConfig.store.getValue(component)},setValue$1=function(component,repConfig,_repState,data){repConfig.store.setValue(component,data),repConfig.onSetValue(component,data)},onLoad$2=function(component,repConfig,_repState){repConfig.store.initialValue.each((function(data){repConfig.store.setValue(component,data)}))},ManualStore=[required$1("getValue"),defaulted("setValue",noop),option("initialValue"),output("manager",{setValue:setValue$1,getValue:getValue$2,onLoad:onLoad$2,onUnload:noop,state:NoState.init})],setValue=function(component,repConfig,repState,data){repState.set(data),repConfig.onSetValue(component,data)},getValue$1=function(component,repConfig,repState){return repState.get()},onLoad$1=function(component,repConfig,repState){repConfig.store.initialValue.each((function(initVal){repState.isNotSet()&&repState.set(initVal)}))},onUnload=function(component,repConfig,repState){repState.clear()},MemoryStore=[option("initialValue"),output("manager",{setValue:setValue,getValue:getValue$1,onLoad:onLoad$1,onUnload:onUnload,state:memory})],RepresentSchema=[defaultedOf("store",{mode:"memory"},choose$1("mode",{memory:MemoryStore,manual:ManualStore,dataset:DatasetStore})),onHandler("onSetValue"),defaulted("resetOnDom",!1)],Representing=create$5({fields:RepresentSchema,name:"representing",active:ActiveRepresenting,apis:RepresentApis,extra:{setValueFrom:function(component,source){var value=Representing.getValue(source);Representing.setValue(component,value)}},state:RepresentState}),api$1=Dimension("width",(function(element){return element.dom.offsetWidth})),set$4=function(element,h){return api$1.set(element,h)},get$5=function(element){return api$1.get(element)},r$1=function(left,top){var translate;return{left:left,top:top,translate:function(x,y){return r$1(left+x,top+y)}}},SugarPosition=r$1,_sliderChangeEvent,sliderChangeEvent=constant$1("slider.change.value"),isTouchEvent=function(evt){return-1!==evt.type.indexOf("touch")},getEventSource=function(simulatedEvent){var evt=simulatedEvent.event.raw;if(isTouchEvent(evt)){var touchEvent=evt;return void 0!==touchEvent.touches&&1===touchEvent.touches.length?Optional.some(touchEvent.touches[0]).map((function(t){return SugarPosition(t.clientX,t.clientY)})):Optional.none()}var mouseEvent=evt;return void 0!==mouseEvent.clientX?Optional.some(mouseEvent).map((function(me){return SugarPosition(me.clientX,me.clientY)})):Optional.none()},t="top",r="right",b="bottom",l="left",minX=function(detail){return detail.model.minX},minY=function(detail){return detail.model.minY},min1X=function(detail){return detail.model.minX-1},min1Y=function(detail){return detail.model.minY-1},maxX=function(detail){return detail.model.maxX},maxY=function(detail){return detail.model.maxY},max1X=function(detail){return detail.model.maxX+1},max1Y=function(detail){return detail.model.maxY+1},range$1=function(detail,max,min){return max(detail)-min(detail)},xRange=function(detail){return range$1(detail,maxX,minX)},yRange=function(detail){return range$1(detail,maxY,minY)},halfX=function(detail){return xRange(detail)/2},halfY=function(detail){return yRange(detail)/2},step=function(detail){return detail.stepSize},snap=function(detail){return detail.snapToGrid},snapStart=function(detail){return detail.snapStart},rounded=function(detail){return detail.rounded},hasEdge=function(detail,edgeName){return void 0!==detail[edgeName+"-edge"]},hasLEdge=function(detail){return hasEdge(detail,l)},hasREdge=function(detail){return hasEdge(detail,r)},hasTEdge=function(detail){return hasEdge(detail,t)},hasBEdge=function(detail){return hasEdge(detail,b)},currentValue=function(detail){return detail.model.value.get()},xValue=function(x){return{x:x}},yValue=function(y){return{y:y}},xyValue=function(x,y){return{x:x,y:y}},fireSliderChange$3=function(component,value){emitWith(component,sliderChangeEvent(),{value:value})},setToTLEdgeXY=function(edge,detail){fireSliderChange$3(edge,xyValue(min1X(detail),min1Y(detail)))},setToTEdge=function(edge,detail){fireSliderChange$3(edge,yValue(min1Y(detail)))},setToTEdgeXY=function(edge,detail){fireSliderChange$3(edge,xyValue(halfX(detail),min1Y(detail)))},setToTREdgeXY=function(edge,detail){fireSliderChange$3(edge,xyValue(max1X(detail),min1Y(detail)))},setToREdge=function(edge,detail){fireSliderChange$3(edge,xValue(max1X(detail)))},setToREdgeXY=function(edge,detail){fireSliderChange$3(edge,xyValue(max1X(detail),halfY(detail)))},setToBREdgeXY=function(edge,detail){fireSliderChange$3(edge,xyValue(max1X(detail),max1Y(detail)))},setToBEdge=function(edge,detail){fireSliderChange$3(edge,yValue(max1Y(detail)))},setToBEdgeXY=function(edge,detail){fireSliderChange$3(edge,xyValue(halfX(detail),max1Y(detail)))},setToBLEdgeXY=function(edge,detail){fireSliderChange$3(edge,xyValue(min1X(detail),max1Y(detail)))},setToLEdge=function(edge,detail){fireSliderChange$3(edge,xValue(min1X(detail)))},setToLEdgeXY=function(edge,detail){fireSliderChange$3(edge,xyValue(min1X(detail),halfY(detail)))},reduceBy=function(value,min,max,step){return value<min?value:value>max?max:value===min?min-1:Math.max(min,value-step)},increaseBy=function(value,min,max,step){return value>max?value:value<min?min:value===max?max+1:Math.min(max,value+step)},capValue=function(value,min,max){return Math.max(min,Math.min(max,value))},snapValueOf=function(value,min,max,step,snapStart){return snapStart.fold((function(){var initValue=value-min,extraValue=Math.round(initValue/step)*step;return capValue(min+extraValue,min-1,max+1)}),(function(start){var remainder=(value-start)%step,adjustment=Math.round(remainder/step),rawSteps=Math.floor((value-start)/step),maxSteps=Math.floor((max-start)/step),numSteps,r=start+Math.min(maxSteps,rawSteps+adjustment)*step;return Math.max(start,r)}))},findOffsetOf=function(value,min,max){return Math.min(max,Math.max(value,min))-min},findValueOf=function(args){var min=args.min,max=args.max,range=args.range,value=args.value,step=args.step,snap=args.snap,snapStart=args.snapStart,rounded=args.rounded,hasMinEdge=args.hasMinEdge,hasMaxEdge=args.hasMaxEdge,minBound=args.minBound,maxBound=args.maxBound,screenRange=args.screenRange,capMin=hasMinEdge?min-1:min,capMax=hasMaxEdge?max+1:max;if(value<minBound)return capMin;if(value>maxBound)return capMax;var offset=findOffsetOf(value,minBound,maxBound),newValue=capValue(offset/screenRange*range+min,capMin,capMax);return snap&&newValue>=min&&newValue<=max?snapValueOf(newValue,min,max,step,snapStart):rounded?Math.round(newValue):newValue},findOffsetOfValue$2=function(args){var min=args.min,max=args.max,range=args.range,value=args.value,hasMinEdge=args.hasMinEdge,hasMaxEdge=args.hasMaxEdge,maxBound=args.maxBound,maxOffset=args.maxOffset,centerMinEdge=args.centerMinEdge,centerMaxEdge=args.centerMaxEdge;return value<min?hasMinEdge?0:centerMinEdge:value>max?hasMaxEdge?maxBound:centerMaxEdge:(value-min)/range*maxOffset},top="top",right="right",bottom="bottom",left="left",width="width",height="height",getBounds$1=function(component){return component.element.dom.getBoundingClientRect()},getBoundsProperty=function(bounds,property){return bounds[property]},getMinXBounds=function(component){var bounds=getBounds$1(component);return getBoundsProperty(bounds,left)},getMaxXBounds=function(component){var bounds=getBounds$1(component);return getBoundsProperty(bounds,right)},getMinYBounds=function(component){var bounds=getBounds$1(component);return getBoundsProperty(bounds,top)},getMaxYBounds=function(component){var bounds=getBounds$1(component);return getBoundsProperty(bounds,bottom)},getXScreenRange=function(component){var bounds=getBounds$1(component);return getBoundsProperty(bounds,width)},getYScreenRange=function(component){var bounds=getBounds$1(component);return getBoundsProperty(bounds,height)},getCenterOffsetOf=function(componentMinEdge,componentMaxEdge,spectrumMinEdge){return(componentMinEdge+componentMaxEdge)/2-spectrumMinEdge},getXCenterOffSetOf=function(component,spectrum){var componentBounds=getBounds$1(component),spectrumBounds=getBounds$1(spectrum),componentMinEdge=getBoundsProperty(componentBounds,left),componentMaxEdge=getBoundsProperty(componentBounds,right),spectrumMinEdge=getBoundsProperty(spectrumBounds,left);return getCenterOffsetOf(componentMinEdge,componentMaxEdge,spectrumMinEdge)},getYCenterOffSetOf=function(component,spectrum){var componentBounds=getBounds$1(component),spectrumBounds=getBounds$1(spectrum),componentMinEdge=getBoundsProperty(componentBounds,top),componentMaxEdge=getBoundsProperty(componentBounds,bottom),spectrumMinEdge=getBoundsProperty(spectrumBounds,top);return getCenterOffsetOf(componentMinEdge,componentMaxEdge,spectrumMinEdge)},fireSliderChange$2=function(spectrum,value){emitWith(spectrum,sliderChangeEvent(),{value:value})},sliderValue$2=function(x){return{x:x}},findValueOfOffset$1=function(spectrum,detail,left){var args={min:minX(detail),max:maxX(detail),range:xRange(detail),value:left,step:step(detail),snap:snap(detail),snapStart:snapStart(detail),rounded:rounded(detail),hasMinEdge:hasLEdge(detail),hasMaxEdge:hasREdge(detail),minBound:getMinXBounds(spectrum),maxBound:getMaxXBounds(spectrum),screenRange:getXScreenRange(spectrum)};return findValueOf(args)},setValueFrom$2=function(spectrum,detail,value){var xValue=findValueOfOffset$1(spectrum,detail,value),sliderVal=sliderValue$2(xValue);return fireSliderChange$2(spectrum,sliderVal),xValue},setToMin$2=function(spectrum,detail){var min=minX(detail);fireSliderChange$2(spectrum,sliderValue$2(min))},setToMax$2=function(spectrum,detail){var max=maxX(detail);fireSliderChange$2(spectrum,sliderValue$2(max))},moveBy$2=function(direction,spectrum,detail){var f,xValue=(direction>0?increaseBy:reduceBy)(currentValue(detail).x,minX(detail),maxX(detail),step(detail));return fireSliderChange$2(spectrum,sliderValue$2(xValue)),Optional.some(xValue)},handleMovement$2=function(direction){return function(spectrum,detail){return moveBy$2(direction,spectrum,detail).map(always)}},getValueFromEvent$2=function(simulatedEvent){var pos;return getEventSource(simulatedEvent).map((function(p){return p.left}))},findOffsetOfValue$1=function(spectrum,detail,value,minEdge,maxEdge){var minOffset=0,maxOffset=getXScreenRange(spectrum),centerMinEdge=minEdge.bind((function(edge){return Optional.some(getXCenterOffSetOf(edge,spectrum))})).getOr(0),centerMaxEdge=maxEdge.bind((function(edge){return Optional.some(getXCenterOffSetOf(edge,spectrum))})).getOr(maxOffset),args={min:minX(detail),max:maxX(detail),range:xRange(detail),value:value,hasMinEdge:hasLEdge(detail),hasMaxEdge:hasREdge(detail),minBound:getMinXBounds(spectrum),minOffset:0,maxBound:getMaxXBounds(spectrum),maxOffset:maxOffset,centerMinEdge:centerMinEdge,centerMaxEdge:centerMaxEdge};return findOffsetOfValue$2(args)},findPositionOfValue$1=function(slider,spectrum,value,minEdge,maxEdge,detail){var offset=findOffsetOfValue$1(spectrum,detail,value,minEdge,maxEdge);return getMinXBounds(spectrum)-getMinXBounds(slider)+offset},setPositionFromValue$2=function(slider,thumb,detail,edges){var value=currentValue(detail),pos=findPositionOfValue$1(slider,edges.getSpectrum(slider),value.x,edges.getLeftEdge(slider),edges.getRightEdge(slider),detail),thumbRadius=get$5(thumb.element)/2;set$5(thumb.element,"left",pos-thumbRadius+"px")},onLeft$2=handleMovement$2(-1),onRight$2=handleMovement$2(1),onUp$2=Optional.none,onDown$2=Optional.none,edgeActions$2={"top-left":Optional.none(),top:Optional.none(),"top-right":Optional.none(),right:Optional.some(setToREdge),"bottom-right":Optional.none(),bottom:Optional.none(),"bottom-left":Optional.none(),left:Optional.some(setToLEdge)},HorizontalModel=Object.freeze({__proto__:null,setValueFrom:setValueFrom$2,setToMin:setToMin$2,setToMax:setToMax$2,findValueOfOffset:findValueOfOffset$1,getValueFromEvent:getValueFromEvent$2,findPositionOfValue:findPositionOfValue$1,setPositionFromValue:setPositionFromValue$2,onLeft:onLeft$2,onRight:onRight$2,onUp:onUp$2,onDown:onDown$2,edgeActions:edgeActions$2}),fireSliderChange$1=function(spectrum,value){emitWith(spectrum,sliderChangeEvent(),{value:value})},sliderValue$1=function(y){return{y:y}},findValueOfOffset=function(spectrum,detail,top){var args={min:minY(detail),max:maxY(detail),range:yRange(detail),value:top,step:step(detail),snap:snap(detail),snapStart:snapStart(detail),rounded:rounded(detail),hasMinEdge:hasTEdge(detail),hasMaxEdge:hasBEdge(detail),minBound:getMinYBounds(spectrum),maxBound:getMaxYBounds(spectrum),screenRange:getYScreenRange(spectrum)};return findValueOf(args)},setValueFrom$1=function(spectrum,detail,value){var yValue=findValueOfOffset(spectrum,detail,value),sliderVal=sliderValue$1(yValue);return fireSliderChange$1(spectrum,sliderVal),yValue},setToMin$1=function(spectrum,detail){var min=minY(detail);fireSliderChange$1(spectrum,sliderValue$1(min))},setToMax$1=function(spectrum,detail){var max=maxY(detail);fireSliderChange$1(spectrum,sliderValue$1(max))},moveBy$1=function(direction,spectrum,detail){var f,yValue=(direction>0?increaseBy:reduceBy)(currentValue(detail).y,minY(detail),maxY(detail),step(detail));return fireSliderChange$1(spectrum,sliderValue$1(yValue)),Optional.some(yValue)},handleMovement$1=function(direction){return function(spectrum,detail){return moveBy$1(direction,spectrum,detail).map(always)}},getValueFromEvent$1=function(simulatedEvent){var pos;return getEventSource(simulatedEvent).map((function(p){return p.top}))},findOffsetOfValue=function(spectrum,detail,value,minEdge,maxEdge){var minOffset=0,maxOffset=getYScreenRange(spectrum),centerMinEdge=minEdge.bind((function(edge){return Optional.some(getYCenterOffSetOf(edge,spectrum))})).getOr(0),centerMaxEdge=maxEdge.bind((function(edge){return Optional.some(getYCenterOffSetOf(edge,spectrum))})).getOr(maxOffset),args={min:minY(detail),max:maxY(detail),range:yRange(detail),value:value,hasMinEdge:hasTEdge(detail),hasMaxEdge:hasBEdge(detail),minBound:getMinYBounds(spectrum),minOffset:0,maxBound:getMaxYBounds(spectrum),maxOffset:maxOffset,centerMinEdge:centerMinEdge,centerMaxEdge:centerMaxEdge};return findOffsetOfValue$2(args)},findPositionOfValue=function(slider,spectrum,value,minEdge,maxEdge,detail){var offset=findOffsetOfValue(spectrum,detail,value,minEdge,maxEdge);return getMinYBounds(spectrum)-getMinYBounds(slider)+offset},setPositionFromValue$1=function(slider,thumb,detail,edges){var value=currentValue(detail),pos=findPositionOfValue(slider,edges.getSpectrum(slider),value.y,edges.getTopEdge(slider),edges.getBottomEdge(slider),detail),thumbRadius=get$7(thumb.element)/2;set$5(thumb.element,"top",pos-thumbRadius+"px")},onLeft$1=Optional.none,onRight$1=Optional.none,onUp$1=handleMovement$1(-1),onDown$1=handleMovement$1(1),edgeActions$1={"top-left":Optional.none(),top:Optional.some(setToTEdge),"top-right":Optional.none(),right:Optional.none(),"bottom-right":Optional.none(),bottom:Optional.some(setToBEdge),"bottom-left":Optional.none(),left:Optional.none()},VerticalModel=Object.freeze({__proto__:null,setValueFrom:setValueFrom$1,setToMin:setToMin$1,setToMax:setToMax$1,findValueOfOffset:findValueOfOffset,getValueFromEvent:getValueFromEvent$1,findPositionOfValue:findPositionOfValue,setPositionFromValue:setPositionFromValue$1,onLeft:onLeft$1,onRight:onRight$1,onUp:onUp$1,onDown:onDown$1,edgeActions:edgeActions$1}),fireSliderChange=function(spectrum,value){emitWith(spectrum,sliderChangeEvent(),{value:value})},sliderValue=function(x,y){return{x:x,y:y}},setValueFrom=function(spectrum,detail,value){var xValue=findValueOfOffset$1(spectrum,detail,value.left),yValue=findValueOfOffset(spectrum,detail,value.top),val=sliderValue(xValue,yValue);return fireSliderChange(spectrum,val),val},moveBy=function(direction,isVerticalMovement,spectrum,detail){var f=direction>0?increaseBy:reduceBy,xValue=isVerticalMovement?currentValue(detail).x:f(currentValue(detail).x,minX(detail),maxX(detail),step(detail)),yValue=isVerticalMovement?f(currentValue(detail).y,minY(detail),maxY(detail),step(detail)):currentValue(detail).y;return fireSliderChange(spectrum,sliderValue(xValue,yValue)),Optional.some(xValue)},handleMovement=function(direction,isVerticalMovement){return function(spectrum,detail){return moveBy(direction,isVerticalMovement,spectrum,detail).map(always)}},setToMin=function(spectrum,detail){var mX=minX(detail),mY=minY(detail);fireSliderChange(spectrum,sliderValue(mX,mY))},setToMax=function(spectrum,detail){var mX=maxX(detail),mY=maxY(detail);fireSliderChange(spectrum,sliderValue(mX,mY))},getValueFromEvent=function(simulatedEvent){return getEventSource(simulatedEvent)},setPositionFromValue=function(slider,thumb,detail,edges){var value=currentValue(detail),xPos=findPositionOfValue$1(slider,edges.getSpectrum(slider),value.x,edges.getLeftEdge(slider),edges.getRightEdge(slider),detail),yPos=findPositionOfValue(slider,edges.getSpectrum(slider),value.y,edges.getTopEdge(slider),edges.getBottomEdge(slider),detail),thumbXRadius=get$5(thumb.element)/2,thumbYRadius=get$7(thumb.element)/2;set$5(thumb.element,"left",xPos-thumbXRadius+"px"),set$5(thumb.element,"top",yPos-thumbYRadius+"px")},onLeft=handleMovement(-1,!1),onRight=handleMovement(1,!1),onUp=handleMovement(-1,!0),onDown=handleMovement(1,!0),edgeActions={"top-left":Optional.some(setToTLEdgeXY),top:Optional.some(setToTEdgeXY),"top-right":Optional.some(setToTREdgeXY),right:Optional.some(setToREdgeXY),"bottom-right":Optional.some(setToBREdgeXY),bottom:Optional.some(setToBEdgeXY),"bottom-left":Optional.some(setToBLEdgeXY),left:Optional.some(setToLEdgeXY)},TwoDModel=Object.freeze({__proto__:null,setValueFrom:setValueFrom,setToMin:setToMin,setToMax:setToMax,getValueFromEvent:getValueFromEvent,setPositionFromValue:setPositionFromValue,onLeft:onLeft,onRight:onRight,onUp:onUp,onDown:onDown,edgeActions:edgeActions}),SliderSchema=[defaulted("stepSize",1),defaulted("onChange",noop),defaulted("onChoose",noop),defaulted("onInit",noop),defaulted("onDragStart",noop),defaulted("onDragEnd",noop),defaulted("snapToGrid",!1),defaulted("rounded",!0),option("snapStart"),requiredOf("model",choose$1("mode",{x:[defaulted("minX",0),defaulted("maxX",100),customField("value",(function(spec){return Cell(spec.mode.minX)})),required$1("getInitialValue"),output("manager",HorizontalModel)],y:[defaulted("minY",0),defaulted("maxY",100),customField("value",(function(spec){return Cell(spec.mode.minY)})),required$1("getInitialValue"),output("manager",VerticalModel)],xy:[defaulted("minX",0),defaulted("maxX",100),defaulted("minY",0),defaulted("maxY",100),customField("value",(function(spec){return Cell({x:spec.mode.minX,y:spec.mode.minY})})),required$1("getInitialValue"),output("manager",TwoDModel)]})),field$1("sliderBehaviours",[Keying,Representing]),customField("mouseIsDown",(function(){return Cell(!1)}))],mouseReleased=constant$1("mouse.released"),sketch$9,Slider=composite({name:"Slider",configFields:SliderSchema,partFields:SliderParts,factory:function(detail,components,_spec,_externals){var _a,getThumb=function(component){return getPartOrDie(component,detail,"thumb")},getSpectrum=function(component){return getPartOrDie(component,detail,"spectrum")},getLeftEdge=function(component){return getPart(component,detail,"left-edge")},getRightEdge=function(component){return getPart(component,detail,"right-edge")},getTopEdge=function(component){return getPart(component,detail,"top-edge")},getBottomEdge=function(component){return getPart(component,detail,"bottom-edge")},modelDetail=detail.model,model=modelDetail.manager,refresh=function(slider,thumb){model.setPositionFromValue(slider,thumb,detail,{getLeftEdge:getLeftEdge,getRightEdge:getRightEdge,getTopEdge:getTopEdge,getBottomEdge:getBottomEdge,getSpectrum:getSpectrum})},setValue=function(slider,newValue){modelDetail.value.set(newValue);var thumb=getThumb(slider);refresh(slider,thumb)},changeValue=function(slider,newValue){setValue(slider,newValue);var thumb=getThumb(slider);return detail.onChange(slider,thumb,newValue),Optional.some(!0)},resetToMin=function(slider){model.setToMin(slider,detail)},resetToMax=function(slider){model.setToMax(slider,detail)},choose=function(slider){var fireOnChoose=function(){getPart(slider,detail,"thumb").each((function(thumb){var value=modelDetail.value.get();detail.onChoose(slider,thumb,value)}))},wasDown=detail.mouseIsDown.get();detail.mouseIsDown.set(!1),wasDown&&fireOnChoose()},onDragStart=function(slider,simulatedEvent){simulatedEvent.stop(),detail.mouseIsDown.set(!0),detail.onDragStart(slider,getThumb(slider))},onDragEnd=function(slider,simulatedEvent){simulatedEvent.stop(),detail.onDragEnd(slider,getThumb(slider)),choose(slider)};return{uid:detail.uid,dom:detail.dom,components:components,behaviours:augment(detail.sliderBehaviours,[Keying.config({mode:"special",focusIn:function(slider){return getPart(slider,detail,"spectrum").map(Keying.focusIn).map(always)}}),Representing.config({store:{mode:"manual",getValue:function(_){return modelDetail.value.get()}}}),Receiving.config({channels:(_a={},_a[mouseReleased()]={onReceive:choose},_a)})]),events:derive$3([run(sliderChangeEvent(),(function(slider,simulatedEvent){changeValue(slider,simulatedEvent.event.value)})),runOnAttached((function(slider,_simulatedEvent){var getInitial=modelDetail.getInitialValue();modelDetail.value.set(getInitial);var thumb=getThumb(slider);refresh(slider,thumb);var spectrum=getSpectrum(slider);detail.onInit(slider,thumb,spectrum,modelDetail.value.get())})),run(touchstart(),onDragStart),run(touchend(),onDragEnd),run(mousedown(),onDragStart),run(mouseup(),onDragEnd)]),apis:{resetToMin:resetToMin,resetToMax:resetToMax,setValue:setValue,refresh:refresh},domModification:{styles:{position:"relative"}}}},apis:{setValue:function(apis,slider,value){apis.setValue(slider,value)},resetToMin:function(apis,slider){apis.resetToMin(slider)},resetToMax:function(apis,slider){apis.resetToMax(slider)},refresh:function(apis,slider){apis.refresh(slider)}}}),button=function(realm,clazz,makeItems,editor){return forToolbar(clazz,(function(){var items=makeItems();realm.setContextToolbar([{label:clazz+" group",items:items}])}),{},editor)},BLACK=-1,makeSlider$1=function(spec$1){var getColor=function(hue){return hue<0?"black":hue>360?"white":"hsl("+hue+", 100%, 50%)"},onInit=function(slider,thumb,spectrum,value){var color=getColor(value.x());set$5(thumb.element,"background-color",color)},onChange=function(slider,thumb,value){var color=getColor(value.x());set$5(thumb.element,"background-color",color),spec$1.onChange(slider,thumb,color)};return Slider.sketch({dom:dom$1('<div class="${prefix}-slider ${prefix}-hue-slider-container"></div>'),components:[Slider.parts["left-edge"](spec('<div class="${prefix}-hue-slider-black"></div>')),Slider.parts.spectrum({dom:dom$1('<div class="${prefix}-slider-gradient-container"></div>'),components:[spec('<div class="${prefix}-slider-gradient"></div>')],behaviours:derive$2([Toggling.config({toggleClass:resolve("thumb-active")})])}),Slider.parts["right-edge"](spec('<div class="${prefix}-hue-slider-white"></div>')),Slider.parts.thumb({dom:dom$1('<div class="${prefix}-slider-thumb"></div>'),behaviours:derive$2([Toggling.config({toggleClass:resolve("thumb-active")})])})],onChange:onChange,onDragStart:function(slider,thumb){Toggling.on(thumb)},onDragEnd:function(slider,thumb){Toggling.off(thumb)},onInit:onInit,stepSize:10,model:{mode:"x",minX:0,maxX:360,getInitialValue:function(){return{x:spec$1.getInitialValue()}}},sliderBehaviours:derive$2([orientation(Slider.refresh)])})},makeItems$1=function(spec){return[makeSlider$1(spec)]},sketch$8=function(realm,editor){var spec={onChange:function(slider,thumb,color){editor.undoManager.transact((function(){editor.formatter.apply("forecolor",{value:color}),editor.nodeChanged()}))},getInitialValue:constant$1(-1)};return button(realm,"color-levels",(function(){return makeItems$1(spec)}),editor)},candidatesArray=["9px","10px","11px","12px","14px","16px","18px","20px","24px","32px","36px"],defaultSize="medium",defaultIndex=2,indexToSize=function(index){return Optional.from(candidatesArray[index])},sizeToIndex=function(size){return findIndex$1(candidatesArray,(function(v){return v===size}))},getRawOrComputed=function(isRoot,rawStart){var optStart;return(isElement(rawStart)?Optional.some(rawStart):parent(rawStart).filter(isElement)).map((function(start){var inline;return closest$2(start,(function(elem){return getRaw(elem,"font-size").isSome()}),isRoot).bind((function(elem){return getRaw(elem,"font-size")})).getOrThunk((function(){return get$8(start,"font-size")}))})).getOr("")},getSize=function(editor){var node=editor.selection.getStart(),elem=SugarElement.fromDom(node),root=SugarElement.fromDom(editor.getBody()),isRoot,elemSize=getRawOrComputed((function(e){return eq(root,e)}),elem);return find$2(candidatesArray,(function(size){return elemSize===size})).getOr("medium")},applySize=function(editor,value){var currentValue;getSize(editor)!==value&&editor.execCommand("fontSize",!1,value)},get$4=function(editor){var size=getSize(editor);return sizeToIndex(size).getOr(2)},apply=function(editor,index){indexToSize(index).each((function(size){applySize(editor,size)}))},candidates=constant$1(candidatesArray),schema$9=objOfOnly([required$1("getInitialValue"),required$1("onChange"),required$1("category"),required$1("sizes")]),sketch$7=function(rawSpec){var spec$1=asRawOrDie$1("SizeSlider",schema$9,rawSpec),isValidValue=function(valueIndex){return valueIndex>=0&&valueIndex<spec$1.sizes.length},onChange=function(slider,thumb,valueIndex){var index=valueIndex.x();isValidValue(index)&&spec$1.onChange(index)};return Slider.sketch({dom:{tag:"div",classes:[resolve("slider-"+spec$1.category+"-size-container"),resolve("slider"),resolve("slider-size-container")]},onChange:onChange,onDragStart:function(slider,thumb){Toggling.on(thumb)},onDragEnd:function(slider,thumb){Toggling.off(thumb)},model:{mode:"x",minX:0,maxX:spec$1.sizes.length-1,getInitialValue:function(){return{x:spec$1.getInitialValue()}}},stepSize:1,snapToGrid:!0,sliderBehaviours:derive$2([orientation(Slider.refresh)]),components:[Slider.parts.spectrum({dom:dom$1('<div class="${prefix}-slider-size-container"></div>'),components:[spec('<div class="${prefix}-slider-size-line"></div>')]}),Slider.parts.thumb({dom:dom$1('<div class="${prefix}-slider-thumb"></div>'),behaviours:derive$2([Toggling.config({toggleClass:resolve("thumb-active")})])})]})},sizes=candidates(),makeSlider=function(spec){return sketch$7({onChange:spec.onChange,sizes:sizes,category:"font",getInitialValue:spec.getInitialValue})},makeItems=function(spec$1){return[spec('<span class="${prefix}-toolbar-button ${prefix}-icon-small-font ${prefix}-icon"></span>'),makeSlider(spec$1),spec('<span class="${prefix}-toolbar-button ${prefix}-icon-large-font ${prefix}-icon"></span>')]},sketch$6=function(realm,editor){var spec={onChange:function(value){apply(editor,value)},getInitialValue:function(){return get$4(editor)}};return button(realm,"font-size",(function(){return makeItems(spec)}),editor)},record=function(spec){var uid=isSketchSpec$1(spec)&&hasNonNullableKey(spec,"uid")?spec.uid:generate$2("memento"),get,getOpt,asSpec;return{get:function(anyInSystem){return anyInSystem.getSystem().getByUid(uid).getOrDie()},getOpt:function(anyInSystem){return anyInSystem.getSystem().getByUid(uid).toOptional()},asSpec:function(){return __assign(__assign({},spec),{uid:uid})}}},exports$1={},module={exports:exports$1};!function(define,exports,module,require){!function(global,factory){"object"==typeof exports&&void 0!==module?module.exports=factory():"function"==typeof define&&define.amd?define(factory):(global="undefined"!=typeof globalThis?globalThis:global||self).EphoxContactWrapper=factory()}(this,(function(){var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},promise={exports:{}};!function(module){!function(root){var setTimeoutFunc=setTimeout;function noop(){}function bind(fn,thisArg){return function(){fn.apply(thisArg,arguments)}}function Promise(fn){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof fn)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],doResolve(fn,this)}function handle(self,deferred){for(;3===self._state;)self=self._value;0!==self._state?(self._handled=!0,Promise._immediateFn((function(){var cb=1===self._state?deferred.onFulfilled:deferred.onRejected;if(null!==cb){var ret;try{ret=cb(self._value)}catch(e){return void reject(deferred.promise,e)}resolve(deferred.promise,ret)}else(1===self._state?resolve:reject)(deferred.promise,self._value)}))):self._deferreds.push(deferred)}function resolve(self,newValue){try{if(newValue===self)throw new TypeError("A promise cannot be resolved with itself.");if(newValue&&("object"==typeof newValue||"function"==typeof newValue)){var then=newValue.then;if(newValue instanceof Promise)return self._state=3,self._value=newValue,void finale(self);if("function"==typeof then)return void doResolve(bind(then,newValue),self)}self._state=1,self._value=newValue,finale(self)}catch(e){reject(self,e)}}function reject(self,newValue){self._state=2,self._value=newValue,finale(self)}function finale(self){2===self._state&&0===self._deferreds.length&&Promise._immediateFn((function(){self._handled||Promise._unhandledRejectionFn(self._value)}));for(var i=0,len=self._deferreds.length;i<len;i++)handle(self,self._deferreds[i]);self._deferreds=null}function Handler(onFulfilled,onRejected,promise){this.onFulfilled="function"==typeof onFulfilled?onFulfilled:null,this.onRejected="function"==typeof onRejected?onRejected:null,this.promise=promise}function doResolve(fn,self){var done=!1;try{fn((function(value){done||(done=!0,resolve(self,value))}),(function(reason){done||(done=!0,reject(self,reason))}))}catch(ex){if(done)return;done=!0,reject(self,ex)}}Promise.prototype.catch=function(onRejected){return this.then(null,onRejected)},Promise.prototype.then=function(onFulfilled,onRejected){var prom=new this.constructor(noop);return handle(this,new Handler(onFulfilled,onRejected,prom)),prom},Promise.all=function(arr){var args=Array.prototype.slice.call(arr);return new Promise((function(resolve,reject){if(0===args.length)return resolve([]);var remaining=args.length;function res(i,val){try{if(val&&("object"==typeof val||"function"==typeof val)){var then=val.then;if("function"==typeof then)return void then.call(val,(function(val){res(i,val)}),reject)}args[i]=val,0==--remaining&&resolve(args)}catch(ex){reject(ex)}}for(var i=0;i<args.length;i++)res(i,args[i])}))},Promise.resolve=function(value){return value&&"object"==typeof value&&value.constructor===Promise?value:new Promise((function(resolve){resolve(value)}))},Promise.reject=function(value){return new Promise((function(resolve,reject){reject(value)}))},Promise.race=function(values){return new Promise((function(resolve,reject){for(var i=0,len=values.length;i<len;i++)values[i].then(resolve,reject)}))},Promise._immediateFn="function"==typeof setImmediate?function(fn){setImmediate(fn)}:function(fn){setTimeoutFunc(fn,0)},Promise._unhandledRejectionFn=function _unhandledRejectionFn(err){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",err)},Promise._setImmediateFn=function _setImmediateFn(fn){Promise._immediateFn=fn},Promise._setUnhandledRejectionFn=function _setUnhandledRejectionFn(fn){Promise._unhandledRejectionFn=fn},module.exports?module.exports=Promise:root.Promise||(root.Promise=Promise)}(commonjsGlobal)}(promise);var promisePolyfill=promise.exports,Global,promisePolyfill_1;return{boltExport:("undefined"!=typeof window?window:Function("return this;")()).Promise||promisePolyfill}}))}(void 0,exports$1,module);var Promise$1=module.exports.boltExport,blobToDataUri=function(blob){return new Promise$1((function(resolve){var reader=new FileReader;reader.onloadend=function(){resolve(reader.result)},reader.readAsDataURL(blob)}))},blobToBase64$1=function(blob){return blobToDataUri(blob).then((function(dataUri){return dataUri.split(",")[1]}))},blobToBase64=function(blob){return blobToBase64$1(blob)},addImage=function(editor,blob){blobToBase64(blob).then((function(base64){editor.undoManager.transact((function(){var cache=editor.editorUpload.blobCache,info=cache.create(generate$4("mceu"),blob,base64);cache.add(info);var img=editor.dom.createHTML("img",{src:info.blobUri()});editor.insertContent(img)}))}))},extractBlob=function(simulatedEvent){var event=simulatedEvent.event.raw,files=event.target.files||event.dataTransfer.files;return Optional.from(files[0])},sketch$5=function(editor){var pickerDom,memPicker=record({dom:{tag:"input",attributes:{accept:"image/*",type:"file",title:""},styles:{visibility:"hidden",position:"absolute"}},events:derive$3([cutter(click()),run(change(),(function(picker,simulatedEvent){extractBlob(simulatedEvent).each((function(blob){addImage(editor,blob)}))}))])});return Button.sketch({dom:getToolbarIconButton("image",editor),components:[memPicker.asSpec()],action:function(button){var picker;memPicker.get(button).element.dom.click()}})},get$3=function(element){return element.dom.textContent},set$3=function(element,value){element.dom.textContent=value},isNotEmpty=function(val){return val.length>0},defaultToEmpty=function(str){return null==str?"":str},noLink=function(editor){var text;return{url:"",text:editor.selection.getContent({format:"text"}),title:"",target:"",link:Optional.none()}},fromLink=function(link){var text=get$3(link),url=get$b(link,"href"),title=get$b(link,"title"),target=get$b(link,"target");return{url:defaultToEmpty(url),text:text!==url?defaultToEmpty(text):"",title:defaultToEmpty(title),target:defaultToEmpty(target),link:Optional.some(link)}},getInfo=function(editor){return query(editor).fold((function(){return noLink(editor)}),(function(link){return fromLink(link)}))},wasSimple=function(link){var prevHref,prevText;return get$b(link,"href")===get$3(link)},getTextToApply=function(link,url,info){return info.text.toOptional().filter(isNotEmpty).fold((function(){return wasSimple(link)?Optional.some(url):Optional.none()}),Optional.some)},unlinkIfRequired=function(editor,info){var activeLink;info.link.bind(identity).each((function(_link){editor.execCommand("unlink")}))},getAttrs=function(url,info){var attrs={};return attrs.href=url,info.title.toOptional().filter(isNotEmpty).each((function(title){attrs.title=title})),info.target.toOptional().filter(isNotEmpty).each((function(target){attrs.target=target})),attrs},applyInfo=function(editor,info){info.url.toOptional().filter(isNotEmpty).fold((function(){unlinkIfRequired(editor,info)}),(function(url){var attrs=getAttrs(url,info),activeLink;info.link.bind(identity).fold((function(){var text=info.text.toOptional().filter(isNotEmpty).getOr(url);editor.insertContent(editor.dom.createHTML("a",attrs,editor.dom.encode(text)))}),(function(link){var text=getTextToApply(link,url,info);setAll$1(link,attrs),text.each((function(newText){set$3(link,newText)}))}))}))},query=function(editor){var start=SugarElement.fromDom(editor.selection.getStart());return closest$1(start,"a")},platform=detect$1(),preserve$1=function(f,editor){var rng=editor.selection.getRng();f(),editor.selection.setRng(rng)},forAndroid=function(editor,f){var wrapper;(platform.os.isAndroid()?preserve$1:apply$1)(f,editor)},events$4=function(name,eventHandlers){var events=derive$3(eventHandlers);return create$5({fields:[required$1("enabled")],name:name,active:{events:constant$1(events)}})},config=function(name,eventHandlers){var me;return{key:name,value:{config:{},me:events$4(name,eventHandlers),configAsRaw:constant$1({}),initialConfig:{},state:NoState}}},getCurrent=function(component,composeConfig,_composeState){return composeConfig.find(component)},ComposeApis=Object.freeze({__proto__:null,getCurrent:getCurrent}),ComposeSchema=[required$1("find")],Composing=create$5({fields:ComposeSchema,name:"composing",apis:ComposeApis}),factory$4=function(detail){var _a=detail.dom,attributes=_a.attributes,domWithoutAttributes=__rest(_a,["attributes"]);return{uid:detail.uid,dom:__assign({tag:"div",attributes:__assign({role:"presentation"},attributes)},domWithoutAttributes),components:detail.components,behaviours:get$6(detail.containerBehaviours),events:detail.events,domModification:detail.domModification,eventOrder:detail.eventOrder}},Container=single({name:"Container",factory:factory$4,configFields:[defaulted("components",[]),field$1("containerBehaviours",[]),defaulted("events",{}),defaulted("domModification",{}),defaulted("eventOrder",{})]}),factory$3=function(detail){return{uid:detail.uid,dom:detail.dom,behaviours:SketchBehaviours_augment(detail.dataBehaviours,[Representing.config({store:{mode:"memory",initialValue:detail.getInitialValue()}}),Composing.config({find:Optional.some})]),events:derive$3([runOnAttached((function(component,_simulatedEvent){Representing.setValue(component,detail.getInitialValue())}))])}},DataField=single({name:"DataField",factory:factory$3,configFields:[required$1("uid"),required$1("dom"),required$1("getInitialValue"),SketchBehaviours_field("dataBehaviours",[Representing,Composing])]}),get$2=function(element){return element.dom.value},set$2=function(element,value){if(void 0===value)throw new Error("Value.set was undefined");element.dom.value=value},schema$8=constant$1([option("data"),defaulted("inputAttributes",{}),defaulted("inputStyles",{}),defaulted("tag","input"),defaulted("inputClasses",[]),onHandler("onSetValue"),defaulted("styles",{}),defaulted("eventOrder",{}),field$1("inputBehaviours",[Representing,Focusing]),defaulted("selectOnFocus",!0)]),focusBehaviours=function(detail){return derive$2([Focusing.config({onFocus:detail.selectOnFocus?function(component){var input=component.element,value=get$2(input);input.dom.setSelectionRange(0,value.length)}:noop})])},behaviours=function(detail){return __assign(__assign({},focusBehaviours(detail)),augment(detail.inputBehaviours,[Representing.config({store:__assign(__assign({mode:"manual"},detail.data.map((function(data){return{initialValue:data}})).getOr({})),{getValue:function(input){return get$2(input.element)},setValue:function(input,data){var current;get$2(input.element)!==data&&set$2(input.element,data)}}),onSetValue:detail.onSetValue})]))},dom=function(detail){return{tag:detail.tag,attributes:__assign({type:"text"},detail.inputAttributes),styles:detail.inputStyles,classes:detail.inputClasses}},factory$2=function(detail,_spec){return{uid:detail.uid,dom:dom(detail),components:[],behaviours:behaviours(detail),eventOrder:detail.eventOrder}},Input=single({name:"Input",configFields:schema$8(),factory:factory$2}),exhibit$2=function(base,tabConfig){return nu$3({attributes:wrapAll([{key:tabConfig.tabAttr,value:"true"}])})},ActiveTabstopping=Object.freeze({__proto__:null,exhibit:exhibit$2}),TabstopSchema=[defaulted("tabAttr","data-alloy-tabstop")],Tabstopping=create$5({fields:TabstopSchema,name:"tabstopping",active:ActiveTabstopping}),global$3=tinymce.util.Tools.resolve("tinymce.util.I18n"),clearInputBehaviour="input-clearing",field=function(name,placeholder){var inputSpec=record(Input.sketch({inputAttributes:{placeholder:global$3.translate(placeholder)},onSetValue:function(input,_data){emit(input,input$1())},inputBehaviours:derive$2([Composing.config({find:Optional.some}),Tabstopping.config({}),Keying.config({mode:"execution"})]),selectOnFocus:!1})),buttonSpec=record(Button.sketch({dom:dom$1('<button class="${prefix}-input-container-x ${prefix}-icon-cancel-circle ${prefix}-icon"></button>'),action:function(button){var input=inputSpec.get(button);Representing.setValue(input,"")}}));return{name:name,spec:Container.sketch({dom:dom$1('<div class="${prefix}-input-container"></div>'),components:[inputSpec.asSpec(),buttonSpec.asSpec()],containerBehaviours:derive$2([Toggling.config({toggleClass:resolve("input-container-empty")}),Composing.config({find:function(comp){return Optional.some(inputSpec.get(comp))}}),config("input-clearing",[run(input$1(),(function(iContainer){var input=inputSpec.get(iContainer),val,f;(Representing.getValue(input).length>0?Toggling.off:Toggling.on)(iContainer)}))])])})}},hidden=function(name){return{name:name,spec:DataField.sketch({dom:{tag:"span",styles:{display:"none"}},getInitialValue:function(){return Optional.none()}})}},nativeDisabled=["input","button","textarea","select"],onLoad=function(component,disableConfig,disableState){var f;(disableConfig.disabled()?disable:enable)(component,disableConfig)},hasNative=function(component,config){return!0===config.useNative&&contains$1(nativeDisabled,name$1(component.element))},nativeIsDisabled=function(component){return has$1(component.element,"disabled")},nativeDisable=function(component){set$8(component.element,"disabled","disabled")},nativeEnable=function(component){remove$6(component.element,"disabled")},ariaIsDisabled=function(component){return"true"===get$b(component.element,"aria-disabled")},ariaDisable=function(component){set$8(component.element,"aria-disabled","true")},ariaEnable=function(component){set$8(component.element,"aria-disabled","false")},disable=function(component,disableConfig,_disableState){var f;disableConfig.disableClass.each((function(disableClass){add$1(component.element,disableClass)})),(hasNative(component,disableConfig)?nativeDisable:ariaDisable)(component),disableConfig.onDisabled(component)},enable=function(component,disableConfig,_disableState){var f;disableConfig.disableClass.each((function(disableClass){remove$3(component.element,disableClass)})),(hasNative(component,disableConfig)?nativeEnable:ariaEnable)(component),disableConfig.onEnabled(component)},isDisabled=function(component,disableConfig){return hasNative(component,disableConfig)?nativeIsDisabled(component):ariaIsDisabled(component)},set$1=function(component,disableConfig,disableState,disabled){var f;(disabled?disable:enable)(component,disableConfig)},DisableApis=Object.freeze({__proto__:null,enable:enable,disable:disable,isDisabled:isDisabled,onLoad:onLoad,set:set$1}),exhibit$1=function(base,disableConfig){return nu$3({classes:disableConfig.disabled()?disableConfig.disableClass.toArray():[]})},events$3=function(disableConfig,disableState){return derive$3([abort(execute$5(),(function(component,_simulatedEvent){return isDisabled(component,disableConfig)})),loadEvent(disableConfig,disableState,onLoad)])},ActiveDisable=Object.freeze({__proto__:null,exhibit:exhibit$1,events:events$3}),DisableSchema=[defaultedFunction("disabled",never),defaulted("useNative",!0),option("disableClass"),onHandler("onDisabled"),onHandler("onEnabled")],Disabling=create$5({fields:DisableSchema,name:"disabling",active:ActiveDisable,apis:DisableApis}),owner$1="form",schema$7=[field$1("formBehaviours",[Representing])],getPartName=function(name){return"<alloy.field."+name+">"},sketch$4=function(fSpec){var parts=function(){var record=[],field;return{field:function(name,config){return record.push(name),generateOne("form",getPartName(name),config)},record:constant$1(record)}}(),spec=fSpec(parts),partNames=parts.record(),fieldParts=map$2(partNames,(function(n){return required({name:n,pname:getPartName(n)})}));return composite$1("form",schema$7,fieldParts,make$4,spec)},toResult=function(o,e){return o.fold((function(){return Result.error(e)}),Result.value)},make$4=function(detail,components){return{uid:detail.uid,dom:detail.dom,components:components,behaviours:augment(detail.formBehaviours,[Representing.config({store:{mode:"manual",getValue:function(form){var resPs=getAllParts(form,detail);return map$1(resPs,(function(resPThunk,pName){return resPThunk().bind((function(v){var opt=Composing.getCurrent(v);return toResult(opt,new Error("Cannot find a current component to extract the value from for form part '"+pName+"': "+element(v.element)))})).map(Representing.getValue)}))},setValue:function(form,values){each(values,(function(newValue,key){getPart(form,detail,key).each((function(wrapper){Composing.getCurrent(wrapper).each((function(field){Representing.setValue(field,newValue)}))}))}))}}})]),apis:{getField:function(form,key){return getPart(form,detail,key).bind(Composing.getCurrent)}}}},Form_getField=makeApi((function(apis,component,key){return apis.getField(component,key)})),Form_sketch=sketch$4,SWIPING_LEFT=1,SWIPING_RIGHT=-1,SWIPING_NONE=0,init$3=function(xValue){return{xValue:xValue,points:[]}},move=function(model,xValue){if(xValue===model.xValue)return model;var currentDirection=xValue-model.xValue>0?1:-1,newPoint={direction:currentDirection,xValue:xValue},priorPoints,prev;return{xValue:xValue,points:(0===model.points.length?[]:model.points[model.points.length-1].direction===currentDirection?model.points.slice(0,model.points.length-1):model.points).concat([newPoint])}},complete=function(model){if(0===model.points.length)return 0;var firstDirection=model.points[0].direction,lastDirection=model.points[model.points.length-1].direction;return-1===firstDirection&&-1===lastDirection?-1:1===firstDirection&&1===lastDirection?1:0},sketch$3=function(rawSpec){var navigateEvent="navigateEvent",wrapperAdhocEvents="serializer-wrapper-events",formAdhocEvents="form-events",schema=objOf([required$1("fields"),defaulted("maxFieldIndex",rawSpec.fields.length-1),required$1("onExecute"),required$1("getInitialValue"),customField("state",(function(){return{dialogSwipeState:value(),currentScreen:Cell(0)}}))]),spec$1=asRawOrDie$1("SerialisedDialog",schema,rawSpec),navigationButton=function(direction,directionName,enabled){return Button.sketch({dom:dom$1('<span class="${prefix}-icon-'+directionName+' ${prefix}-icon"></span>'),action:function(button){emitWith(button,navigateEvent,{direction:direction})},buttonBehaviours:derive$2([Disabling.config({disableClass:resolve("toolbar-navigation-disabled"),disabled:function(){return!enabled}})])})},reposition=function(dialog,message){descendant(dialog.element,"."+resolve("serialised-dialog-chain")).each((function(parent){set$5(parent,"left",-spec$1.state.currentScreen.get()*message.width+"px")}))},navigate=function(dialog,direction){var screens=descendants(dialog.element,"."+resolve("serialised-dialog-screen"));descendant(dialog.element,"."+resolve("serialised-dialog-chain")).each((function(parent){spec$1.state.currentScreen.get()+direction>=0&&spec$1.state.currentScreen.get()+direction<screens.length&&(getRaw(parent,"left").each((function(left){var currentLeft=parseInt(left,10),w=get$5(screens[0]);set$5(parent,"left",currentLeft-direction*w+"px")})),spec$1.state.currentScreen.set(spec$1.state.currentScreen.get()+direction))}))},focusInput=function(dialog){var inputs=descendants(dialog.element,"input"),optInput;Optional.from(inputs[spec$1.state.currentScreen.get()]).each((function(input){dialog.getSystem().getByDom(input).each((function(inputComp){dispatchFocus(dialog,inputComp.element)}))}));var dotitems=memDots.get(dialog);Highlighting.highlightAt(dotitems,spec$1.state.currentScreen.get())},resetState=function(){spec$1.state.currentScreen.set(0),spec$1.state.dialogSwipeState.clear()},memForm=record(Form_sketch((function(parts){return{dom:dom$1('<div class="${prefix}-serialised-dialog"></div>'),components:[Container.sketch({dom:dom$1('<div class="${prefix}-serialised-dialog-chain" style="left: 0px; position: absolute;"></div>'),components:map$2(spec$1.fields,(function(field,i){return i<=spec$1.maxFieldIndex?Container.sketch({dom:dom$1('<div class="${prefix}-serialised-dialog-screen"></div>'),components:[navigationButton(-1,"previous",i>0),parts.field(field.name,field.spec),navigationButton(1,"next",i<spec$1.maxFieldIndex)]}):parts.field(field.name,field.spec)}))})],formBehaviours:derive$2([orientation((function(dialog,message){reposition(dialog,message)})),Keying.config({mode:"special",focusIn:function(dialog,_specialInfo){focusInput(dialog)},onTab:function(dialog,_specialInfo){return navigate(dialog,1),Optional.some(!0)},onShiftTab:function(dialog,_specialInfo){return navigate(dialog,-1),Optional.some(!0)}}),config("form-events",[runOnAttached((function(dialog,_simulatedEvent){resetState();var dotitems=memDots.get(dialog);Highlighting.highlightFirst(dotitems),spec$1.getInitialValue(dialog).each((function(v){Representing.setValue(dialog,v)}))})),runOnExecute(spec$1.onExecute),run(transitionend(),(function(dialog,simulatedEvent){var event;"left"===simulatedEvent.event.raw.propertyName&&focusInput(dialog)})),run(navigateEvent,(function(dialog,simulatedEvent){var event,direction=simulatedEvent.event.direction;navigate(dialog,direction)}))])])}}))),memDots=record({dom:dom$1('<div class="${prefix}-dot-container"></div>'),behaviours:derive$2([Highlighting.config({highlightClass:resolve("dot-active"),itemClass:resolve("dot-item")})]),components:bind$3(spec$1.fields,(function(_f,i){return i<=spec$1.maxFieldIndex?[spec('<div class="${prefix}-dot-item ${prefix}-icon-full-dot ${prefix}-icon"></div>')]:[]}))});return{dom:dom$1('<div class="${prefix}-serializer-wrapper"></div>'),components:[memForm.asSpec(),memDots.asSpec()],behaviours:derive$2([Keying.config({mode:"special",focusIn:function(wrapper){var form=memForm.get(wrapper);Keying.focusIn(form)}}),config(wrapperAdhocEvents,[run(touchstart(),(function(_wrapper,simulatedEvent){var event=simulatedEvent.event;spec$1.state.dialogSwipeState.set(init$3(event.raw.touches[0].clientX))})),run(touchmove(),(function(_wrapper,simulatedEvent){var event=simulatedEvent.event;spec$1.state.dialogSwipeState.on((function(state){simulatedEvent.event.prevent(),spec$1.state.dialogSwipeState.set(move(state,event.raw.touches[0].clientX))}))})),run(touchend(),(function(wrapper,_simulatedEvent){spec$1.state.dialogSwipeState.on((function(state){var dialog=memForm.get(wrapper),direction=-1*complete(state);navigate(dialog,direction)}))}))])])}},getGroups=cached((function(realm,editor){return[{label:"the link group",items:[sketch$3({fields:[field("url","Type or paste URL"),field("text","Link text"),field("title","Link title"),field("target","Link target"),hidden("link")],maxFieldIndex:["url","text","title","target"].length-1,getInitialValue:function(){return Optional.some(getInfo(editor))},onExecute:function(dialog,_simulatedEvent){var info=Representing.getValue(dialog);applyInfo(editor,info),realm.restoreToolbar(),editor.focus()}})]}]})),sketch$2=function(realm,editor){return forToolbarStateAction(editor,"link","link",(function(){var groups=getGroups(realm,editor);realm.setContextToolbar(groups),forAndroid(editor,(function(){realm.focusToolbar()})),query(editor).each((function(link){editor.selection.select(link.dom)}))}))},isRecursive=function(component,originator,target){return eq(originator,component.element)&&!eq(originator,target)},events$2=derive$3([can(focus$4(),(function(component,simulatedEvent){var event=simulatedEvent.event,originator=event.originator,target=event.target;return!isRecursive(component,originator,target)||(console.warn(focus$4()+" did not get interpreted by the desired target. \nOriginator: "+element(originator)+"\nTarget: "+element(target)+"\nCheck the "+focus$4()+" event handlers"),!1)}))]),DefaultEvents=Object.freeze({__proto__:null,events:events$2}),make$3=identity,NoContextApi=function(getComp){var getMessage=function(event){return"The component must be in a context to execute: "+event+(getComp?"\n"+element(getComp().element)+" is not in context.":"")},fail=function(event){return function(){throw new Error(getMessage(event))}},warn=function(event){return function(){console.warn(getMessage(event))}};return{debugInfo:constant$1("fake"),triggerEvent:warn("triggerEvent"),triggerFocus:warn("triggerFocus"),triggerEscape:warn("triggerEscape"),broadcast:warn("broadcast"),broadcastOn:warn("broadcastOn"),broadcastEvent:warn("broadcastEvent"),build:fail("build"),addToWorld:fail("addToWorld"),removeFromWorld:fail("removeFromWorld"),addToGui:fail("addToGui"),removeFromGui:fail("removeFromGui"),getByUid:fail("getByUid"),getByDom:fail("getByDom"),isConnected:never}},singleton=NoContextApi(),generateFrom$1=function(spec,all){var schema=map$2(all,(function(a){return optionObjOf(a.name(),[required$1("config"),defaulted("state",NoState)])})),validated=asRaw("component.behaviours",objOf(schema),spec.behaviours).fold((function(errInfo){throw new Error(formatError(errInfo)+"\nComplete spec:\n"+JSON.stringify(spec,null,2))}),identity);return{list:all,data:map$1(validated,(function(optBlobThunk){var output=optBlobThunk.map((function(blob){return{config:blob.config,state:blob.state.init(blob.config)}}));return constant$1(output)}))}},getBehaviours$1=function(bData){return bData.list},getData=function(bData){return bData.data},byInnerKey=function(data,tuple){var r={};return each(data,(function(detail,key){each(detail,(function(value,indexKey){var chain=get$c(r,indexKey).getOr([]);r[indexKey]=chain.concat([tuple(key,value)])}))})),r},combine$1=function(info,baseMod,behaviours,base){var modsByBehaviour=__assign({},baseMod);each$1(behaviours,(function(behaviour){modsByBehaviour[behaviour.name()]=behaviour.exhibit(info,base)}));var byAspect=byInnerKey(modsByBehaviour,(function(name,modification){return{name:name,modification:modification}})),combineObjects=function(objects){return foldr(objects,(function(b,a){return __assign(__assign({},a.modification),b)}),{})},combinedClasses=foldr(byAspect.classes,(function(b,a){return a.modification.concat(b)}),[]),combinedAttributes=combineObjects(byAspect.attributes),combinedStyles=combineObjects(byAspect.styles);return nu$3({classes:combinedClasses,attributes:combinedAttributes,styles:combinedStyles})},sortKeys=function(label,keyName,array,order){try{var sorted=sort(array,(function(a,b){var aKey=a[keyName],bKey=b[keyName],aIndex=order.indexOf(aKey),bIndex=order.indexOf(bKey);if(-1===aIndex)throw new Error("The ordering for "+label+" does not have an entry for "+aKey+".\nOrder specified: "+JSON.stringify(order,null,2));if(-1===bIndex)throw new Error("The ordering for "+label+" does not have an entry for "+bKey+".\nOrder specified: "+JSON.stringify(order,null,2));return aIndex<bIndex?-1:bIndex<aIndex?1:0}));return Result.value(sorted)}catch(err){return Result.error([err])}},uncurried=function(handler,purpose){return{handler:handler,purpose:purpose}},curried=function(handler,purpose){return{cHandler:handler,purpose:purpose}},curryArgs=function(descHandler,extraArgs){return curried(curry.apply(void 0,[descHandler.handler].concat(extraArgs)),descHandler.purpose)},getCurried=function(descHandler){return descHandler.cHandler},behaviourTuple=function(name,handler){return{name:name,handler:handler}},nameToHandlers=function(behaviours,info){var r={};return each$1(behaviours,(function(behaviour){r[behaviour.name()]=behaviour.handlers(info)})),r},groupByEvents=function(info,behaviours,base){var behaviourEvents=__assign(__assign({},base),nameToHandlers(behaviours,info));return byInnerKey(behaviourEvents,behaviourTuple)},combine=function(info,eventOrder,behaviours,base){var byEventName=groupByEvents(info,behaviours,base);return combineGroups(byEventName,eventOrder)},assemble=function(rawHandler){var handler=read$1(rawHandler);return function(component,simulatedEvent){for(var rest=[],_i=2;_i<arguments.length;_i++)rest[_i-2]=arguments[_i];var args=[component,simulatedEvent].concat(rest);handler.abort.apply(void 0,args)?simulatedEvent.stop():handler.can.apply(void 0,args)&&handler.run.apply(void 0,args)}},missingOrderError=function(eventName,tuples){return Result.error(["The event ("+eventName+') has more than one behaviour that listens to it.\nWhen this occurs, you must specify an event ordering for the behaviours in your spec (e.g. [ "listing", "toggling" ]).\nThe behaviours that can trigger it are: '+JSON.stringify(map$2(tuples,(function(c){return c.name})),null,2)])},fuse=function(tuples,eventOrder,eventName){var order=eventOrder[eventName];return order?sortKeys("Event: "+eventName,"name",tuples,order).map((function(sortedTuples){var handlers=map$2(sortedTuples,(function(tuple){return tuple.handler}));return fuse$1(handlers)})):missingOrderError(eventName,tuples)},combineGroups=function(byEventName,eventOrder){var r=mapToArray(byEventName,(function(tuples,eventName){var combined;return(1===tuples.length?Result.value(tuples[0].handler):fuse(tuples,eventOrder,eventName)).map((function(handler){var assembled=assemble(handler),purpose=tuples.length>1?filter$2(eventOrder[eventName],(function(o){return exists(tuples,(function(t){return t.name===o}))})).join(" > "):tuples[0].name;return wrap(eventName,uncurried(assembled,purpose))}))}));return consolidate(r,{})},_a,baseBehaviour="alloy.base.behaviour",schema$6=objOf([field$2("dom","dom",{tag:"required",process:{}},objOf([required$1("tag"),defaulted("styles",{}),defaulted("classes",[]),defaulted("attributes",{}),option("value"),option("innerHtml")])),required$1("components"),required$1("uid"),defaulted("events",{}),defaulted("apis",{}),field$2("eventOrder","eventOrder",mergeWith((_a={},_a[execute$5()]=["disabling",baseBehaviour,"toggling","typeaheadevents"],_a[focus$4()]=[baseBehaviour,"focusing","keying"],_a[systemInit()]=[baseBehaviour,"disabling","toggling","representing"],_a[input$1()]=[baseBehaviour,"representing","streaming","invalidating"],_a[detachedFromDom()]=[baseBehaviour,"representing","item-events","tooltipping"],_a[mousedown()]=["focusing",baseBehaviour,"item-type-events"],_a[touchstart()]=["focusing",baseBehaviour,"item-type-events"],_a[mouseover()]=["item-type-events","tooltipping"],_a[receive$1()]=["receiving","reflecting","tooltipping"],_a)),anyValue()),option("domModification")]),toInfo=function(spec){return asRaw("custom.definition",schema$6,spec)},toDefinition=function(detail){return __assign(__assign({},detail.dom),{uid:detail.uid,domChildren:map$2(detail.components,(function(comp){return comp.element}))})},toModification=function(detail){return detail.domModification.fold((function(){return nu$3({})}),nu$3)},toEvents=function(info){return info.events},add=function(element,classes){each$1(classes,(function(x){add$1(element,x)}))},remove$1=function(element,classes){each$1(classes,(function(x){remove$3(element,x)}))},renderToDom=function(definition){var subject=SugarElement.fromTag(definition.tag);setAll$1(subject,definition.attributes),add(subject,definition.classes),setAll(subject,definition.styles),definition.innerHtml.each((function(html){return set$7(subject,html)}));var children=definition.domChildren;return append$1(subject,children),definition.value.each((function(value){set$2(subject,value)})),definition.uid,writeOnly(subject,definition.uid),subject},getBehaviours=function(spec){var behaviours=get$c(spec,"behaviours").getOr({});return bind$3(keys(behaviours),(function(name){var behaviour=behaviours[name];return isNonNullable(behaviour)?[behaviour.me]:[]}))},generateFrom=function(spec,all){return generateFrom$1(spec,all)},generate$1=function(spec){var all=getBehaviours(spec);return generateFrom(spec,all)},getDomDefinition=function(info,bList,bData){var definition=toDefinition(info),infoModification=toModification(info),baseModification={"alloy.base.modification":infoModification},modification=bList.length>0?combine$1(bData,baseModification,bList,definition):infoModification;return merge(definition,modification)},getEvents=function(info,bList,bData){var baseEvents={"alloy.base.behaviour":toEvents(info)};return combine(bData,info.eventOrder,bList,baseEvents).getOrDie()},build$2=function(spec){var getMe=function(){return me},systemApi=Cell(singleton),info=getOrDie(toInfo(spec)),bBlob=generate$1(spec),bList=getBehaviours$1(bBlob),bData=getData(bBlob),modDefinition=getDomDefinition(info,bList,bData),item=renderToDom(modDefinition),events=getEvents(info,bList,bData),subcomponents=Cell(info.components),connect=function(newApi){systemApi.set(newApi)},disconnect=function(){systemApi.set(NoContextApi(getMe))},syncComponents=function(){var children$1=children(item),subs=bind$3(children$1,(function(child){return systemApi.get().getByDom(child).fold((function(){return[]}),pure$2)}));subcomponents.set(subs)},config=function(behaviour){var b=bData,f;return(isFunction(b[behaviour.name()])?b[behaviour.name()]:function(){throw new Error("Could not find "+behaviour.name()+" in "+JSON.stringify(spec,null,2))})()},hasConfigured=function(behaviour){return isFunction(bData[behaviour.name()])},getApis=function(){return info.apis},readState=function(behaviourName){return bData[behaviourName]().map((function(b){return b.state.readState()})).getOr("not enabled")},me={uid:spec.uid,getSystem:systemApi.get,config:config,hasConfigured:hasConfigured,spec:spec,readState:readState,getApis:getApis,connect:connect,disconnect:disconnect,element:item,syncComponents:syncComponents,components:subcomponents.get,events:events};return me},buildSubcomponents=function(spec){var components=get$c(spec,"components").getOr([]);return map$2(components,build$1)},buildFromSpec=function(userSpec){var _a=make$3(userSpec),specEvents=_a.events,spec=__rest(_a,["events"]),components=buildSubcomponents(spec),completeSpec=__assign(__assign({},spec),{events:__assign(__assign({},DefaultEvents),specEvents),components:components});return Result.value(build$2(completeSpec))},text=function(textContent){var element=SugarElement.fromText(textContent);return external({element:element})},external=function(spec){var extSpec=asRawOrDie$1("external.component",objOfOnly([required$1("element"),option("uid")]),spec),systemApi=Cell(NoContextApi()),connect=function(newApi){systemApi.set(newApi)},disconnect=function(){systemApi.set(NoContextApi((function(){return me})))},uid=extSpec.uid.getOrThunk((function(){return generate$2("external")}));writeOnly(extSpec.element,uid);var me={uid:uid,getSystem:systemApi.get,config:Optional.none,hasConfigured:never,connect:connect,disconnect:disconnect,getApis:function(){return{}},element:extSpec.element,spec:spec,readState:constant$1("No state"),syncComponents:noop,components:constant$1([]),events:{}};return premade$1(me)},uids=generate$2,isSketchSpec=function(spec){return has$2(spec,"uid")},build$1=function(spec){return getPremade(spec).getOrThunk((function(){var userSpecWithUid=isSketchSpec(spec)?spec:__assign({uid:uids("")},spec);return buildFromSpec(userSpecWithUid).getOrDie()}))},premade=premade$1,hoverEvent="alloy.item-hover",focusEvent="alloy.item-focus",onHover=function(item){(search(item.element).isNone()||Focusing.isFocused(item))&&(Focusing.isFocused(item)||Focusing.focus(item),emitWith(item,hoverEvent,{item:item}))},onFocus=function(item){emitWith(item,focusEvent,{item:item})},hover=constant$1(hoverEvent),focus$1=constant$1(focusEvent),builder$2=function(detail){return{dom:detail.dom,domModification:__assign(__assign({},detail.domModification),{attributes:__assign(__assign(__assign({role:detail.toggling.isSome()?"menuitemcheckbox":"menuitem"},detail.domModification.attributes),{"aria-haspopup":detail.hasSubmenu}),detail.hasSubmenu?{"aria-expanded":!1}:{})}),behaviours:SketchBehaviours_augment(detail.itemBehaviours,[detail.toggling.fold(Toggling.revoke,(function(tConfig){return Toggling.config(__assign({aria:{mode:"checked"}},tConfig))})),Focusing.config({ignore:detail.ignoreFocus,stopMousedown:detail.ignoreFocus,onFocus:function(component){onFocus(component)}}),Keying.config({mode:"execution"}),Representing.config({store:{mode:"memory",initialValue:detail.data}}),config("item-type-events",__spreadArray(__spreadArray([],pointerEvents(),!0),[run(mouseover(),onHover),run(focusItem(),Focusing.focus)],!1))]),components:detail.components,eventOrder:detail.eventOrder}},schema$5=[required$1("data"),required$1("components"),required$1("dom"),defaulted("hasSubmenu",!1),option("toggling"),SketchBehaviours_field("itemBehaviours",[Toggling,Focusing,Keying,Representing]),defaulted("ignoreFocus",!1),defaulted("domModification",{}),output("builder",builder$2),defaulted("eventOrder",{})],builder$1=function(detail){return{dom:detail.dom,components:detail.components,events:derive$3([stopper(focusItem())])}},schema$4=[required$1("dom"),required$1("components"),output("builder",builder$1)],owner=constant$1("item-widget"),parts$3=constant$1([required({name:"widget",overrides:function(detail){return{behaviours:derive$2([Representing.config({store:{mode:"manual",getValue:function(_component){return detail.data},setValue:noop}})])}}})]),builder=function(detail){var subs=substitutes(owner(),detail,parts$3()),components$1=components(owner(),detail,subs.internals()),focusWidget=function(component){return getPart(component,detail,"widget").map((function(widget){return Keying.focusIn(widget),widget}))},onHorizontalArrow=function(component,simulatedEvent){return inside(simulatedEvent.event.target)?Optional.none():detail.autofocus?(simulatedEvent.setSource(component.element),Optional.none()):Optional.none()};return{dom:detail.dom,components:components$1,domModification:detail.domModification,events:derive$3([runOnExecute((function(component,simulatedEvent){focusWidget(component).each((function(_widget){simulatedEvent.stop()}))})),run(mouseover(),onHover),run(focusItem(),(function(component,_simulatedEvent){detail.autofocus?focusWidget(component):Focusing.focus(component)}))]),behaviours:SketchBehaviours_augment(detail.widgetBehaviours,[Representing.config({store:{mode:"memory",initialValue:detail.data}}),Focusing.config({ignore:detail.ignoreFocus,onFocus:function(component){onFocus(component)}}),Keying.config({mode:"special",focusIn:detail.autofocus?function(component){focusWidget(component)}:revoke(),onLeft:onHorizontalArrow,onRight:onHorizontalArrow,onEscape:function(component,simulatedEvent){return Focusing.isFocused(component)||detail.autofocus?detail.autofocus?(simulatedEvent.setSource(component.element),Optional.none()):Optional.none():(Focusing.focus(component),Optional.some(!0))}})])}},schema$3=[required$1("uid"),required$1("data"),required$1("components"),required$1("dom"),defaulted("autofocus",!1),defaulted("ignoreFocus",!1),SketchBehaviours_field("widgetBehaviours",[Representing,Focusing,Keying]),defaulted("domModification",{}),defaultUidsSchema(parts$3()),output("builder",builder)],itemSchema=choose$1("type",{widget:schema$3,item:schema$5,separator:schema$4}),configureGrid=function(detail,movementInfo){return{mode:"flatgrid",selector:"."+detail.markers.item,initSize:{numColumns:movementInfo.initSize.numColumns,numRows:movementInfo.initSize.numRows},focusManager:detail.focusManager}},configureMatrix=function(detail,movementInfo){return{mode:"matrix",selectors:{row:movementInfo.rowSelector,cell:"."+detail.markers.item},focusManager:detail.focusManager}},configureMenu=function(detail,movementInfo){return{mode:"menu",selector:"."+detail.markers.item,moveOnTab:movementInfo.moveOnTab,focusManager:detail.focusManager}},parts$2=constant$1([group({factory:{sketch:function(spec){var itemInfo=asRawOrDie$1("menu.spec item",itemSchema,spec);return itemInfo.builder(itemInfo)}},name:"items",unit:"item",defaults:function(detail,u){return has$2(u,"uid")?u:__assign(__assign({},u),{uid:generate$2("item")})},overrides:function(detail,u){return{type:u.type,ignoreFocus:detail.fakeFocus,domModification:{classes:[detail.markers.item]}}}})]),schema$2=constant$1([required$1("value"),required$1("items"),required$1("dom"),required$1("components"),defaulted("eventOrder",{}),field$1("menuBehaviours",[Highlighting,Representing,Composing,Keying]),defaultedOf("movement",{mode:"menu",moveOnTab:!0},choose$1("mode",{grid:[initSize(),output("config",configureGrid)],matrix:[output("config",configureMatrix),required$1("rowSelector")],menu:[defaulted("moveOnTab",!0),output("config",configureMenu)]})),itemMarkers(),defaulted("fakeFocus",!1),defaulted("focusManager",dom$2()),onHandler("onHighlight")]),focus=constant$1("alloy.menu-focus"),make$2=function(detail,components,_spec,_externals){return{uid:detail.uid,dom:detail.dom,markers:detail.markers,behaviours:augment(detail.menuBehaviours,[Highlighting.config({highlightClass:detail.markers.selectedItem,itemClass:detail.markers.item,onHighlight:detail.onHighlight}),Representing.config({store:{mode:"memory",initialValue:detail.value}}),Composing.config({find:Optional.some}),Keying.config(detail.movement.config(detail,detail.movement))]),events:derive$3([run(focus$1(),(function(menu,simulatedEvent){var event=simulatedEvent.event;menu.getSystem().getByDom(event.target).each((function(item){Highlighting.highlight(menu,item),simulatedEvent.stop(),emitWith(menu,focus(),{menu:menu,item:item})}))})),run(hover(),(function(menu,simulatedEvent){var item=simulatedEvent.event.item;Highlighting.highlight(menu,item)}))]),components:components,eventOrder:detail.eventOrder,domModification:{attributes:{role:"menu"}}}},Menu=composite({name:"Menu",configFields:schema$2(),partFields:parts$2(),factory:make$2}),preserve=function(f,container){var dos=getRootNode(container),refocus=active(dos).bind((function(focused){var hasFocus=function(elem){return eq(focused,elem)};return hasFocus(container)?Optional.some(container):descendant$1(container,hasFocus)})),result=f(container);return refocus.each((function(oldFocus){active(dos).filter((function(newFocus){return eq(newFocus,oldFocus)})).fold((function(){focus$3(oldFocus)}),noop)})),result},set=function(component,replaceConfig,replaceState,data){preserve((function(){var newChildren=map$2(data,component.getSystem().build);replaceChildren(component,newChildren)}),component.element)},insert=function(component,replaceConfig,insertion,childSpec){var child=component.getSystem().build(childSpec);attachWith(component,child,insertion)},append=function(component,replaceConfig,replaceState,appendee){insert(component,replaceConfig,append$2,appendee)},prepend=function(component,replaceConfig,replaceState,prependee){insert(component,replaceConfig,prepend$1,prependee)},remove=function(component,replaceConfig,replaceState,removee){var children=contents(component),foundChild;find$2(children,(function(child){return eq(removee.element,child.element)})).each(detach)},contents=function(component,_replaceConfig){return component.components()},replaceAt=function(component,replaceConfig,replaceState,replaceeIndex,replacer){var children=contents(component);return Optional.from(children[replaceeIndex]).map((function(replacee){return remove(component,replaceConfig,replaceState,replacee),replacer.each((function(r){insert(component,replaceConfig,(function(p,c){appendAt(p,c,replaceeIndex)}),r)})),replacee}))},replaceBy=function(component,replaceConfig,replaceState,replaceePred,replacer){var children=contents(component);return findIndex$1(children,replaceePred).bind((function(replaceeIndex){return replaceAt(component,replaceConfig,replaceState,replaceeIndex,replacer)}))},ReplaceApis,Replacing=create$5({fields:[],name:"replacing",apis:Object.freeze({__proto__:null,append:append,prepend:prepend,remove:remove,replaceAt:replaceAt,replaceBy:replaceBy,set:set,contents:contents})}),transpose=function(obj){return tupleMap(obj,(function(v,k){return{k:v,v:k}}))},trace=function(items,byItem,byMenu,finish){return get$c(byMenu,finish).bind((function(triggerItem){return get$c(items,triggerItem).bind((function(triggerMenu){var rest=trace(items,byItem,byMenu,triggerMenu);return Optional.some([triggerMenu].concat(rest))}))})).getOr([])},generate=function(menus,expansions){var items={};each(menus,(function(menuItems,menu){each$1(menuItems,(function(item){items[item]=menu}))}));var byItem=expansions,byMenu=transpose(expansions),menuPaths=map$1(byMenu,(function(_triggerItem,submenu){return[submenu].concat(trace(items,byItem,byMenu,submenu))}));return map$1(items,(function(menu){return get$c(menuPaths,menu).getOr([menu])}))},init$2=function(){var expansions=Cell({}),menus=Cell({}),paths=Cell({}),primary=value(),directory=Cell({}),clear,isClear,setMenuBuilt,setContents,getTriggeringItem=function(menuValue){return find(expansions.get(),(function(v,_k){return v===menuValue}))},getTriggerData=function(menuValue,getItemByValue,path){return getPreparedMenu(menuValue).bind((function(menu){return getTriggeringItem(menuValue).bind((function(triggeringItemValue){return getItemByValue(triggeringItemValue).map((function(triggeredItem){return{triggeredMenu:menu,triggeringItem:triggeredItem,triggeringPath:path}}))}))}))},getTriggeringPath=function(itemValue,getItemByValue){var extraPath=filter$2(lookupItem(itemValue).toArray(),(function(menuValue){return getPreparedMenu(menuValue).isSome()}));return get$c(paths.get(),itemValue).bind((function(path){var revPath=reverse(extraPath.concat(path)),triggers=bind$3(revPath,(function(menuValue,menuIndex){return getTriggerData(menuValue,getItemByValue,revPath.slice(0,menuIndex+1)).fold((function(){return is(primary.get(),menuValue)?[]:[Optional.none()]}),(function(data){return[Optional.some(data)]}))}));return sequence(triggers)}))},expand,collapse,refresh,getPreparedMenu=function(menuValue){return lookupMenu(menuValue).bind(extractPreparedMenu)},lookupMenu=function(menuValue){return get$c(menus.get(),menuValue)},lookupItem=function(itemValue){return get$c(expansions.get(),itemValue)},otherMenus,getPrimary,getMenus;return{setMenuBuilt:function(menuName,built){var _a;menus.set(__assign(__assign({},menus.get()),((_a={})[menuName]={type:"prepared",menu:built},_a)))},setContents:function(sPrimary,sMenus,sExpansions,dir){primary.set(sPrimary),expansions.set(sExpansions),menus.set(sMenus),directory.set(dir);var sPaths=generate(dir,sExpansions);paths.set(sPaths)},expand:function(itemValue){return get$c(expansions.get(),itemValue).map((function(menu){var current=get$c(paths.get(),itemValue).getOr([]);return[menu].concat(current)}))},refresh:function(itemValue){return get$c(paths.get(),itemValue)},collapse:function(itemValue){return get$c(paths.get(),itemValue).bind((function(path){return path.length>1?Optional.some(path.slice(1)):Optional.none()}))},lookupMenu:lookupMenu,lookupItem:lookupItem,otherMenus:function(path){var menuValues=directory.get();return difference(keys(menuValues),path)},getPrimary:function(){return primary.get().bind(getPreparedMenu)},getMenus:function(){return menus.get()},clear:function(){expansions.set({}),menus.set({}),paths.set({}),primary.clear()},isClear:function(){return primary.get().isNone()},getTriggeringPath:getTriggeringPath}},extractPreparedMenu=function(prep){return"prepared"===prep.type?Optional.some(prep.menu):Optional.none()},LayeredState={init:init$2,extractPreparedMenu:extractPreparedMenu},make$1=function(detail,_rawUiSpec){var submenuParentItems=value(),buildMenus=function(container,primaryName,menus){return map$1(menus,(function(spec,name){var makeSketch=function(){return Menu.sketch(__assign(__assign({},spec),{value:name,markers:detail.markers,fakeFocus:detail.fakeFocus,onHighlight:detail.onHighlight,focusManager:detail.fakeFocus?highlights():dom$2()}))};return name===primaryName?{type:"prepared",menu:container.getSystem().build(makeSketch())}:{type:"notbuilt",nbMenu:makeSketch}}))},layeredState=LayeredState.init(),setup=function(container){var componentMap=buildMenus(container,detail.data.primary,detail.data.menus),directory=toDirectory();return layeredState.setContents(detail.data.primary,componentMap,detail.data.expansions,directory),layeredState.getPrimary()},getItemValue=function(item){return Representing.getValue(item).value},getItemByValue=function(_container,menus,itemValue){return findMap(menus,(function(menu){if(!menu.getSystem().isConnected())return Optional.none();var candidates=Highlighting.getCandidates(menu);return find$2(candidates,(function(c){return getItemValue(c)===itemValue}))}))},toDirectory=function(_container){return map$1(detail.data.menus,(function(data,_menuName){return bind$3(data.items,(function(item){return"separator"===item.type?[]:[item.data.value]}))}))},setActiveMenu=function(container,menu){Highlighting.highlight(container,menu),Highlighting.getHighlighted(menu).orThunk((function(){return Highlighting.getFirst(menu)})).each((function(item){dispatch(container,item.element,focusItem())}))},getMenus=function(state,menuValues){return cat(map$2(menuValues,(function(mv){return state.lookupMenu(mv).bind((function(prep){return"prepared"===prep.type?Optional.some(prep.menu):Optional.none()}))})))},closeOthers=function(container,state,path){var others=getMenus(state,state.otherMenus(path));each$1(others,(function(o){remove$1(o.element,[detail.markers.backgroundMenu]),detail.stayInDom||Replacing.remove(container,o)}))},getSubmenuParents=function(container){return submenuParentItems.get().getOrThunk((function(){var r={},items=descendants(container.element,"."+detail.markers.item),parentItems=filter$2(items,(function(i){return"true"===get$b(i,"aria-haspopup")}));return each$1(parentItems,(function(i){container.getSystem().getByDom(i).each((function(itemComp){var key=getItemValue(itemComp);r[key]=itemComp}))})),submenuParentItems.set(r),r}))},updateAriaExpansions=function(container,path){var parentItems=getSubmenuParents(container);each(parentItems,(function(v,k){var expanded=contains$1(path,k);set$8(v.element,"aria-expanded",expanded)}))},updateMenuPath=function(container,state,path){return Optional.from(path[0]).bind((function(latestMenuName){return state.lookupMenu(latestMenuName).bind((function(menuPrep){if("notbuilt"===menuPrep.type)return Optional.none();var activeMenu=menuPrep.menu,rest=getMenus(state,path.slice(1));return each$1(rest,(function(r){add$1(r.element,detail.markers.backgroundMenu)})),inBody(activeMenu.element)||Replacing.append(container,premade(activeMenu)),remove$1(activeMenu.element,[detail.markers.backgroundMenu]),setActiveMenu(container,activeMenu),closeOthers(container,state,path),Optional.some(activeMenu)}))}))},ExpandHighlightDecision;!function(ExpandHighlightDecision){ExpandHighlightDecision[ExpandHighlightDecision.HighlightSubmenu=0]="HighlightSubmenu",ExpandHighlightDecision[ExpandHighlightDecision.HighlightParent=1]="HighlightParent"}(ExpandHighlightDecision||(ExpandHighlightDecision={}));var buildIfRequired=function(container,menuName,menuPrep){if("notbuilt"===menuPrep.type){var menu=container.getSystem().build(menuPrep.nbMenu());return layeredState.setMenuBuilt(menuName,menu),menu}return menuPrep.menu},expandRight=function(container,item,decision){if(void 0===decision&&(decision=ExpandHighlightDecision.HighlightSubmenu),item.hasConfigured(Disabling)&&Disabling.isDisabled(item))return Optional.some(item);var value=getItemValue(item);return layeredState.expand(value).bind((function(path){return updateAriaExpansions(container,path),Optional.from(path[0]).bind((function(menuName){return layeredState.lookupMenu(menuName).bind((function(activeMenuPrep){var activeMenu=buildIfRequired(container,menuName,activeMenuPrep);return inBody(activeMenu.element)||Replacing.append(container,premade(activeMenu)),detail.onOpenSubmenu(container,item,activeMenu,reverse(path)),decision===ExpandHighlightDecision.HighlightSubmenu?(Highlighting.highlightFirst(activeMenu),updateMenuPath(container,layeredState,path)):(Highlighting.dehighlightAll(activeMenu),Optional.some(item))}))}))}))},collapseLeft=function(container,item){var value=getItemValue(item);return layeredState.collapse(value).bind((function(path){return updateAriaExpansions(container,path),updateMenuPath(container,layeredState,path).map((function(activeMenu){return detail.onCollapseMenu(container,item,activeMenu),activeMenu}))}))},updateView=function(container,item){var value=getItemValue(item);return layeredState.refresh(value).bind((function(path){return updateAriaExpansions(container,path),updateMenuPath(container,layeredState,path)}))},onRight=function(container,item){return inside(item.element)?Optional.none():expandRight(container,item,ExpandHighlightDecision.HighlightSubmenu)},onLeft=function(container,item){return inside(item.element)?Optional.none():collapseLeft(container,item)},onEscape=function(container,item){return collapseLeft(container,item).orThunk((function(){return detail.onEscape(container,item).map((function(){return container}))}))},keyOnItem=function(f){return function(container,simulatedEvent){return closest$1(simulatedEvent.getSource(),"."+detail.markers.item).bind((function(target){return container.getSystem().getByDom(target).toOptional().bind((function(item){return f(container,item).map(always)}))}))}},events=derive$3([run(focus(),(function(sandbox,simulatedEvent){var item=simulatedEvent.event.item;layeredState.lookupItem(getItemValue(item)).each((function(){var menu=simulatedEvent.event.menu;Highlighting.highlight(sandbox,menu);var value=getItemValue(simulatedEvent.event.item);layeredState.refresh(value).each((function(path){return closeOthers(sandbox,layeredState,path)}))}))})),runOnExecute((function(component,simulatedEvent){var target=simulatedEvent.event.target;component.getSystem().getByDom(target).each((function(item){var itemValue;0===getItemValue(item).indexOf("collapse-item")&&collapseLeft(component,item),expandRight(component,item,ExpandHighlightDecision.HighlightSubmenu).fold((function(){detail.onExecute(component,item)}),noop)}))})),runOnAttached((function(container,_simulatedEvent){setup(container).each((function(primary){Replacing.append(container,premade(primary)),detail.onOpenMenu(container,primary),detail.highlightImmediately&&setActiveMenu(container,primary)}))}))].concat(detail.navigateOnHover?[run(hover(),(function(sandbox,simulatedEvent){var item=simulatedEvent.event.item;updateView(sandbox,item),expandRight(sandbox,item,ExpandHighlightDecision.HighlightParent),detail.onHover(sandbox,item)}))]:[])),getActiveItem=function(container){return Highlighting.getHighlighted(container).bind(Highlighting.getHighlighted)},collapseMenuApi,highlightPrimary,extractMenuFromContainer=function(container){return Optional.from(container.components()[0]).filter((function(comp){return"menu"===get$b(comp.element,"role")}))},repositionMenus,apis={collapseMenu:function(container){getActiveItem(container).each((function(currentItem){collapseLeft(container,currentItem)}))},highlightPrimary:function(container){layeredState.getPrimary().each((function(primary){setActiveMenu(container,primary)}))},repositionMenus:function(container){var maybeActivePrimary;layeredState.getPrimary().bind((function(primary){return getActiveItem(container).bind((function(currentItem){var itemValue=getItemValue(currentItem),allMenus=values(layeredState.getMenus()),preparedMenus=cat(map$2(allMenus,LayeredState.extractPreparedMenu));return layeredState.getTriggeringPath(itemValue,(function(v){return getItemByValue(container,preparedMenus,v)}))})).map((function(triggeringPath){return{primary:primary,triggeringPath:triggeringPath}}))})).fold((function(){extractMenuFromContainer(container).each((function(primaryMenu){detail.onRepositionMenu(container,primaryMenu,[])}))}),(function(_a){var primary=_a.primary,triggeringPath=_a.triggeringPath;detail.onRepositionMenu(container,primary,triggeringPath)}))}};return{uid:detail.uid,dom:detail.dom,markers:detail.markers,behaviours:augment(detail.tmenuBehaviours,[Keying.config({mode:"special",onRight:keyOnItem(onRight),onLeft:keyOnItem(onLeft),onEscape:keyOnItem(onEscape),focusIn:function(container,_keyInfo){layeredState.getPrimary().each((function(primary){dispatch(container,primary.element,focusItem())}))}}),Highlighting.config({highlightClass:detail.markers.selectedMenu,itemClass:detail.markers.menu}),Composing.config({find:function(container){return Highlighting.getHighlighted(container)}}),Replacing.config({})]),eventOrder:detail.eventOrder,apis:apis,events:events}},collapseItem$1=constant$1("collapse-item"),tieredData=function(primary,menus,expansions){return{primary:primary,menus:menus,expansions:expansions}},singleData=function(name,menu){return{primary:name,menus:wrap(name,menu),expansions:{}}},collapseItem=function(text){return{value:generate$4(collapseItem$1()),meta:{text:text}}},tieredMenu=single({name:"TieredMenu",configFields:[onStrictKeyboardHandler("onExecute"),onStrictKeyboardHandler("onEscape"),onStrictHandler("onOpenMenu"),onStrictHandler("onOpenSubmenu"),onHandler("onRepositionMenu"),onHandler("onCollapseMenu"),defaulted("highlightImmediately",!0),requiredObjOf("data",[required$1("primary"),required$1("menus"),required$1("expansions")]),defaulted("fakeFocus",!1),onHandler("onHighlight"),onHandler("onHover"),tieredMenuMarkers(),required$1("dom"),defaulted("navigateOnHover",!0),defaulted("stayInDom",!1),field$1("tmenuBehaviours",[Keying,Highlighting,Composing,Replacing]),defaulted("eventOrder",{})],apis:{collapseMenu:function(apis,tmenu){apis.collapseMenu(tmenu)},highlightPrimary:function(apis,tmenu){apis.highlightPrimary(tmenu)},repositionMenus:function(apis,tmenu){apis.repositionMenus(tmenu)}},factory:make$1,extraApis:{tieredData:tieredData,singleData:singleData,collapseItem:collapseItem}}),findRoute=function(component,transConfig,transState,route){return get$c(transConfig.routes,route.start).bind((function(sConfig){return get$c(sConfig,route.destination)}))},getTransition=function(comp,transConfig,transState){var route;return getCurrentRoute(comp,transConfig).bind((function(r){return getTransitionOf(comp,transConfig,transState,r)}))},getTransitionOf=function(comp,transConfig,transState,route){return findRoute(comp,transConfig,transState,route).bind((function(r){return r.transition.map((function(t){return{transition:t,route:r}}))}))},disableTransition=function(comp,transConfig,transState){getTransition(comp,transConfig,transState).each((function(routeTransition){var t=routeTransition.transition;remove$3(comp.element,t.transitionClass),remove$6(comp.element,transConfig.destinationAttr)}))},getNewRoute=function(comp,transConfig,transState,destination){return{start:get$b(comp.element,transConfig.stateAttr),destination:destination}},getCurrentRoute=function(comp,transConfig,_transState){var el=comp.element;return getOpt(el,transConfig.destinationAttr).map((function(destination){return{start:get$b(comp.element,transConfig.stateAttr),destination:destination}}))},jumpTo=function(comp,transConfig,transState,destination){disableTransition(comp,transConfig,transState),has$1(comp.element,transConfig.stateAttr)&&get$b(comp.element,transConfig.stateAttr)!==destination&&transConfig.onFinish(comp,destination),set$8(comp.element,transConfig.stateAttr,destination)},fasttrack=function(comp,transConfig,_transState,_destination){has$1(comp.element,transConfig.destinationAttr)&&(getOpt(comp.element,transConfig.destinationAttr).each((function(destination){set$8(comp.element,transConfig.stateAttr,destination)})),remove$6(comp.element,transConfig.destinationAttr))},progressTo=function(comp,transConfig,transState,destination){fasttrack(comp,transConfig);var route=getNewRoute(comp,transConfig,transState,destination);getTransitionOf(comp,transConfig,transState,route).fold((function(){jumpTo(comp,transConfig,transState,destination)}),(function(routeTransition){disableTransition(comp,transConfig,transState);var t=routeTransition.transition;add$1(comp.element,t.transitionClass),set$8(comp.element,transConfig.destinationAttr,destination)}))},getState=function(comp,transConfig,_transState){return getOpt(comp.element,transConfig.stateAttr)},TransitionApis=Object.freeze({__proto__:null,findRoute:findRoute,disableTransition:disableTransition,getCurrentRoute:getCurrentRoute,jumpTo:jumpTo,progressTo:progressTo,getState:getState}),events$1=function(transConfig,transState){return derive$3([run(transitionend(),(function(component,simulatedEvent){var raw=simulatedEvent.event.raw;getCurrentRoute(component,transConfig).each((function(route){findRoute(component,transConfig,transState,route).each((function(rInfo){rInfo.transition.each((function(rTransition){raw.propertyName===rTransition.property&&(jumpTo(component,transConfig,transState,route.destination),transConfig.onTransition(component,route))}))}))}))})),runOnAttached((function(comp,_se){jumpTo(comp,transConfig,transState,transConfig.initialState)}))])},ActiveTransitioning=Object.freeze({__proto__:null,events:events$1}),TransitionSchema=[defaulted("destinationAttr","data-transitioning-destination"),defaulted("stateAttr","data-transitioning-state"),required$1("initialState"),onHandler("onTransition"),onHandler("onFinish"),requiredOf("routes",setOf(Result.value,setOf(Result.value,objOfOnly([optionObjOfOnly("transition",[required$1("property"),required$1("transitionClass")])]))))],createRoutes,createBistate,createTristate,Transitioning=create$5({fields:TransitionSchema,name:"transitioning",active:ActiveTransitioning,apis:TransitionApis,extra:{createRoutes:function(routes){var r={};return each(routes,(function(v,k){var waypoints=k.split("<->");r[waypoints[0]]=wrap(waypoints[1],v),r[waypoints[1]]=wrap(waypoints[0],v)})),r},createBistate:function(first,second,transitions){return wrapAll([{key:first,value:wrap(second,transitions)},{key:second,value:wrap(first,transitions)}])},createTristate:function(first,second,third,transitions){return wrapAll([{key:first,value:wrapAll([{key:second,value:transitions},{key:third,value:transitions}])},{key:second,value:wrapAll([{key:first,value:transitions},{key:third,value:transitions}])},{key:third,value:wrapAll([{key:first,value:transitions},{key:second,value:transitions}])}])}}}),scrollableStyle=resolve("scrollable"),register$2=function(element){add$1(element,scrollableStyle)},deregister=function(element){remove$3(element,scrollableStyle)},scrollable=scrollableStyle,getValue=function(item){return get$c(item,"format").getOr(item.title)},convert=function(formats,memMenuThunk){var mainMenu=makeMenu("Styles",[].concat(map$2(formats.items,(function(k){return makeItem(getValue(k),k.title,k.isSelected(),k.getPreview(),hasNonNullableKey(formats.expansions,getValue(k)))}))),memMenuThunk,!1),submenus=map$1(formats.menus,(function(menuItems,menuName){var items=map$2(menuItems,(function(item){return makeItem(getValue(item),item.title,void 0!==item.isSelected&&item.isSelected(),void 0!==item.getPreview?item.getPreview():"",hasNonNullableKey(formats.expansions,getValue(item)))}));return makeMenu(menuName,items,memMenuThunk,!0)})),menus=deepMerge(submenus,wrap("styles",mainMenu)),tmenu;return{tmenu:tieredMenu.tieredData("styles",menus,formats.expansions)}},makeItem=function(value,text,selected,preview,isMenu){return{data:{value:value,text:text},type:"item",dom:{tag:"div",classes:isMenu?[resolve("styles-item-is-menu")]:[]},toggling:{toggleOnExecute:!1,toggleClass:resolve("format-matches"),selected:selected},itemBehaviours:derive$2(isMenu?[]:[format(value,(function(comp,status){var toggle;(status?Toggling.on:Toggling.off)(comp)}))]),components:[{dom:{tag:"div",attributes:{style:preview},innerHtml:text}}]}},makeMenu=function(value,items,memMenuThunk,collapsable){return{value:value,dom:{tag:"div"},components:[Button.sketch({dom:{tag:"div",classes:[resolve("styles-collapser")]},components:collapsable?[{dom:{tag:"span",classes:[resolve("styles-collapse-icon")]}},text(value)]:[text(value)],action:function(item){if(collapsable){var comp=memMenuThunk().get(item);tieredMenu.collapseMenu(comp)}}}),{dom:{tag:"div",classes:[resolve("styles-menu-items-container")]},components:[Menu.parts.items({})],behaviours:derive$2([config("adhoc-scrollable-menu",[runOnAttached((function(component,_simulatedEvent){set$5(component.element,"overflow-y","auto"),set$5(component.element,"-webkit-overflow-scrolling","touch"),register$2(component.element)})),runOnDetached((function(component){remove$2(component.element,"overflow-y"),remove$2(component.element,"-webkit-overflow-scrolling"),deregister(component.element)}))])])}],items:items,menuBehaviours:derive$2([Transitioning.config({initialState:"after",routes:Transitioning.createTristate("before","current","after",{transition:{property:"transform",transitionClass:"transitioning"}})})])}},sketch$1=function(settings){var dataset=convert(settings.formats,(function(){return memMenu})),memMenu=record(tieredMenu.sketch({dom:{tag:"div",classes:[resolve("styles-menu")]},components:[],fakeFocus:!0,stayInDom:!0,onExecute:function(_tmenu,item){var v=Representing.getValue(item);return settings.handle(item,v.value),Optional.none()},onEscape:function(){return Optional.none()},onOpenMenu:function(container,menu){var w=get$5(container.element);set$4(menu.element,w),Transitioning.jumpTo(menu,"current")},onOpenSubmenu:function(container,item,submenu){var w=get$5(container.element),menu=ancestor(item.element,'[role="menu"]').getOrDie("hacky"),menuComp=container.getSystem().getByDom(menu).getOrDie();set$4(submenu.element,w),Transitioning.progressTo(menuComp,"before"),Transitioning.jumpTo(submenu,"after"),Transitioning.progressTo(submenu,"current")},onCollapseMenu:function(container,item,menu){var submenu=ancestor(item.element,'[role="menu"]').getOrDie("hacky"),submenuComp=container.getSystem().getByDom(submenu).getOrDie();Transitioning.progressTo(submenuComp,"after"),Transitioning.progressTo(menu,"current")},navigateOnHover:!1,highlightImmediately:!0,data:dataset.tmenu,markers:{backgroundMenu:resolve("styles-background-menu"),menu:resolve("styles-menu"),selectedMenu:resolve("styles-selected-menu"),item:resolve("styles-item"),selectedItem:resolve("styles-selected-item")}}));return memMenu.asSpec()},getFromExpandingItem=function(item){var newItem=deepMerge(exclude(item,["items"]),{menu:!0}),rest=expand(item.items),newMenus,newExpansions;return{item:newItem,menus:deepMerge(rest.menus,wrap(item.title,rest.items)),expansions:deepMerge(rest.expansions,wrap(item.title,item.title))}},getFromItem=function(item){return hasNonNullableKey(item,"items")?getFromExpandingItem(item):{item:item,menus:{},expansions:{}}},expand=function(items){return foldr(items,(function(acc,item){var newData=getFromItem(item);return{menus:deepMerge(acc.menus,newData.menus),items:[newData.item].concat(acc.items),expansions:deepMerge(acc.expansions,newData.expansions)}}),{menus:{},expansions:{},items:[]})},register$1=function(editor){var isSelectedFor=function(format){return function(){return editor.formatter.match(format)}},getPreview=function(format){return function(){return editor.formatter.getCssText(format)}},enrichSupported=function(item){return deepMerge(item,{isSelected:isSelectedFor(item.format),getPreview:getPreview(item.format)})},enrichMenu=function(item){return deepMerge(item,{isSelected:never,getPreview:constant$1("")})},enrichCustom=function(item){var formatName=generate$4(item.title),newItem=deepMerge(item,{format:formatName,isSelected:isSelectedFor(formatName),getPreview:getPreview(formatName)});return editor.formatter.register(formatName,newItem),newItem},doEnrich=function(items){return map$2(items,(function(item){if(hasNonNullableKey(item,"items")){var newItems=doEnrich(item.items);return deepMerge(enrichMenu(item),{items:newItems})}return hasNonNullableKey(item,"format")?enrichSupported(item):enrichCustom(item)}))};return doEnrich(getStyleFormats(editor))},prune=function(editor,formats){var doPrune=function(items){return bind$3(items,(function(item){var newItems,keep;return void 0!==item.items?doPrune(item.items).length>0?[item]:[]:!hasNonNullableKey(item,"format")||editor.formatter.canApply(item.format)?[item]:[]}))},prunedItems=doPrune(formats);return expand(prunedItems)},ui=function(editor,formats,onDone){var pruned=prune(editor,formats);return sketch$1({formats:pruned,handle:function(item,value){editor.undoManager.transact((function(){Toggling.isOn(item)?editor.formatter.remove(value):editor.formatter.apply(value)})),onDone()}})},extract=function(rawToolbar){var toolbar=rawToolbar.replace(/\|/g," ").trim();return toolbar.length>0?toolbar.split(/\s+/):[]},identifyFromArray=function(toolbar){return bind$3(toolbar,(function(item){return isArray(item)?identifyFromArray(item):extract(item)}))},identify=function(editor){var toolbar=getToolbar(editor);return isArray(toolbar)?identifyFromArray(toolbar):extract(toolbar)},setup$3=function(realm,editor){var commandSketch=function(name){return function(){return forToolbarCommand(editor,name)}},stateCommandSketch=function(name){return function(){return forToolbarStateCommand(editor,name)}},actionSketch=function(name,query,action){return function(){return forToolbarStateAction(editor,name,query,action)}},undo=commandSketch("undo"),redo=commandSketch("redo"),bold=stateCommandSketch("bold"),italic=stateCommandSketch("italic"),underline=stateCommandSketch("underline"),removeformat=commandSketch("removeformat"),link=function(){return sketch$2(realm,editor)},unlink=actionSketch("unlink","link",(function(){editor.execCommand("unlink",null,!1)})),image=function(){return sketch$5(editor)},bullist=actionSketch("unordered-list","ul",(function(){editor.execCommand("InsertUnorderedList",null,!1)})),numlist=actionSketch("ordered-list","ol",(function(){editor.execCommand("InsertOrderedList",null,!1)})),fontsizeselect=function(){return sketch$6(realm,editor)},forecolor=function(){return sketch$8(realm,editor)},styleFormats=register$1(editor),styleFormatsMenu=function(){return ui(editor,styleFormats,(function(){editor.fire("scrollIntoView")}))},styleselect=function(){return forToolbar("style-formats",(function(button){editor.fire("toReading"),realm.dropup.appear(styleFormatsMenu,Toggling.on,button)}),derive$2([Toggling.config({toggleClass:resolve("toolbar-button-selected"),toggleOnExecute:!1,aria:{mode:"pressed"}}),Receiving.config({channels:wrapAll([receive(orientationChanged,Toggling.off),receive(dropupDismissed,Toggling.off)])})]),editor)},feature=function(prereq,sketch){return{isSupported:function(){var buttons=editor.ui.registry.getAll().buttons;return prereq.forall((function(p){return hasNonNullableKey(buttons,p)}))},sketch:sketch}};return{undo:feature(Optional.none(),undo),redo:feature(Optional.none(),redo),bold:feature(Optional.none(),bold),italic:feature(Optional.none(),italic),underline:feature(Optional.none(),underline),removeformat:feature(Optional.none(),removeformat),link:feature(Optional.none(),link),unlink:feature(Optional.none(),unlink),image:feature(Optional.none(),image),bullist:feature(Optional.some("bullist"),bullist),numlist:feature(Optional.some("numlist"),numlist),fontsizeselect:feature(Optional.none(),fontsizeselect),forecolor:feature(Optional.none(),forecolor),styleselect:feature(Optional.none(),styleselect)}},detect=function(editor,features){var itemNames=identify(editor),present={};return bind$3(itemNames,(function(iName){var r=!hasNonNullableKey(present,iName)&&hasNonNullableKey(features,iName)&&features[iName].isSupported()?[features[iName].sketch()]:[];return present[iName]=!0,r}))},mkEvent=function(target,x,y,stop,prevent,kill,raw){return{target:target,x:x,y:y,stop:stop,prevent:prevent,kill:kill,raw:raw}},fromRawEvent=function(rawEvent){var target=SugarElement.fromDom(getOriginalEventTarget(rawEvent).getOr(rawEvent.target)),stop=function(){return rawEvent.stopPropagation()},prevent=function(){return rawEvent.preventDefault()},kill=compose(prevent,stop);return mkEvent(target,rawEvent.clientX,rawEvent.clientY,stop,prevent,kill,rawEvent)},handle=function(filter,handler){return function(rawEvent){filter(rawEvent)&&handler(fromRawEvent(rawEvent))}},binder=function(element,event,filter,handler,useCapture){var wrapped=handle(filter,handler);return element.dom.addEventListener(event,wrapped,useCapture),{unbind:curry(unbind,element,event,wrapped,useCapture)}},bind$1=function(element,event,filter,handler){return binder(element,event,filter,handler,!1)},capture$1=function(element,event,filter,handler){return binder(element,event,filter,handler,!0)},unbind=function(element,event,handler,useCapture){element.dom.removeEventListener(event,handler,useCapture)},filter=always,bind=function(element,event,handler){return bind$1(element,event,filter,handler)},capture=function(element,event,handler){return capture$1(element,event,filter,handler)},global$2=tinymce.util.Tools.resolve("tinymce.util.Delay"),INTERVAL=50,INSURANCE=20,get$1=function(outerWindow){var isPortrait=outerWindow.matchMedia("(orientation: portrait)").matches;return{isPortrait:constant$1(isPortrait)}},getActualWidth=function(outerWindow){var isIos=detect$1().os.isiOS(),isPortrait=get$1(outerWindow).isPortrait();return isIos&&!isPortrait?outerWindow.screen.height:outerWindow.screen.width},onChange=function(outerWindow,listeners){var win=SugarElement.fromDom(outerWindow),poller=null,change,orientationHandle=bind(win,"orientationchange",(function(){global$2.clearInterval(poller);var orientation=get$1(outerWindow);listeners.onChange(orientation),onAdjustment((function(){listeners.onReady(orientation)}))})),onAdjustment=function(f){global$2.clearInterval(poller);var flag=outerWindow.innerHeight,insurance=0;poller=global$2.setInterval((function(){flag!==outerWindow.innerHeight?(global$2.clearInterval(poller),f(Optional.some(outerWindow.innerHeight))):insurance>20&&(global$2.clearInterval(poller),f(Optional.none())),insurance++}),50)},destroy;return{onAdjustment:onAdjustment,destroy:function(){orientationHandle.unbind()}}},setStart=function(rng,situ){situ.fold((function(e){rng.setStartBefore(e.dom)}),(function(e,o){rng.setStart(e.dom,o)}),(function(e){rng.setStartAfter(e.dom)}))},setFinish=function(rng,situ){situ.fold((function(e){rng.setEndBefore(e.dom)}),(function(e,o){rng.setEnd(e.dom,o)}),(function(e){rng.setEndAfter(e.dom)}))},relativeToNative=function(win,startSitu,finishSitu){var range=win.document.createRange();return setStart(range,startSitu),setFinish(range,finishSitu),range},exactToNative=function(win,start,soffset,finish,foffset){var rng=win.document.createRange();return rng.setStart(start.dom,soffset),rng.setEnd(finish.dom,foffset),rng},toRect$1=function(rect){return{left:rect.left,top:rect.top,right:rect.right,bottom:rect.bottom,width:rect.width,height:rect.height}},getFirstRect$1=function(rng){var rects=rng.getClientRects(),rect=rects.length>0?rects[0]:rng.getBoundingClientRect();return rect.width>0||rect.height>0?Optional.some(rect).map(toRect$1):Optional.none()},adt$3=Adt_generate([{ltr:["start","soffset","finish","foffset"]},{rtl:["start","soffset","finish","foffset"]}]),fromRange=function(win,type,range){return type(SugarElement.fromDom(range.startContainer),range.startOffset,SugarElement.fromDom(range.endContainer),range.endOffset)},getRanges=function(win,selection){return selection.match({domRange:function(rng){return{ltr:constant$1(rng),rtl:Optional.none}},relative:function(startSitu,finishSitu){return{ltr:cached((function(){return relativeToNative(win,startSitu,finishSitu)})),rtl:cached((function(){return Optional.some(relativeToNative(win,finishSitu,startSitu))}))}},exact:function(start,soffset,finish,foffset){return{ltr:cached((function(){return exactToNative(win,start,soffset,finish,foffset)})),rtl:cached((function(){return Optional.some(exactToNative(win,finish,foffset,start,soffset))}))}}})},doDiagnose=function(win,ranges){var rng=ranges.ltr(),reversed;return rng.collapsed?ranges.rtl().filter((function(rev){return!1===rev.collapsed})).map((function(rev){return adt$3.rtl(SugarElement.fromDom(rev.endContainer),rev.endOffset,SugarElement.fromDom(rev.startContainer),rev.startOffset)})).getOrThunk((function(){return fromRange(win,adt$3.ltr,rng)})):fromRange(win,adt$3.ltr,rng)},diagnose=function(win,selection){var ranges=getRanges(win,selection);return doDiagnose(win,ranges)},asLtrRange=function(win,selection){var diagnosis;return diagnose(win,selection).match({ltr:function(start,soffset,finish,foffset){var rng=win.document.createRange();return rng.setStart(start.dom,soffset),rng.setEnd(finish.dom,foffset),rng},rtl:function(start,soffset,finish,foffset){var rng=win.document.createRange();return rng.setStart(finish.dom,foffset),rng.setEnd(start.dom,soffset),rng}})};adt$3.ltr,adt$3.rtl;var create$3,SimRange_create=function(start,soffset,finish,foffset){return{start:start,soffset:soffset,finish:finish,foffset:foffset}},NodeValue,api=function(is,name){var get=function(element){if(!is(element))throw new Error("Can only get "+name+" value of a "+name+" node");return getOption(element).getOr("")},getOption=function(element){return is(element)?Optional.from(element.dom.nodeValue):Optional.none()},set;return{get:get,getOption:getOption,set:function(element,value){if(!is(element))throw new Error("Can only set raw "+name+" value of a "+name+" node");element.dom.nodeValue=value}}}(isText,"text"),getOption=function(element){return api.getOption(element)},getEnd=function(element){return"img"===name$1(element)?1:getOption(element).fold((function(){return children(element).length}),(function(v){return v.length}))},adt$2=Adt_generate([{before:["element"]},{on:["element","offset"]},{after:["element"]}]),cata=function(subject,onBefore,onOn,onAfter){return subject.fold(onBefore,onOn,onAfter)},getStart$1=function(situ){return situ.fold(identity,identity,identity)},before,on,after$1,Situ={before:adt$2.before,on:adt$2.on,after:adt$2.after,cata:cata,getStart:getStart$1},adt$1=Adt_generate([{domRange:["rng"]},{relative:["startSitu","finishSitu"]},{exact:["start","soffset","finish","foffset"]}]),exactFromRange=function(simRange){return adt$1.exact(simRange.start,simRange.soffset,simRange.finish,simRange.foffset)},getStart=function(selection){return selection.match({domRange:function(rng){return SugarElement.fromDom(rng.startContainer)},relative:function(startSitu,_finishSitu){return Situ.getStart(startSitu)},exact:function(start,_soffset,_finish,_foffset){return start}})},domRange,relative,exact,getWin$1,range,SimSelection={domRange:adt$1.domRange,relative:adt$1.relative,exact:adt$1.exact,exactFromRange:exactFromRange,getWin:function(selection){var start=getStart(selection);return defaultView(start)},range:SimRange_create},beforeSpecial=function(element,offset){var name=name$1(element);return"input"===name?Situ.after(element):contains$1(["br","img"],name)?0===offset?Situ.before(element):Situ.after(element):Situ.on(element,offset)},preprocessExact=function(start,soffset,finish,foffset){var startSitu=beforeSpecial(start,soffset),finishSitu=beforeSpecial(finish,foffset);return SimSelection.relative(startSitu,finishSitu)},makeRange=function(start,soffset,finish,foffset){var doc,rng=owner$2(start).dom.createRange();return rng.setStart(start.dom,soffset),rng.setEnd(finish.dom,foffset),rng},after=function(start,soffset,finish,foffset){var r=makeRange(start,soffset,finish,foffset),same=eq(start,finish)&&soffset===foffset;return r.collapsed&&!same},getNativeSelection=function(win){return Optional.from(win.getSelection())},doSetNativeRange=function(win,rng){getNativeSelection(win).each((function(selection){selection.removeAllRanges(),selection.addRange(rng)}))},doSetRange=function(win,start,soffset,finish,foffset){var rng=exactToNative(win,start,soffset,finish,foffset);doSetNativeRange(win,rng)},setLegacyRtlRange=function(win,selection,start,soffset,finish,foffset){selection.collapse(start.dom,soffset),selection.extend(finish.dom,foffset)},setRangeFromRelative=function(win,relative){return diagnose(win,relative).match({ltr:function(start,soffset,finish,foffset){doSetRange(win,start,soffset,finish,foffset)},rtl:function(start,soffset,finish,foffset){getNativeSelection(win).each((function(selection){if(selection.setBaseAndExtent)selection.setBaseAndExtent(start.dom,soffset,finish.dom,foffset);else if(selection.extend)try{setLegacyRtlRange(win,selection,start,soffset,finish,foffset)}catch(e){doSetRange(win,finish,foffset,start,soffset)}else doSetRange(win,finish,foffset,start,soffset)}))}})},setExact=function(win,start,soffset,finish,foffset){var relative=preprocessExact(start,soffset,finish,foffset);setRangeFromRelative(win,relative)},readRange=function(selection){if(selection.rangeCount>0){var firstRng=selection.getRangeAt(0),lastRng=selection.getRangeAt(selection.rangeCount-1);return Optional.some(SimRange_create(SugarElement.fromDom(firstRng.startContainer),firstRng.startOffset,SugarElement.fromDom(lastRng.endContainer),lastRng.endOffset))}return Optional.none()},doGetExact=function(selection){if(null===selection.anchorNode||null===selection.focusNode)return readRange(selection);var anchor=SugarElement.fromDom(selection.anchorNode),focus_1=SugarElement.fromDom(selection.focusNode);return after(anchor,selection.anchorOffset,focus_1,selection.focusOffset)?Optional.some(SimRange_create(anchor,selection.anchorOffset,focus_1,selection.focusOffset)):readRange(selection)},getExact=function(win){return getNativeSelection(win).filter((function(sel){return sel.rangeCount>0})).bind(doGetExact)},get=function(win){return getExact(win).map((function(range){return SimSelection.exact(range.start,range.soffset,range.finish,range.foffset)}))},getFirstRect=function(win,selection){var rng=asLtrRange(win,selection);return getFirstRect$1(rng)},clear=function(win){getNativeSelection(win).each((function(selection){return selection.removeAllRanges()}))},getBodyFromFrame=function(frame){return Optional.some(SugarElement.fromDom(frame.dom.contentWindow.document.body))},getDocFromFrame=function(frame){return Optional.some(SugarElement.fromDom(frame.dom.contentWindow.document))},getWinFromFrame=function(frame){return Optional.from(frame.dom.contentWindow)},getSelectionFromFrame=function(frame){var optWin;return getWinFromFrame(frame).bind(getExact)},getFrame=function(editor){return editor.getFrame()},getOrDerive,getOrListen=function(editor,doc,name,type){return editor[name].getOrThunk((function(){return function(handler){return bind(doc,type,handler)}}))},getActiveApi=function(editor){var frame=getFrame(editor),tryFallbackBox=function(win){var isCollapsed=function(sel){return eq(sel.start,sel.finish)&&sel.soffset===sel.foffset},toStartRect=function(sel){var rect=sel.start.dom.getBoundingClientRect();return rect.width>0||rect.height>0?Optional.some(rect):Optional.none()};return getExact(win).filter(isCollapsed).bind(toStartRect)};return getBodyFromFrame(frame).bind((function(body){return getDocFromFrame(frame).bind((function(doc){return getWinFromFrame(frame).map((function(win){var html=SugarElement.fromDom(doc.dom.documentElement),getCursorBox=editor.getCursorBox.getOrThunk((function(){return function(){return get(win).bind((function(sel){return getFirstRect(win,sel).orThunk((function(){return tryFallbackBox(win)}))}))}})),setSelection=editor.setSelection.getOrThunk((function(){return function(start,soffset,finish,foffset){setExact(win,start,soffset,finish,foffset)}})),clearSelection=editor.clearSelection.getOrThunk((function(){return function(){clear(win)}}));return{body:body,doc:doc,win:win,html:html,getSelection:curry(getSelectionFromFrame,frame),setSelection:setSelection,clearSelection:clearSelection,frame:frame,onKeyup:getOrListen(editor,doc,"onKeyup","keyup"),onNodeChanged:getOrListen(editor,doc,"onNodeChanged","SelectionChange"),onDomChanged:editor.onDomChanged,onScrollToCursor:editor.onScrollToCursor,onScrollToElement:editor.onScrollToElement,onToReading:editor.onToReading,onToEditing:editor.onToEditing,onToolbarScrollStart:editor.onToolbarScrollStart,onTouchContent:editor.onTouchContent,onTapContent:editor.onTapContent,onTouchToolstrip:editor.onTouchToolstrip,getCursorBox:getCursorBox}}))}))}))},getWin=function(name,f){return function(editor){var g;return editor[name].getOrThunk((function(){var frame=getFrame(editor);return function(){return f(frame)}}))()}}("getWin",getWinFromFrame),tag=function(){var head=first$1("head").getOrDie(),nu=function(){var meta=SugarElement.fromTag("meta");return set$8(meta,"name","viewport"),append$2(head,meta),meta},element=first$1('meta[name="viewport"]').getOrThunk(nu),backup=get$b(element,"content"),maximize,restore;return{maximize:function(){set$8(element,"content","width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0")},restore:function(){null!=backup&&backup.length>0?set$8(element,"content",backup):set$8(element,"content","user-scalable=yes")}}},attr="data-ephox-mobile-fullscreen-style",siblingStyles="display:none!important;",ancestorPosition="position:absolute!important;",ancestorStyles="top:0!important;left:0!important;margin:0!important;padding:0!important;width:100%!important;height:100%!important;overflow:visible!important;",bgFallback="background-color:rgb(255,255,255)!important;",isAndroid=detect$1().os.isAndroid(),matchColor=function(editorBody){var color=get$8(editorBody,"background-color");return void 0!==color&&""!==color?"background-color:"+color+"!important":bgFallback},clobberStyles=function(container,editorBody){var gatherSiblings=function(element){return siblings(element,"*")},clobber=function(clobberStyle){return function(element){var styles=get$b(element,"style"),backup=void 0===styles?"no-styles":styles.trim();backup!==clobberStyle&&(set$8(element,attr,backup),set$8(element,"style",clobberStyle))}},ancestors$1=ancestors(container,"*"),siblings$1=bind$3(ancestors$1,gatherSiblings),bgColor=matchColor(editorBody),containerStyles;each$1(siblings$1,clobber(siblingStyles)),each$1(ancestors$1,clobber(ancestorPosition+ancestorStyles+bgColor)),clobber((!0===isAndroid?"":ancestorPosition)+ancestorStyles+bgColor)(container)},restoreStyles=function(){var clobberedEls=all("["+attr+"]");each$1(clobberedEls,(function(element){var restore=get$b(element,attr);"no-styles"!==restore?set$8(element,"style",restore):remove$6(element,"style"),remove$6(element,attr)}))},DelayedFunction=function(fun,delay){var ref=null,schedule,cancel;return{cancel:function(){null!==ref&&(clearTimeout(ref),ref=null)},schedule:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];ref=setTimeout((function(){fun.apply(null,args),ref=null}),delay)}}},SIGNIFICANT_MOVE=5,LONGPRESS_DELAY=400,getTouch=function(event){var raw=event.raw;return void 0===raw.touches||1!==raw.touches.length?Optional.none():Optional.some(raw.touches[0])},isFarEnough=function(touch,data){var distX=Math.abs(touch.clientX-data.x),distY=Math.abs(touch.clientY-data.y);return distX>5||distY>5},monitor$1=function(settings){var startData=value(),longpressFired=Cell(!1),longpress$1=DelayedFunction((function(event){settings.triggerEvent(longpress(),event),longpressFired.set(!0)}),400),handleTouchstart=function(event){return getTouch(event).each((function(touch){longpress$1.cancel();var data={x:touch.clientX,y:touch.clientY,target:event.target};longpress$1.schedule(event),longpressFired.set(!1),startData.set(data)})),Optional.none()},handleTouchmove=function(event){return longpress$1.cancel(),getTouch(event).each((function(touch){startData.on((function(data){isFarEnough(touch,data)&&startData.clear()}))})),Optional.none()},handleTouchend=function(event){longpress$1.cancel();var isSame=function(data){return eq(data.target,event.target)};return startData.get().filter(isSame).map((function(_data){return longpressFired.get()?(event.prevent(),!1):settings.triggerEvent(tap(),event)}))},handlers=wrapAll([{key:touchstart(),value:handleTouchstart},{key:touchmove(),value:handleTouchmove},{key:touchend(),value:handleTouchend}]),fireIfReady;return{fireIfReady:function(event,type){return get$c(handlers,type).bind((function(handler){return handler(event)}))}}},monitor=function(editorApi){var tapEvent=monitor$1({triggerEvent:function(type,evt){editorApi.onTapContent(evt)}}),onTouchend,onTouchmove,fireTouchstart;return{fireTouchstart:function(evt){tapEvent.fireIfReady(evt,"touchstart")},onTouchend:function(){return bind(editorApi.body,"touchend",(function(evt){tapEvent.fireIfReady(evt,"touchend")}))},onTouchmove:function(){return bind(editorApi.body,"touchmove",(function(evt){tapEvent.fireIfReady(evt,"touchmove")}))}}},isAndroid6=detect$1().os.version.major>=6,initEvents$1=function(editorApi,toolstrip,alloy){var tapping=monitor(editorApi),outerDoc=owner$2(toolstrip),isRanged=function(sel){return!eq(sel.start,sel.finish)||sel.soffset!==sel.foffset},hasRangeInUi=function(){return active(outerDoc).filter((function(input){return"input"===name$1(input)})).exists((function(input){return input.dom.selectionStart!==input.dom.selectionEnd}))},updateMargin=function(){var rangeInContent=editorApi.doc.dom.hasFocus()&&editorApi.getSelection().exists(isRanged);alloy.getByDom(toolstrip).each(!0===(rangeInContent||hasRangeInUi())?Toggling.on:Toggling.off)},listeners=[bind(editorApi.body,"touchstart",(function(evt){editorApi.onTouchContent(),tapping.fireTouchstart(evt)})),tapping.onTouchmove(),tapping.onTouchend(),bind(toolstrip,"touchstart",(function(_evt){editorApi.onTouchToolstrip()})),editorApi.onToReading((function(){blur$1(editorApi.body)})),editorApi.onToEditing(noop),editorApi.onScrollToCursor((function(tinyEvent){tinyEvent.preventDefault(),editorApi.getCursorBox().each((function(bounds){var cWin=editorApi.win,isOutside,cScrollBy=bounds.top>cWin.innerHeight||bounds.bottom>cWin.innerHeight?bounds.bottom-cWin.innerHeight+50:0;0!==cScrollBy&&cWin.scrollTo(cWin.pageXOffset,cWin.pageYOffset+cScrollBy)}))}))].concat(!0===isAndroid6?[]:[bind(SugarElement.fromDom(editorApi.win),"blur",(function(){alloy.getByDom(toolstrip).each(Toggling.off)})),bind(outerDoc,"select",updateMargin),bind(editorApi.doc,"selectionchange",updateMargin)]),destroy;return{destroy:function(){each$1(listeners,(function(l){l.unbind()}))}}},safeParse=function(element,attribute){var parsed=parseInt(get$b(element,attribute),10);return isNaN(parsed)?0:parsed},COLLAPSED_WIDTH=2,collapsedRect=function(rect){return __assign(__assign({},rect),{width:2})},toRect=function(rawRect){return{left:rawRect.left,top:rawRect.top,right:rawRect.right,bottom:rawRect.bottom,width:rawRect.width,height:rawRect.height}},getRectsFromRange=function(range){if(range.collapsed){var start_1=SugarElement.fromDom(range.startContainer);return parent(start_1).bind((function(parent){var selection=SimSelection.exact(start_1,range.startOffset,parent,getEnd(parent)),optRect;return getFirstRect(range.startContainer.ownerDocument.defaultView,selection).map(collapsedRect).map(pure$2)})).getOr([])}return map$2(range.getClientRects(),toRect)},getRectangles=function(cWin){var sel=cWin.getSelection();return void 0!==sel&&sel.rangeCount>0?getRectsFromRange(sel.getRangeAt(0)):[]},autocompleteHack=function(){return function(f){global$2.setTimeout((function(){f()}),0)}},resume$1=function(cWin){cWin.focus();var iBody=SugarElement.fromDom(cWin.document.body),inInput,transaction;(active().exists((function(elem){return contains$1(["input","textarea"],name$1(elem))}))?autocompleteHack():apply$1)((function(){active().each(blur$1),focus$3(iBody)}))},EXTRA_SPACING=50,data="data-"+resolve("last-outer-height"),setLastHeight=function(cBody,value){set$8(cBody,data,value)},getLastHeight=function(cBody){return safeParse(cBody,data)},getBoundsFrom=function(rect){return{top:rect.top,bottom:rect.top+rect.height}},getBounds=function(cWin){var rects=getRectangles(cWin);return rects.length>0?Optional.some(rects[0]).map(getBoundsFrom):Optional.none()},findDelta=function(outerWindow,cBody){var last=getLastHeight(cBody),current=outerWindow.innerHeight;return last>current?Optional.some(last-current):Optional.none()},calculate=function(cWin,bounds,delta){var isOutside;return bounds.top>cWin.innerHeight||bounds.bottom>cWin.innerHeight?Math.min(delta,bounds.bottom-cWin.innerHeight+50):0},setup$2=function(outerWindow,cWin){var cBody=SugarElement.fromDom(cWin.document.body),toEditing=function(){resume$1(cWin)},onResize=bind(SugarElement.fromDom(outerWindow),"resize",(function(){findDelta(outerWindow,cBody).each((function(delta){getBounds(cWin).each((function(bounds){var cScrollBy=calculate(cWin,bounds,delta);0!==cScrollBy&&cWin.scrollTo(cWin.pageXOffset,cWin.pageYOffset+cScrollBy)}))})),setLastHeight(cBody,outerWindow.innerHeight)})),destroy;return setLastHeight(cBody,outerWindow.innerHeight),{toEditing:toEditing,destroy:function(){onResize.unbind()}}},create$2=function(platform,mask){var meta=tag(),androidApi=api$2(),androidEvents=api$2(),enter,exit;return{enter:function(){mask.hide(),add$1(platform.container,resolve("fullscreen-maximized")),add$1(platform.container,resolve("android-maximized")),meta.maximize(),add$1(platform.body,resolve("android-scroll-reload")),androidApi.set(setup$2(platform.win,getWin(platform.editor).getOrDie("no"))),getActiveApi(platform.editor).each((function(editorApi){clobberStyles(platform.container,editorApi.body),androidEvents.set(initEvents$1(editorApi,platform.toolstrip,platform.alloy))}))},exit:function(){meta.restore(),mask.show(),remove$3(platform.container,resolve("fullscreen-maximized")),remove$3(platform.container,resolve("android-maximized")),restoreStyles(),remove$3(platform.body,resolve("android-scroll-reload")),androidEvents.clear(),androidApi.clear()}}},first=function(fn,rate){var timer=null,cancel,throttle;return{cancel:function(){isNull(timer)||(clearTimeout(timer),timer=null)},throttle:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];isNull(timer)&&(timer=setTimeout((function(){timer=null,fn.apply(null,args)}),rate))}}},last=function(fn,rate){var timer=null,cancel=function(){isNull(timer)||(clearTimeout(timer),timer=null)},throttle=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];cancel(),timer=setTimeout((function(){timer=null,fn.apply(null,args)}),rate)};return{cancel:cancel,throttle:throttle}},sketch=function(onView,_translate){var memIcon=record(Container.sketch({dom:dom$1('<div aria-hidden="true" class="${prefix}-mask-tap-icon"></div>'),containerBehaviours:derive$2([Toggling.config({toggleClass:resolve("mask-tap-icon-selected"),toggleOnExecute:!1})])})),onViewThrottle=first(onView,200);return Container.sketch({dom:dom$1('<div class="${prefix}-disabled-mask"></div>'),components:[Container.sketch({dom:dom$1('<div class="${prefix}-content-container"></div>'),components:[Button.sketch({dom:dom$1('<div class="${prefix}-content-tap-section"></div>'),components:[memIcon.asSpec()],action:function(_button){onViewThrottle.throttle()},buttonBehaviours:derive$2([Toggling.config({toggleClass:resolve("mask-tap-icon-selected")})])})]})]})},unbindNoop=constant$1({unbind:noop}),MobileSchema=objOf([requiredObjOf("editor",[required$1("getFrame"),option("getBody"),option("getDoc"),option("getWin"),option("getSelection"),option("setSelection"),option("clearSelection"),option("cursorSaver"),option("onKeyup"),option("onNodeChanged"),option("getCursorBox"),required$1("onDomChanged"),defaulted("onTouchContent",noop),defaulted("onTapContent",noop),defaulted("onTouchToolstrip",noop),defaulted("onScrollToCursor",unbindNoop),defaulted("onScrollToElement",unbindNoop),defaulted("onToEditing",unbindNoop),defaulted("onToReading",unbindNoop),defaulted("onToolbarScrollStart",identity)]),required$1("socket"),required$1("toolstrip"),required$1("dropup"),required$1("toolbar"),required$1("container"),required$1("alloy"),customField("win",(function(spec){return owner$2(spec.socket).dom.defaultView})),customField("body",(function(spec){return SugarElement.fromDom(spec.socket.dom.ownerDocument.body)})),defaulted("translate",identity),defaulted("setReadOnly",noop),defaulted("readOnlyOnInit",always)]),produce$1=function(raw){var mobile=asRawOrDie$1("Getting AndroidWebapp schema",MobileSchema,raw);set$5(mobile.toolstrip,"width","100%");var onTap,mask=build$1(sketch((function(){mobile.setReadOnly(mobile.readOnlyOnInit()),mode.enter()}),mobile.translate));mobile.alloy.add(mask);var maskApi={show:function(){mobile.alloy.add(mask)},hide:function(){mobile.alloy.remove(mask)}};append$2(mobile.container,mask.element);var mode=create$2(mobile,maskApi);return{setReadOnly:mobile.setReadOnly,refreshStructure:noop,enter:mode.enter,exit:mode.exit,destroy:noop}},schema$1=constant$1([required$1("dom"),defaulted("shell",!0),field$1("toolbarBehaviours",[Replacing])]),enhanceGroups,parts$1=constant$1([optional({name:"groups",overrides:function(){return{behaviours:derive$2([Replacing.config({})])}}})]),factory$1=function(detail,components,_spec,_externals){var setGroups=function(toolbar,groups){getGroupContainer(toolbar).fold((function(){throw console.error("Toolbar was defined to not be a shell, but no groups container was specified in components"),new Error("Toolbar was defined to not be a shell, but no groups container was specified in components")}),(function(container){Replacing.set(container,groups)}))},getGroupContainer=function(component){return detail.shell?Optional.some(component):getPart(component,detail,"groups")},extra=detail.shell?{behaviours:[Replacing.config({})],components:[]}:{behaviours:[],components:components};return{uid:detail.uid,dom:detail.dom,components:extra.components,behaviours:augment(detail.toolbarBehaviours,extra.behaviours),apis:{setGroups:setGroups},domModification:{attributes:{role:"group"}}}},Toolbar=composite({name:"Toolbar",configFields:schema$1(),partFields:parts$1(),factory:factory$1,apis:{setGroups:function(apis,toolbar,groups){apis.setGroups(toolbar,groups)}}}),schema=constant$1([required$1("items"),markers(["itemSelector"]),field$1("tgroupBehaviours",[Keying])]),parts=constant$1([group({name:"items",unit:"item"})]),factory=function(detail,components,_spec,_externals){return{uid:detail.uid,dom:detail.dom,components:components,behaviours:augment(detail.tgroupBehaviours,[Keying.config({mode:"flow",selector:detail.markers.itemSelector})]),domModification:{attributes:{role:"toolbar"}}}},ToolbarGroup=composite({name:"ToolbarGroup",configFields:schema(),partFields:parts(),factory:factory}),dataHorizontal="data-"+resolve("horizontal-scroll"),canScrollVertically=function(container){container.dom.scrollTop=1;var result=0!==container.dom.scrollTop;return container.dom.scrollTop=0,result},canScrollHorizontally=function(container){container.dom.scrollLeft=1;var result=0!==container.dom.scrollLeft;return container.dom.scrollLeft=0,result},hasVerticalScroll=function(container){return container.dom.scrollTop>0||canScrollVertically(container)},hasHorizontalScroll=function(container){return container.dom.scrollLeft>0||canScrollHorizontally(container)},markAsHorizontal=function(container){set$8(container,dataHorizontal,"true")},hasScroll=function(container){return"true"===get$b(container,dataHorizontal)?hasHorizontalScroll(container):hasVerticalScroll(container)},exclusive=function(scope,selector){return bind(scope,"touchmove",(function(event){closest$1(event.target,selector).filter(hasScroll).fold((function(){event.prevent()}),noop)}))},ScrollingToolbar=function(){var makeGroup=function(gSpec){var scrollClass=!0===gSpec.scrollable?"${prefix}-toolbar-scrollable-group":"";return{dom:dom$1('<div aria-label="'+gSpec.label+'" class="${prefix}-toolbar-group '+scrollClass+'"></div>'),tgroupBehaviours:derive$2([config("adhoc-scrollable-toolbar",!0===gSpec.scrollable?[runOnInit((function(component,_simulatedEvent){set$5(component.element,"overflow-x","auto"),markAsHorizontal(component.element),register$2(component.element)}))]:[])]),components:[Container.sketch({components:[ToolbarGroup.parts.items({})]})],markers:{itemSelector:"."+resolve("toolbar-group-item")},items:gSpec.items}},toolbar=build$1(Toolbar.sketch({dom:dom$1('<div class="${prefix}-toolbar"></div>'),components:[Toolbar.parts.groups({})],toolbarBehaviours:derive$2([Toggling.config({toggleClass:resolve("context-toolbar"),toggleOnExecute:!1,aria:{mode:"none"}}),Keying.config({mode:"cyclic"})]),shell:!0})),wrapper=build$1(Container.sketch({dom:{classes:[resolve("toolstrip")]},components:[premade(toolbar)],containerBehaviours:derive$2([Toggling.config({toggleClass:resolve("android-selection-context-toolbar"),toggleOnExecute:!1})])})),resetGroups=function(){Toolbar.setGroups(toolbar,initGroups.get()),Toggling.off(toolbar)},initGroups=Cell([]),setGroups,createGroups,refresh,setContextToolbar,restoreToolbar,focus;return{wrapper:wrapper,toolbar:toolbar,createGroups:function(gs){return map$2(gs,compose(ToolbarGroup.sketch,makeGroup))},setGroups:function(gs){initGroups.set(gs),resetGroups()},setContextToolbar:function(gs){Toggling.on(toolbar),Toolbar.setGroups(toolbar,gs)},restoreToolbar:function(){Toggling.isOn(toolbar)&&resetGroups()},refresh:function(){},focus:function(){Keying.focusIn(toolbar)}}},makeEditSwitch=function(webapp){return build$1(Button.sketch({dom:dom$1('<div class="${prefix}-mask-edit-icon ${prefix}-icon"></div>'),action:function(){webapp.run((function(w){w.setReadOnly(!1)}))}}))},makeSocket=function(){return build$1(Container.sketch({dom:dom$1('<div class="${prefix}-editor-socket"></div>'),components:[],containerBehaviours:derive$2([Replacing.config({})])}))},showEdit=function(socket,switchToEdit){Replacing.append(socket,premade(switchToEdit))},hideEdit=function(socket,switchToEdit){Replacing.remove(socket,switchToEdit)},updateMode=function(socket,switchToEdit,readOnly,root){var swap,f;(!0===readOnly?Swapping.toAlpha:Swapping.toOmega)(root),(readOnly?showEdit:hideEdit)(socket,switchToEdit)},getAnimationRoot=function(component,slideConfig){return slideConfig.getAnimationRoot.fold((function(){return component.element}),(function(get){return get(component)}))},getDimensionProperty=function(slideConfig){return slideConfig.dimension.property},getDimension=function(slideConfig,elem){return slideConfig.dimension.getDimension(elem)},disableTransitions=function(component,slideConfig){var root=getAnimationRoot(component,slideConfig);remove$1(root,[slideConfig.shrinkingClass,slideConfig.growingClass])},setShrunk=function(component,slideConfig){remove$3(component.element,slideConfig.openClass),add$1(component.element,slideConfig.closedClass),set$5(component.element,getDimensionProperty(slideConfig),"0px"),reflow(component.element)},setGrown=function(component,slideConfig){remove$3(component.element,slideConfig.closedClass),add$1(component.element,slideConfig.openClass),remove$2(component.element,getDimensionProperty(slideConfig))},doImmediateShrink=function(component,slideConfig,slideState,_calculatedSize){slideState.setCollapsed(),set$5(component.element,getDimensionProperty(slideConfig),getDimension(slideConfig,component.element)),reflow(component.element),disableTransitions(component,slideConfig),setShrunk(component,slideConfig),slideConfig.onStartShrink(component),slideConfig.onShrunk(component)},doStartShrink=function(component,slideConfig,slideState,calculatedSize){var size=calculatedSize.getOrThunk((function(){return getDimension(slideConfig,component.element)}));slideState.setCollapsed(),set$5(component.element,getDimensionProperty(slideConfig),size),reflow(component.element);var root=getAnimationRoot(component,slideConfig);remove$3(root,slideConfig.growingClass),add$1(root,slideConfig.shrinkingClass),setShrunk(component,slideConfig),slideConfig.onStartShrink(component)},doStartSmartShrink=function(component,slideConfig,slideState){var size=getDimension(slideConfig,component.element),shrinker;("0px"===size?doImmediateShrink:doStartShrink)(component,slideConfig,slideState,Optional.some(size))},doStartGrow=function(component,slideConfig,slideState){var root=getAnimationRoot(component,slideConfig),wasShrinking=has(root,slideConfig.shrinkingClass),beforeSize=getDimension(slideConfig,component.element);setGrown(component,slideConfig);var fullSize=getDimension(slideConfig,component.element),startPartialGrow,startCompleteGrow,setStartSize;(wasShrinking?function(){set$5(component.element,getDimensionProperty(slideConfig),beforeSize),reflow(component.element)}:function(){setShrunk(component,slideConfig)})(),remove$3(root,slideConfig.shrinkingClass),add$1(root,slideConfig.growingClass),setGrown(component,slideConfig),set$5(component.element,getDimensionProperty(slideConfig),fullSize),slideState.setExpanded(),slideConfig.onStartGrow(component)},refresh$1=function(component,slideConfig,slideState){if(slideState.isExpanded()){remove$2(component.element,getDimensionProperty(slideConfig));var fullSize=getDimension(slideConfig,component.element);set$5(component.element,getDimensionProperty(slideConfig),fullSize)}},grow=function(component,slideConfig,slideState){slideState.isExpanded()||doStartGrow(component,slideConfig,slideState)},shrink=function(component,slideConfig,slideState){slideState.isExpanded()&&doStartSmartShrink(component,slideConfig,slideState)},immediateShrink=function(component,slideConfig,slideState){slideState.isExpanded()&&doImmediateShrink(component,slideConfig,slideState)},hasGrown=function(component,slideConfig,slideState){return slideState.isExpanded()},hasShrunk=function(component,slideConfig,slideState){return slideState.isCollapsed()},isGrowing=function(component,slideConfig,_slideState){var root=getAnimationRoot(component,slideConfig);return!0===has(root,slideConfig.growingClass)},isShrinking=function(component,slideConfig,_slideState){var root=getAnimationRoot(component,slideConfig);return!0===has(root,slideConfig.shrinkingClass)},isTransitioning=function(component,slideConfig,slideState){return isGrowing(component,slideConfig)||isShrinking(component,slideConfig)},toggleGrow=function(component,slideConfig,slideState){var f;(slideState.isExpanded()?doStartSmartShrink:doStartGrow)(component,slideConfig,slideState)},SlidingApis=Object.freeze({__proto__:null,refresh:refresh$1,grow:grow,shrink:shrink,immediateShrink:immediateShrink,hasGrown:hasGrown,hasShrunk:hasShrunk,isGrowing:isGrowing,isShrinking:isShrinking,isTransitioning:isTransitioning,toggleGrow:toggleGrow,disableTransitions:disableTransitions}),exhibit=function(base,slideConfig,_slideState){var expanded=slideConfig.expanded;return nu$3(expanded?{classes:[slideConfig.openClass],styles:{}}:{classes:[slideConfig.closedClass],styles:wrap(slideConfig.dimension.property,"0px")})},events=function(slideConfig,slideState){return derive$3([runOnSource(transitionend(),(function(component,simulatedEvent){var raw,notify;simulatedEvent.event.raw.propertyName===slideConfig.dimension.property&&(disableTransitions(component,slideConfig),slideState.isExpanded()&&remove$2(component.element,slideConfig.dimension.property),(slideState.isExpanded()?slideConfig.onGrown:slideConfig.onShrunk)(component))}))])},ActiveSliding=Object.freeze({__proto__:null,exhibit:exhibit,events:events}),SlidingSchema=[required$1("closedClass"),required$1("openClass"),required$1("shrinkingClass"),required$1("growingClass"),option("getAnimationRoot"),onHandler("onShrunk"),onHandler("onStartShrink"),onHandler("onGrown"),onHandler("onStartGrow"),defaulted("expanded",!1),requiredOf("dimension",choose$1("property",{width:[output("property","width"),output("getDimension",(function(elem){return get$5(elem)+"px"}))],height:[output("property","height"),output("getDimension",(function(elem){return get$7(elem)+"px"}))]}))],init$1=function(spec){var state=Cell(spec.expanded),readState=function(){return"expanded: "+state.get()};return nu$2({isExpanded:function(){return!0===state.get()},isCollapsed:function(){return!1===state.get()},setCollapsed:curry(state.set,!1),setExpanded:curry(state.set,!0),readState:readState})},SlidingState,Sliding=create$5({fields:SlidingSchema,name:"sliding",active:ActiveSliding,apis:SlidingApis,state:Object.freeze({__proto__:null,init:init$1})}),build=function(refresh,scrollIntoView){var dropup=build$1(Container.sketch({dom:{tag:"div",classes:[resolve("dropup")]},components:[],containerBehaviours:derive$2([Replacing.config({}),Sliding.config({closedClass:resolve("dropup-closed"),openClass:resolve("dropup-open"),shrinkingClass:resolve("dropup-shrinking"),growingClass:resolve("dropup-growing"),dimension:{property:"height"},onShrunk:function(component){refresh(),scrollIntoView(),Replacing.set(component,[])},onGrown:function(_component){refresh(),scrollIntoView()}}),orientation((function(_component,_data){disappear(noop)}))])})),appear,disappear=function(onReadyToShrink){window.requestAnimationFrame((function(){onReadyToShrink(),Sliding.shrink(dropup)}))};return{appear:function(menu,update,component){!0===Sliding.hasShrunk(dropup)&&!1===Sliding.isTransitioning(dropup)&&window.requestAnimationFrame((function(){update(component),Replacing.set(dropup,[menu()]),Sliding.grow(dropup)}))},disappear:disappear,component:dropup,element:dropup.element}},closest=function(scope,selector,isRoot){return closest$1(scope,selector,isRoot).isSome()},isDangerous=function(event){var keyEv;return event.raw.which===BACKSPACE[0]&&!contains$1(["input","textarea"],name$1(event.target))&&!closest(event.target,'[contenteditable="true"]')},isFirefox=function(){return detect$1().browser.isFirefox()},bindFocus=function(container,handler){return isFirefox()?capture(container,"focus",handler):bind(container,"focusin",handler)},bindBlur=function(container,handler){return isFirefox()?capture(container,"blur",handler):bind(container,"focusout",handler)},setup$1=function(container,rawSettings){var settings=__assign({stopBackspace:!0},rawSettings),pointerEvents=["touchstart","touchmove","touchend","touchcancel","gesturestart","mousedown","mouseup","mouseover","mousemove","mouseout","click"],tapEvent=monitor$1(settings),simpleEvents=map$2(pointerEvents.concat(["selectstart","input","contextmenu","change","transitionend","transitioncancel","drag","dragstart","dragend","dragenter","dragleave","dragover","drop","keyup"]),(function(type){return bind(container,type,(function(event){var stopped;tapEvent.fireIfReady(event,type).each((function(tapStopped){tapStopped&&event.kill()})),settings.triggerEvent(type,event)&&event.kill()}))})),pasteTimeout=value(),onPaste=bind(container,"paste",(function(event){var stopped;tapEvent.fireIfReady(event,"paste").each((function(tapStopped){tapStopped&&event.kill()})),settings.triggerEvent("paste",event)&&event.kill(),pasteTimeout.set(setTimeout((function(){settings.triggerEvent(postPaste(),event)}),0))})),onKeydown=bind(container,"keydown",(function(event){var stopped;settings.triggerEvent("keydown",event)?event.kill():settings.stopBackspace&&isDangerous(event)&&event.prevent()})),onFocusIn=bindFocus(container,(function(event){var stopped;settings.triggerEvent("focusin",event)&&event.kill()})),focusoutTimeout=value(),onFocusOut=bindBlur(container,(function(event){var stopped;settings.triggerEvent("focusout",event)&&event.kill(),focusoutTimeout.set(setTimeout((function(){settings.triggerEvent(postBlur(),event)}),0))})),unbind;return{unbind:function(){each$1(simpleEvents,(function(e){e.unbind()})),onKeydown.unbind(),onFocusIn.unbind(),onFocusOut.unbind(),onPaste.unbind(),pasteTimeout.on(clearTimeout),focusoutTimeout.on(clearTimeout)}}},derive$1=function(rawEvent,rawTarget){var source=get$c(rawEvent,"target").getOr(rawTarget);return Cell(source)},fromSource=function(event,source){var stopper=Cell(!1),cutter=Cell(!1),stop,cut;return{stop:function(){stopper.set(!0)},cut:function(){cutter.set(!0)},isStopped:stopper.get,isCut:cutter.get,event:event,setSource:source.set,getSource:source.get}},fromExternal=function(event){var stopper=Cell(!1),stop;return{stop:function(){stopper.set(!0)},cut:noop,isStopped:stopper.get,isCut:never,event:event,setSource:die("Cannot set source of a broadcasted event"),getSource:die("Cannot get source of a broadcasted event")}},adt=Adt_generate([{stopped:[]},{resume:["element"]},{complete:[]}]),doTriggerHandler=function(lookup,eventType,rawEvent,target,source,logger){var handler=lookup(eventType,target),simulatedEvent=fromSource(rawEvent,source);return handler.fold((function(){return logger.logEventNoHandlers(eventType,target),adt.complete()}),(function(handlerInfo){var descHandler=handlerInfo.descHandler,eventHandler;return getCurried(descHandler)(simulatedEvent),simulatedEvent.isStopped()?(logger.logEventStopped(eventType,handlerInfo.element,descHandler.purpose),adt.stopped()):simulatedEvent.isCut()?(logger.logEventCut(eventType,handlerInfo.element,descHandler.purpose),adt.complete()):parent(handlerInfo.element).fold((function(){return logger.logNoParent(eventType,handlerInfo.element,descHandler.purpose),adt.complete()}),(function(parent){return logger.logEventResponse(eventType,handlerInfo.element,descHandler.purpose),adt.resume(parent)}))}))},doTriggerOnUntilStopped=function(lookup,eventType,rawEvent,rawTarget,source,logger){return doTriggerHandler(lookup,eventType,rawEvent,rawTarget,source,logger).fold(always,(function(parent){return doTriggerOnUntilStopped(lookup,eventType,rawEvent,parent,source,logger)}),never)},triggerHandler=function(lookup,eventType,rawEvent,target,logger){var source=derive$1(rawEvent,target);return doTriggerHandler(lookup,eventType,rawEvent,target,source,logger)},broadcast=function(listeners,rawEvent,_logger){var simulatedEvent=fromExternal(rawEvent);return each$1(listeners,(function(listener){var descHandler=listener.descHandler,handler;getCurried(descHandler)(simulatedEvent)})),simulatedEvent.isStopped()},triggerUntilStopped=function(lookup,eventType,rawEvent,logger){return triggerOnUntilStopped(lookup,eventType,rawEvent,rawEvent.target,logger)},triggerOnUntilStopped=function(lookup,eventType,rawEvent,rawTarget,logger){var source=derive$1(rawEvent,rawTarget);return doTriggerOnUntilStopped(lookup,eventType,rawEvent,rawTarget,source,logger)},eventHandler=function(element,descHandler){return{element:element,descHandler:descHandler}},broadcastHandler=function(id,handler){return{id:id,descHandler:handler}},EventRegistry=function(){var registry={},registerId,findHandler=function(handlers,elem){return read(elem).bind((function(id){return get$c(handlers,id)})).map((function(descHandler){return eventHandler(elem,descHandler)}))},filterByType,find,unregisterId;return{registerId:function(extraArgs,id,events){each(events,(function(v,k){var handlers=void 0!==registry[k]?registry[k]:{};handlers[id]=curryArgs(v,extraArgs),registry[k]=handlers}))},unregisterId:function(id){each(registry,(function(handlersById,_eventName){has$2(handlersById,id)&&delete handlersById[id]}))},filterByType:function(type){return get$c(registry,type).map((function(handlers){return mapToArray(handlers,(function(f,id){return broadcastHandler(id,f)}))})).getOr([])},find:function(isAboveRoot,type,target){return get$c(registry,type).bind((function(handlers){return closest$3(target,(function(elem){return findHandler(handlers,elem)}),isAboveRoot)}))}}},Registry=function(){var events=EventRegistry(),components={},readOrTag=function(component){var elem=component.element;return read(elem).getOrThunk((function(){return write("uid-",component.element)}))},failOnDuplicate=function(component,tagId){var conflict=components[tagId];if(conflict!==component)throw new Error('The tagId "'+tagId+'" is already used by: '+element(conflict.element)+"\nCannot use it for: "+element(component.element)+"\nThe conflicting element is"+(inBody(conflict.element)?" ":" not ")+"already in the DOM");unregister(component)},register,unregister=function(component){read(component.element).each((function(tagId){delete components[tagId],events.unregisterId(tagId)}))},filter,find,getById;return{find:function(isAboveRoot,type,target){return events.find(isAboveRoot,type,target)},filter:function(type){return events.filterByType(type)},register:function(component){var tagId=readOrTag(component);hasNonNullableKey(components,tagId)&&failOnDuplicate(component,tagId);var extraArgs=[component];events.registerId(extraArgs,tagId,component.events),components[tagId]=component},unregister:unregister,getById:function(id){return get$c(components,id)}}},takeover$1=function(root){var isAboveRoot=function(el){return parent(root.element).fold(always,(function(parent){return eq(el,parent)}))},registry=Registry(),lookup=function(eventName,target){return registry.find(isAboveRoot,eventName,target)},domEvents=setup$1(root.element,{triggerEvent:function(eventName,event){return monitorEvent(eventName,event.target,(function(logger){return triggerUntilStopped(lookup,eventName,event,logger)}))}}),systemApi={debugInfo:constant$1("real"),triggerEvent:function(eventName,target,data){monitorEvent(eventName,target,(function(logger){return triggerOnUntilStopped(lookup,eventName,data,target,logger)}))},triggerFocus:function(target,originator){read(target).fold((function(){focus$3(target)}),(function(_alloyId){monitorEvent(focus$4(),target,(function(logger){return triggerHandler(lookup,focus$4(),{originator:originator,kill:noop,prevent:noop,target:target},target,logger),!1}))}))},triggerEscape:function(comp,simulatedEvent){systemApi.triggerEvent("keydown",comp.element,simulatedEvent.event)},getByUid:function(uid){return getByUid(uid)},getByDom:function(elem){return getByDom(elem)},build:build$1,addToGui:function(c){add(c)},removeFromGui:function(c){remove(c)},addToWorld:function(c){addToWorld(c)},removeFromWorld:function(c){removeFromWorld(c)},broadcast:function(message){broadcast$1(message)},broadcastOn:function(channels,message){broadcastOn(channels,message)},broadcastEvent:function(eventName,event){broadcastEvent(eventName,event)},isConnected:always},addToWorld=function(component){component.connect(systemApi),isText(component.element)||(registry.register(component),each$1(component.components(),addToWorld),systemApi.triggerEvent(systemInit(),component.element,{target:component.element}))},removeFromWorld=function(component){isText(component.element)||(each$1(component.components(),removeFromWorld),registry.unregister(component)),component.disconnect()},add=function(component){attach(root,component)},remove=function(component){detach(component)},destroy=function(){domEvents.unbind(),remove$7(root.element)},broadcastData=function(data){var receivers=registry.filter(receive$1());each$1(receivers,(function(receiver){var descHandler=receiver.descHandler,handler;getCurried(descHandler)(data)}))},broadcast$1=function(message){broadcastData({universal:!0,data:message})},broadcastOn=function(channels,message){broadcastData({universal:!1,channels:channels,data:message})},broadcastEvent=function(eventName,event){var listeners=registry.filter(eventName);return broadcast(listeners,event)},getByUid=function(uid){return registry.getById(uid).fold((function(){return Result.error(new Error('Could not find component with uid: "'+uid+'" in system.'))}),Result.value)},getByDom=function(elem){var uid=read(elem).getOr("not found");return getByUid(uid)};return addToWorld(root),{root:root,element:root.element,destroy:destroy,add:add,remove:remove,getByUid:getByUid,getByDom:getByDom,addToWorld:addToWorld,removeFromWorld:removeFromWorld,broadcast:broadcast$1,broadcastOn:broadcastOn,broadcastEvent:broadcastEvent}},READ_ONLY_MODE_CLASS=resolve("readonly-mode"),EDIT_MODE_CLASS=resolve("edit-mode");function OuterContainer(spec){var root=build$1(Container.sketch({dom:{classes:[resolve("outer-container")].concat(spec.classes)},containerBehaviours:derive$2([Swapping.config({alpha:READ_ONLY_MODE_CLASS,omega:EDIT_MODE_CLASS})])}));return takeover$1(root)}function AndroidRealm(scrollIntoView){var alloy=OuterContainer({classes:[resolve("android-container")]}),toolbar=ScrollingToolbar(),webapp=api$2(),switchToEdit=makeEditSwitch(webapp),socket=makeSocket(),dropup=build(noop,scrollIntoView);alloy.add(toolbar.wrapper),alloy.add(socket),alloy.add(dropup.component);var setToolbarGroups=function(rawGroups){var groups=toolbar.createGroups(rawGroups);toolbar.setGroups(groups)},setContextToolbar=function(rawGroups){var groups=toolbar.createGroups(rawGroups);toolbar.setContextToolbar(groups)},focusToolbar=function(){toolbar.focus()},restoreToolbar=function(){toolbar.restoreToolbar()},init=function(spec){webapp.set(produce$1(spec))},exit=function(){webapp.run((function(w){w.exit(),Replacing.remove(socket,switchToEdit)}))},updateMode$1=function(readOnly){updateMode(socket,switchToEdit,readOnly,alloy.root)};return{system:alloy,element:alloy.element,init:init,exit:exit,setToolbarGroups:setToolbarGroups,setContextToolbar:setContextToolbar,focusToolbar:focusToolbar,restoreToolbar:restoreToolbar,updateMode:updateMode$1,socket:socket,dropup:dropup}}var input=function(parent,operation){var input=SugarElement.fromTag("input");setAll(input,{opacity:"0",position:"absolute",top:"-1000px",left:"-1000px"}),append$2(parent,input),focus$3(input),operation(input),remove$7(input)},refresh=function(winScope){var sel=winScope.getSelection();if(sel.rangeCount>0){var br=sel.getRangeAt(0),r=winScope.document.createRange();r.setStart(br.startContainer,br.startOffset),r.setEnd(br.endContainer,br.endOffset),sel.removeAllRanges(),sel.addRange(r)}},resume=function(cWin,frame){active().each((function(active){eq(active,frame)||blur$1(active)})),cWin.focus(),focus$3(SugarElement.fromDom(cWin.document.body)),refresh(cWin)},stubborn=function(outerBody,cWin,page,frame){var toEditing=function(){resume(cWin,frame)},toReading=function(){input(outerBody,blur$1)},captureInput=bind(page,"keydown",(function(evt){contains$1(["input","textarea"],name$1(evt.target))||toEditing()})),onToolbarTouch,destroy;return{toReading:toReading,toEditing:toEditing,onToolbarTouch:noop,destroy:function(){captureInput.unbind()}}},initEvents=function(editorApi,iosApi,toolstrip,socket,_dropup){var saveSelectionFirst=function(){iosApi.run((function(api){api.highlightSelection()}))},refreshIosSelection=function(){iosApi.run((function(api){api.refreshSelection()}))},scrollToY=function(yTop,height){var y=yTop-socket.dom.scrollTop;iosApi.run((function(api){api.scrollIntoView(y,y+height)}))},scrollToElement=function(_target){scrollToY(iosApi,socket)},scrollToCursor=function(){editorApi.getCursorBox().each((function(box){scrollToY(box.top,box.height)}))},clearSelection=function(){iosApi.run((function(api){api.clearSelection()}))},clearAndRefresh=function(){clearSelection(),refreshThrottle.throttle()},refreshView=function(){scrollToCursor(),iosApi.run((function(api){api.syncHeight()}))},reposition=function(){var toolbarHeight=get$7(toolstrip);iosApi.run((function(api){api.setViewportOffset(toolbarHeight)})),refreshIosSelection(),refreshView()},toEditing=function(){iosApi.run((function(api){api.toEditing()}))},toReading=function(){iosApi.run((function(api){api.toReading()}))},onToolbarTouch=function(event){iosApi.run((function(api){api.onToolbarTouch(event)}))},tapping=monitor(editorApi),refreshThrottle=last(refreshView,300),listeners=[editorApi.onKeyup(clearAndRefresh),editorApi.onNodeChanged(refreshIosSelection),editorApi.onDomChanged(refreshThrottle.throttle),editorApi.onDomChanged(refreshIosSelection),editorApi.onScrollToCursor((function(tinyEvent){tinyEvent.preventDefault(),refreshThrottle.throttle()})),editorApi.onScrollToElement((function(event){scrollToElement(event.element)})),editorApi.onToEditing(toEditing),editorApi.onToReading(toReading),bind(editorApi.doc,"touchend",(function(touchEvent){eq(editorApi.html,touchEvent.target)||eq(editorApi.body,touchEvent.target)})),bind(toolstrip,"transitionend",(function(transitionEvent){"height"===transitionEvent.raw.propertyName&&reposition()})),capture(toolstrip,"touchstart",(function(touchEvent){saveSelectionFirst(),onToolbarTouch(touchEvent),editorApi.onTouchToolstrip()})),bind(editorApi.body,"touchstart",(function(evt){clearSelection(),editorApi.onTouchContent(),tapping.fireTouchstart(evt)})),tapping.onTouchmove(),tapping.onTouchend(),bind(editorApi.body,"click",(function(event){event.kill()})),bind(toolstrip,"touchmove",(function(){editorApi.onToolbarScrollStart()}))],destroy;return{destroy:function(){each$1(listeners,(function(l){l.unbind()}))}}};function FakeSelection(win,frame){var doc=win.document,container=SugarElement.fromTag("div");add$1(container,resolve("unfocused-selections")),append$2(SugarElement.fromDom(doc.documentElement),container);var onTouch=bind(container,"touchstart",(function(event){event.prevent(),resume(win,frame),clear()})),make=function(rectangle){var span=SugarElement.fromTag("span");return add(span,[resolve("layer-editor"),resolve("unfocused-selection")]),setAll(span,{left:rectangle.left+"px",top:rectangle.top+"px",width:rectangle.width+"px",height:rectangle.height+"px"}),span},update=function(){clear();var rectangles=getRectangles(win),spans=map$2(rectangles,make);append$1(container,spans)},clear=function(){empty(container)},destroy,isActive;return{update:update,isActive:function(){return children(container).length>0},destroy:function(){onTouch.unbind(),remove$7(container)},clear:clear}}var nu$1=function(baseFn){var data=Optional.none(),callbacks=[],map=function(f){return nu$1((function(nCallback){get((function(data){nCallback(f(data))}))}))},get=function(nCallback){isReady()?call(nCallback):callbacks.push(nCallback)},set=function(x){isReady()||(data=Optional.some(x),run(callbacks),callbacks=[])},isReady=function(){return data.isSome()},run=function(cbs){each$1(cbs,call)},call=function(cb){data.each((function(x){setTimeout((function(){cb(x)}),0)}))};return baseFn(set),{get:get,map:map,isReady:isReady}},pure$1=function(a){return nu$1((function(callback){callback(a)}))},LazyValue={nu:nu$1,pure:pure$1},errorReporter=function(err){setTimeout((function(){throw err}),0)},make=function(run){var get=function(callback){run().then(callback,errorReporter)},map,bind,anonBind,toLazy,toCached,toPromise;return{map:function(fab){return make((function(){return run().then(fab)}))},bind:function(aFutureB){return make((function(){return run().then((function(v){return aFutureB(v).toPromise()}))}))},anonBind:function(futureB){return make((function(){return run().then((function(){return futureB.toPromise()}))}))},toLazy:function(){return LazyValue.nu(get)},toCached:function(){var cache=null;return make((function(){return null===cache&&(cache=run()),cache}))},toPromise:run,get:get}},nu,pure,Future_nu=function(baseFn){return make((function(){return new Promise$1(baseFn)}))},Future_pure=function(a){return make((function(){return Promise$1.resolve(a)}))},adjust=function(value,destination,amount){return Math.abs(value-destination)<=amount?Optional.none():value<destination?Optional.some(value+amount):Optional.some(value-amount)},create$1=function(){var interval=null,animate;return{animate:function(getCurrent,destination,amount,increment,doFinish,rate){var finished=!1,finish=function(v){finished=!0,doFinish(v)};global$2.clearInterval(interval);var abort=function(v){global$2.clearInterval(interval),finish(v)};interval=global$2.setInterval((function(){var value=getCurrent();adjust(value,destination,amount).fold((function(){global$2.clearInterval(interval),finish(destination)}),(function(s){if(increment(s,abort),!finished){var newValue=getCurrent();(newValue!==s||Math.abs(newValue-destination)>Math.abs(value-destination))&&(global$2.clearInterval(interval),finish(destination))}}))}),rate)}}},findDevice=function(deviceWidth,deviceHeight){var devices;return findMap([{width:320,height:480,keyboard:{portrait:300,landscape:240}},{width:320,height:568,keyboard:{portrait:300,landscape:240}},{width:375,height:667,keyboard:{portrait:305,landscape:240}},{width:414,height:736,keyboard:{portrait:320,landscape:240}},{width:768,height:1024,keyboard:{portrait:320,landscape:400}},{width:1024,height:1366,keyboard:{portrait:380,landscape:460}}],(function(device){return someIf(deviceWidth<=device.width&&deviceHeight<=device.height,device.keyboard)})).getOr({portrait:deviceHeight/5,landscape:deviceWidth/4})},softKeyboardLimits=function(outerWindow){return findDevice(outerWindow.screen.width,outerWindow.screen.height)},accountableKeyboardHeight=function(outerWindow){var portrait=get$1(outerWindow).isPortrait(),limits=softKeyboardLimits(outerWindow),keyboard=portrait?limits.portrait:limits.landscape,visualScreenHeight;return(portrait?outerWindow.screen.height:outerWindow.screen.width)-outerWindow.innerHeight>keyboard?0:keyboard},getGreenzone=function(socket,dropup){var outerWindow=owner$2(socket).dom.defaultView,viewportHeight,acc;return get$7(socket)+get$7(dropup)-accountableKeyboardHeight(outerWindow)},updatePadding=function(contentBody,socket,dropup){var greenzoneHeight=getGreenzone(socket,dropup),deltaHeight=get$7(socket)+get$7(dropup)-greenzoneHeight;set$5(contentBody,"padding-bottom",deltaHeight+"px")},fixture=Adt_generate([{fixed:["element","property","offsetY"]},{scroller:["element","offsetY"]}]),yFixedData="data-"+resolve("position-y-fixed"),yFixedProperty="data-"+resolve("y-property"),yScrollingData="data-"+resolve("scrolling"),windowSizeData="data-"+resolve("last-window-height"),getYFixedData=function(element){return safeParse(element,yFixedData)},getYFixedProperty=function(element){return get$b(element,yFixedProperty)},getLastWindowSize=function(element){return safeParse(element,windowSizeData)},classifyFixed=function(element,offsetY){var prop=getYFixedProperty(element);return fixture.fixed(element,prop,offsetY)},classifyScrolling=function(element,offsetY){return fixture.scroller(element,offsetY)},classify=function(element){var offsetY=getYFixedData(element),classifier;return("true"===get$b(element,yScrollingData)?classifyScrolling:classifyFixed)(element,offsetY)},findFixtures=function(container){var candidates=descendants(container,"["+yFixedData+"]");return map$2(candidates,classify)},takeoverToolbar=function(toolbar){var oldToolbarStyle=get$b(toolbar,"style"),restore;return setAll(toolbar,{position:"absolute",top:"0px"}),set$8(toolbar,yFixedData,"0px"),set$8(toolbar,yFixedProperty,"top"),{restore:function(){set$8(toolbar,"style",oldToolbarStyle||""),remove$6(toolbar,yFixedData),remove$6(toolbar,yFixedProperty)}}},takeoverViewport=function(toolbarHeight,height,viewport){var oldViewportStyle=get$b(viewport,"style"),restore;return register$2(viewport),setAll(viewport,{position:"absolute",height:height+"px",width:"100%",top:toolbarHeight+"px"}),set$8(viewport,yFixedData,toolbarHeight+"px"),set$8(viewport,yScrollingData,"true"),set$8(viewport,yFixedProperty,"top"),{restore:function(){deregister(viewport),set$8(viewport,"style",oldViewportStyle||""),remove$6(viewport,yFixedData),remove$6(viewport,yScrollingData),remove$6(viewport,yFixedProperty)}}},takeoverDropup=function(dropup){var oldDropupStyle=get$b(dropup,"style"),restore;return setAll(dropup,{position:"absolute",bottom:"0px"}),set$8(dropup,yFixedData,"0px"),set$8(dropup,yFixedProperty,"bottom"),{restore:function(){set$8(dropup,"style",oldDropupStyle||""),remove$6(dropup,yFixedData),remove$6(dropup,yFixedProperty)}}},deriveViewportHeight=function(viewport,toolbarHeight,dropupHeight){var outerWindow,winH=owner$2(viewport).dom.defaultView.innerHeight;return set$8(viewport,windowSizeData,winH+"px"),winH-toolbarHeight-dropupHeight},takeover=function(viewport,contentBody,toolbar,dropup){var outerWindow=owner$2(viewport).dom.defaultView,toolbarSetup=takeoverToolbar(toolbar),toolbarHeight=get$7(toolbar),dropupHeight=get$7(dropup),viewportHeight=deriveViewportHeight(viewport,toolbarHeight,dropupHeight),viewportSetup=takeoverViewport(toolbarHeight,viewportHeight,viewport),dropupSetup=takeoverDropup(dropup),isActive=!0,restore=function(){isActive=!1,toolbarSetup.restore(),viewportSetup.restore(),dropupSetup.restore()},isExpanding=function(){var currentWinHeight,lastWinHeight;return outerWindow.innerHeight>getLastWindowSize(viewport)},refresh=function(){if(isActive){var newToolbarHeight=get$7(toolbar),dropupHeight_1=get$7(dropup),newHeight=deriveViewportHeight(viewport,newToolbarHeight,dropupHeight_1);set$8(viewport,yFixedData,newToolbarHeight+"px"),set$5(viewport,"height",newHeight+"px"),updatePadding(contentBody,viewport,dropup)}},setViewportOffset=function(newYOffset){var offsetPx;set$8(viewport,yFixedData,newYOffset+"px"),refresh()};return updatePadding(contentBody,viewport,dropup),{setViewportOffset:setViewportOffset,isExpanding:isExpanding,isShrinking:not(isExpanding),refresh:refresh,restore:restore}},animator=create$1(),ANIMATION_STEP=15,NUM_TOP_ANIMATION_FRAMES=10,ANIMATION_RATE=10,lastScroll="data-"+resolve("last-scroll-top"),getTop=function(element){var raw=getRaw(element,"top").getOr("0");return parseInt(raw,10)},getScrollTop=function(element){return parseInt(element.dom.scrollTop,10)},moveScrollAndTop=function(element,destination,finalTop){return Future_nu((function(callback){var getCurrent=curry(getScrollTop,element),update=function(newScroll){element.dom.scrollTop=newScroll,set$5(element,"top",getTop(element)+15+"px")},finish=function(){element.dom.scrollTop=destination,set$5(element,"top",finalTop+"px"),callback(destination)};animator.animate(getCurrent,destination,15,update,finish,10)}))},moveOnlyScroll=function(element,destination){return Future_nu((function(callback){var getCurrent=curry(getScrollTop,element);set$8(element,lastScroll,getCurrent());var update=function(newScroll,abort){var previous;safeParse(element,lastScroll)!==element.dom.scrollTop?abort(element.dom.scrollTop):(element.dom.scrollTop=newScroll,set$8(element,lastScroll,newScroll))},finish=function(){element.dom.scrollTop=destination,set$8(element,lastScroll,destination),callback(destination)},distance=Math.abs(destination-getCurrent()),step=Math.ceil(distance/10);animator.animate(getCurrent,destination,step,update,finish,10)}))},moveOnlyTop=function(element,destination){return Future_nu((function(callback){var getCurrent=curry(getTop,element),update=function(newTop){set$5(element,"top",newTop+"px")},finish=function(){update(destination),callback(destination)},distance=Math.abs(destination-getCurrent()),step=Math.ceil(distance/10);animator.animate(getCurrent,destination,step,update,finish,10)}))},updateTop=function(element,amount){var newTop=amount+getYFixedData(element)+"px";set$5(element,"top",newTop)},moveWindowScroll=function(toolbar,viewport,destY){var outerWindow=owner$2(toolbar).dom.defaultView;return Future_nu((function(callback){updateTop(toolbar,destY),updateTop(viewport,destY),outerWindow.scrollTo(0,destY),callback(destY)}))};function BackgroundActivity(doAction){var action=Cell(LazyValue.pure({})),start,idle;return{start:function(value){var future=LazyValue.nu((function(callback){return doAction(value).get(callback)}));action.set(future)},idle:function(g){action.get().get((function(){g()}))}}}var scrollIntoView=function(cWin,socket,dropup,top,bottom){var greenzone=getGreenzone(socket,dropup),refreshCursor=curry(refresh,cWin);top>greenzone||bottom>greenzone?moveOnlyScroll(socket,socket.dom.scrollTop-greenzone+bottom).get(refreshCursor):top<0&&moveOnlyScroll(socket,socket.dom.scrollTop+top).get(refreshCursor)},par$1=function(asyncValues,nu){return nu((function(callback){var r=[],count=0,cb=function(i){return function(value){r[i]=value,++count>=asyncValues.length&&callback(r)}};0===asyncValues.length?callback([]):each$1(asyncValues,(function(asyncValue,i){asyncValue.get(cb(i))}))}))},par=function(futures){return par$1(futures,Future_nu)},updateFixed=function(element,property,winY,offsetY){var destination;return set$5(element,property,winY+offsetY+"px"),Future_pure(offsetY)},updateScrollingFixed=function(element,winY,offsetY){var destTop=winY+offsetY,oldProp=getRaw(element,"top").getOr(offsetY),delta=destTop-parseInt(oldProp,10),destScroll=element.dom.scrollTop+delta;return moveScrollAndTop(element,destScroll,destTop)},updateFixture=function(fixture,winY){return fixture.fold((function(element,property,offsetY){return updateFixed(element,property,winY,offsetY)}),(function(element,offsetY){return updateScrollingFixed(element,winY,offsetY)}))},updatePositions=function(container,winY){var fixtures=findFixtures(container),updates=map$2(fixtures,(function(fixture){return updateFixture(fixture,winY)}));return par(updates)},VIEW_MARGIN=5,register=function(toolstrip,socket,container,outerWindow,structure,cWin){var scroller=BackgroundActivity((function(y){return moveWindowScroll(toolstrip,socket,y)})),scrollBounds=function(){var rects=getRectangles(cWin);return Optional.from(rects[0]).bind((function(rect){var viewTop=rect.top-socket.dom.scrollTop,outside;return viewTop>outerWindow.innerHeight+5||viewTop<-5?Optional.some({top:viewTop,bottom:viewTop+rect.height}):Optional.none()}))},scrollThrottle=last((function(){scroller.idle((function(){updatePositions(container,outerWindow.pageYOffset).get((function(){var extraScroll;scrollBounds().each((function(extra){socket.dom.scrollTop=socket.dom.scrollTop+extra.top})),scroller.start(0),structure.refresh()}))}))}),1e3),onScroll=bind(SugarElement.fromDom(outerWindow),"scroll",(function(){outerWindow.pageYOffset<0||scrollThrottle.throttle()}));return updatePositions(container,outerWindow.pageYOffset).get(identity),{unbind:onScroll.unbind}},setup=function(bag){var cWin=bag.cWin,ceBody=bag.ceBody,socket=bag.socket,toolstrip=bag.toolstrip,contentElement=bag.contentElement,keyboardType=bag.keyboardType,outerWindow=bag.outerWindow,dropup=bag.dropup,outerBody=bag.outerBody,structure=takeover(socket,ceBody,toolstrip,dropup),keyboardModel=keyboardType(outerBody,cWin,body(),contentElement),toEditing=function(){keyboardModel.toEditing(),clearSelection()},toReading=function(){keyboardModel.toReading()},onToolbarTouch=function(_event){keyboardModel.onToolbarTouch()},onOrientation=onChange(outerWindow,{onChange:noop,onReady:structure.refresh});onOrientation.onAdjustment((function(){structure.refresh()}));var onResize=bind(SugarElement.fromDom(outerWindow),"resize",(function(){structure.isExpanding()&&structure.refresh()})),onScroll=register(toolstrip,socket,outerBody,outerWindow,structure,cWin),unfocusedSelection=FakeSelection(cWin,contentElement),refreshSelection,highlightSelection,clearSelection=function(){unfocusedSelection.clear()},scrollIntoView$1,syncHeight,setViewportOffset,destroy=function(){structure.restore(),onOrientation.destroy(),onScroll.unbind(),onResize.unbind(),keyboardModel.destroy(),unfocusedSelection.destroy(),input(body(),blur$1)};return{toEditing:toEditing,toReading:toReading,onToolbarTouch:onToolbarTouch,refreshSelection:function(){unfocusedSelection.isActive()&&unfocusedSelection.update()},clearSelection:clearSelection,highlightSelection:function(){unfocusedSelection.update()},scrollIntoView:function(top,bottom){scrollIntoView(cWin,socket,dropup,top,bottom)},updateToolbarPadding:noop,setViewportOffset:function(newYOffset){structure.setViewportOffset(newYOffset),moveOnlyTop(socket,newYOffset).get(identity)},syncHeight:function(){set$5(contentElement,"height",contentElement.dom.contentWindow.document.body.scrollHeight+"px")},refreshStructure:structure.refresh,destroy:destroy}},create=function(platform,mask){var meta=tag(),priorState=value(),scrollEvents=value(),iosApi=api$2(),iosEvents=api$2(),enter,exit,refreshStructure;return{enter:function(){mask.hide();var doc=SugarElement.fromDom(document);getActiveApi(platform.editor).each((function(editorApi){priorState.set({socketHeight:getRaw(platform.socket,"height"),iframeHeight:getRaw(editorApi.frame,"height"),outerScroll:document.body.scrollTop}),scrollEvents.set({exclusives:exclusive(doc,"."+scrollable)}),add$1(platform.container,resolve("fullscreen-maximized")),clobberStyles(platform.container,editorApi.body),meta.maximize(),set$5(platform.socket,"overflow","scroll"),set$5(platform.socket,"-webkit-overflow-scrolling","touch"),focus$3(editorApi.body),iosApi.set(setup({cWin:editorApi.win,ceBody:editorApi.body,socket:platform.socket,toolstrip:platform.toolstrip,dropup:platform.dropup.element,contentElement:editorApi.frame,outerBody:platform.body,outerWindow:platform.win,keyboardType:stubborn})),iosApi.run((function(api){api.syncHeight()})),iosEvents.set(initEvents(editorApi,iosApi,platform.toolstrip,platform.socket,platform.dropup))}))},refreshStructure:function(){iosApi.run((function(api){api.refreshStructure()}))},exit:function(){meta.restore(),iosEvents.clear(),iosApi.clear(),mask.show(),priorState.on((function(s){s.socketHeight.each((function(h){set$5(platform.socket,"height",h)})),s.iframeHeight.each((function(h){set$5(platform.editor.getFrame(),"height",h)})),document.body.scrollTop=s.scrollTop})),priorState.clear(),scrollEvents.on((function(s){s.exclusives.unbind()})),scrollEvents.clear(),remove$3(platform.container,resolve("fullscreen-maximized")),restoreStyles(),deregister(platform.toolbar),remove$2(platform.socket,"overflow"),remove$2(platform.socket,"-webkit-overflow-scrolling"),blur$1(platform.editor.getFrame()),getActiveApi(platform.editor).each((function(editorApi){editorApi.clearSelection()}))}}},produce=function(raw){var mobile=asRawOrDie$1("Getting IosWebapp schema",MobileSchema,raw);set$5(mobile.toolstrip,"width","100%"),set$5(mobile.container,"position","relative");var onView,mask=build$1(sketch((function(){mobile.setReadOnly(mobile.readOnlyOnInit()),mode.enter()}),mobile.translate));mobile.alloy.add(mask);var maskApi={show:function(){mobile.alloy.add(mask)},hide:function(){mobile.alloy.remove(mask)}},mode=create(mobile,maskApi);return{setReadOnly:mobile.setReadOnly,refreshStructure:mode.refreshStructure,enter:mode.enter,exit:mode.exit,destroy:noop}};function IosRealm(scrollIntoView){var alloy=OuterContainer({classes:[resolve("ios-container")]}),toolbar=ScrollingToolbar(),webapp=api$2(),switchToEdit=makeEditSwitch(webapp),socket=makeSocket(),dropup=build((function(){webapp.run((function(w){w.refreshStructure()}))}),scrollIntoView);alloy.add(toolbar.wrapper),alloy.add(socket),alloy.add(dropup.component);var setToolbarGroups=function(rawGroups){var groups=toolbar.createGroups(rawGroups);toolbar.setGroups(groups)},setContextToolbar=function(rawGroups){var groups=toolbar.createGroups(rawGroups);toolbar.setContextToolbar(groups)},focusToolbar=function(){toolbar.focus()},restoreToolbar=function(){toolbar.restoreToolbar()},init=function(spec){webapp.set(produce(spec))},exit=function(){webapp.run((function(w){Replacing.remove(socket,switchToEdit),w.exit()}))},updateMode$1=function(readOnly){updateMode(socket,switchToEdit,readOnly,alloy.root)};return{system:alloy,element:alloy.element,init:init,exit:exit,setToolbarGroups:setToolbarGroups,setContextToolbar:setContextToolbar,focusToolbar:focusToolbar,restoreToolbar:restoreToolbar,updateMode:updateMode$1,socket:socket,dropup:dropup}}var global$1=tinymce.util.Tools.resolve("tinymce.EditorManager"),derive=function(editor){var base=Optional.from(getSkinUrl(editor)).getOrThunk((function(){return global$1.baseURL+"/skins/ui/oxide"}));return{content:base+"/content.mobile.min.css",ui:base+"/skin.mobile.min.css"}},fireChange=function(realm,command,state){realm.system.broadcastOn([formatChanged],{command:command,state:state})},init=function(realm,editor){var allFormats=keys(editor.formatter.get());each$1(allFormats,(function(command){editor.formatter.formatChanged(command,(function(state){fireChange(realm,command,state)}))})),each$1(["ul","ol"],(function(command){editor.selection.selectorChanged(command,(function(state,_data){fireChange(realm,command,state)}))}))},fireSkinLoaded=function(editor){return function(){var done=function(){editor._skinLoaded=!0,editor.fire("SkinLoaded")};editor.initialized?done():editor.on("init",done)}},READING="toReading",EDITING="toEditing",renderMobileTheme=function(editor){var renderUI;return{getNotificationManagerImpl:function(){return{open:constant$1({progressBar:{value:noop},close:noop,text:noop,getEl:constant$1(null),moveTo:noop,moveRel:noop,settings:{}}),close:noop,reposition:noop,getArgs:constant$1({})}},renderUI:function(){var targetNode=editor.getElement(),cssUrls=derive(editor);if(!1===isSkinDisabled(editor)){var styleSheetLoader_1=global$5.DOM.styleSheetLoader;editor.contentCSS.push(cssUrls.content),styleSheetLoader_1.load(cssUrls.ui,fireSkinLoaded(editor)),editor.on("remove",(function(){return styleSheetLoader_1.unload(cssUrls.ui)}))}else fireSkinLoaded(editor)();var doScrollIntoView=function(){editor.fire("ScrollIntoView")},realm=detect$1().os.isAndroid()?AndroidRealm(doScrollIntoView):IosRealm(doScrollIntoView),original=SugarElement.fromDom(targetNode);attachSystemAfter(original,realm.system);var findFocusIn=function(elem){return search(elem).bind((function(focused){return realm.system.getByDom(focused).toOptional()}))},outerWindow=targetNode.ownerDocument.defaultView,orientation=onChange(outerWindow,{onChange:function(){var alloy;realm.system.broadcastOn([orientationChanged],{width:getActualWidth(outerWindow)})},onReady:noop}),setReadOnly=function(dynamicGroup,readOnlyGroups,mainGroups,ro){!1===ro&&editor.selection.collapse();var toolbars=configureToolbar(dynamicGroup,readOnlyGroups,mainGroups);realm.setToolbarGroups(!0===ro?toolbars.readOnly:toolbars.main),editor.setMode(!0===ro?"readonly":"design"),editor.fire(!0===ro?READING:EDITING),realm.updateMode(ro)},configureToolbar=function(dynamicGroup,readOnlyGroups,mainGroups){var dynamic=dynamicGroup.get(),toolbars;return{readOnly:dynamic.backToMask.concat(readOnlyGroups.get()),main:dynamic.backToMask.concat(mainGroups.get())}},bindHandler=function(label,handler){return editor.on(label,handler),{unbind:function(){editor.off(label)}}};return editor.on("init",(function(){realm.init({editor:{getFrame:function(){return SugarElement.fromDom(editor.contentAreaContainer.querySelector("iframe"))},onDomChanged:function(){return{unbind:noop}},onToReading:function(handler){return bindHandler(READING,handler)},onToEditing:function(handler){return bindHandler(EDITING,handler)},onScrollToCursor:function(handler){var unbind;return editor.on("ScrollIntoView",(function(tinyEvent){handler(tinyEvent)})),{unbind:function(){editor.off("ScrollIntoView"),orientation.destroy()}}},onTouchToolstrip:function(){hideDropup()},onTouchContent:function(){var toolbar=SugarElement.fromDom(editor.editorContainer.querySelector("."+resolve("toolbar")));findFocusIn(toolbar).each(emitExecute),realm.restoreToolbar(),hideDropup()},onTapContent:function(evt){var target=evt.target;if("img"===name$1(target))editor.selection.select(target.dom),evt.kill();else if("a"===name$1(target)){var component;realm.system.getByDom(SugarElement.fromDom(editor.editorContainer)).each((function(container){Swapping.isAlpha(container)&&openLink(target.dom)}))}}},container:SugarElement.fromDom(editor.editorContainer),socket:SugarElement.fromDom(editor.contentAreaContainer),toolstrip:SugarElement.fromDom(editor.editorContainer.querySelector("."+resolve("toolstrip"))),toolbar:SugarElement.fromDom(editor.editorContainer.querySelector("."+resolve("toolbar"))),dropup:realm.dropup,alloy:realm.system,translate:noop,setReadOnly:function(ro){setReadOnly(dynamicGroup,readOnlyGroups,mainGroups,ro)},readOnlyOnInit:function(){return!1}});var hideDropup=function(){realm.dropup.disappear((function(){realm.system.broadcastOn([dropupDismissed],{})}))},backToMaskGroup={label:"The first group",scrollable:!1,items:[forToolbar("back",(function(){editor.selection.collapse(),realm.exit()}),{},editor)]},backToReadOnlyGroup={label:"Back to read only",scrollable:!1,items:[forToolbar("readonly-back",(function(){setReadOnly(dynamicGroup,readOnlyGroups,mainGroups,!0)}),{},editor)]},readOnlyGroup={label:"The read only mode group",scrollable:!0,items:[]},features=setup$3(realm,editor),items=detect(editor,features),actionGroup,extraGroup={label:"The extra group",scrollable:!1,items:[]},mainGroups=Cell([{label:"the action group",scrollable:!0,items:items},extraGroup]),readOnlyGroups=Cell([readOnlyGroup,extraGroup]),dynamicGroup=Cell({backToMask:[backToMaskGroup],backToReadOnly:[backToReadOnlyGroup]});init(realm,editor)})),editor.on("remove",(function(){realm.exit()})),editor.on("detach",(function(){detachSystem(realm.system),realm.system.destroy()})),{iframeContainer:realm.socket.element.dom,editorContainer:realm.element.dom}}}};function Theme(){global$4.add("mobile",renderMobileTheme)}Theme()}();